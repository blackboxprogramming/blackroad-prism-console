# BlackRoad Prism Console Hardening & Backup Sprint

This playbook adapts the quick hardening + backup checklist to the current BlackRoad stack:

- **Identity surface:** Google Workspace admin mailbox, Okta SSO, GitHub organization `BlackRoadOrg`, DigitalOcean droplet fleet (NYC3 + FRA1), AWS preview environments, and the "BlackRoad Vault" 1Password tenants.
- **Workloads to protect:** `/srv/blackroad-api` (Express API + SQLite), `/var/www/blackroad` (SPA), `/etc/nginx` + systemd unit files, `/srv/blackroad-backups` (local snapshots), and DigitalOcean Spaces buckets (`blackroad-backups`, `blackroad-artifacts`).
- **Support tooling already in repo:** `ops/backup/restic_setup.sh`, `ops/backup/backup.timer`, `ops/scripts/test-restore.sh`, and the MinIO-compatible restic configuration.

Treat this as a one-afternoon sprint: you can work top-to-bottom and end with a signed checklist and a verified restore.

---

## 1. Lock down sign-ins (passkeys + 2FA)

**Goal:** Remove easy account takeover paths for production and billing systems.

### Priority order

| Order | Account / Surface | Actions |
| --- | --- | --- |
| 1 | **Google Workspace super-admin** (currently used for root email + Okta bootstrap) | Add two platform-supported passkeys (e.g., Mac Touch ID + YubiKey), confirm 2-Step Verification enforcement, download recovery codes to paper, enable Admin console sign-in alerts. |
| 2 | **GitHub – `BlackRoadOrg`** (source, Actions secrets, deploy keys) | Settings → Password and authentication → Passkeys → Add (use the same two authenticators). Verify organization-wide “Require 2FA” is still enabled, rotate recovery codes, and store them in the 1Password "Security" vault + an offline printout. |
| 3 | **Cloud consoles & billing** – DigitalOcean (Spaces + droplets), AWS (preview env), Cloudflare (edge), Stripe/Brex (billing) | For each portal: add WebAuthn passkeys, keep TOTP in Aegis/1Password as backup, remove SMS fallback. DigitalOcean: Security → Passkeys, then regenerate recovery codes. AWS: IAM Identity Center & root user → enable security key MFA + passkeys, disable email-only MFA, and store the root access key in sealed envelope. Stripe/Brex: enable hardware key MFA and spending alerts. |
| 4 | **1Password – BlackRoad Vault** | Ensure account owners have passkeys and hardware key recovery, print Emergency Kit, store copy with Operations lead, and rotate account password to a 40+ char diceware phrase. |
| 5 | **Okta tenant (`id.blackroadinc.us`)** | Enforce WebAuthn as primary + TOTP backup for Super Admins, review break-glass account (hardware key only, offline recovery codes), and trigger a "new sign-in" notification test. |

### Implementation notes

- **Preparation:**
  - Schedule 30 minutes of shared time with whoever holds hardware keys so both passkeys can be registered everywhere.
  - Open `ops/okta-sso-runbook.md` for reference while updating Okta + GitHub SSO linkage.
  - Create an entry in the "Security" 1Password vault named `2025-10 hardening sprint` to store recovery codes, timestamps, and hardware key serials.

- **During enrollment:**
  - Register passkeys on two different physical devices (MacBook + iPhone, Surface + Android, etc.) to avoid a single point of failure.
  - When a service still requires a password, replace it with a password generated by 1Password (length ≥ 30, letters + numbers) and copy the new value into the associated vault item.
  - After each account, trigger whatever "send me a security alert" feature exists (Google Alert Center, GitHub account security emails, DigitalOcean sign-in notifications) to confirm signals reach `security@blackroad.io`.

- **Break-glass mailbox:**
  - Provision a Proton Mail address dedicated to incidents (e.g., `blackroad-breakglass@proton.me`).
  - Add two hardware security keys and print both Proton recovery codes.
  - Store its credentials and codes in a tamper-evident envelope placed with physical disaster-recovery materials.

- **Housekeeping sweep:** Remove legacy SMS numbers, stale API tokens, and deprecated recovery methods discovered during setup. Document deletions in the sprint log.

---

## 2. Backups that actually restore (3-2-1 rule)

**Goal:** Guarantee you can recover `blackroad-prism-console` workloads after ransomware, hardware loss, or operator error.

### 2.1 Map the data

| Tier | Path / System | Notes |
| --- | --- | --- |
| Live | `/srv/blackroad-api` | Node.js service + `.env`, `package.json`, SQLite database (`blackroad.db`). |
| Live | `/var/www/blackroad` | Built SPA assets served by NGINX. |
| Live | `/etc/nginx`, `/etc/systemd/system/blackroad-*.service` | Config needed to rehydrate hosts. |
| Local backup | `/srv/blackroad-backups` | Current snapshot scripts already write here; keep as first backup medium. |
| Object storage | DigitalOcean Spaces `blackroad-backups` | Off-site, S3-compatible target for restic. |
| Optional second off-site | AWS S3 `blackroad-prism-dr` (if budget allows) | Mirror from Spaces weekly for additional isolation. |

### 2.2 Configure restic against Spaces

1. **Install restic and dependencies (Ubuntu 22.04 droplet baseline):**
   ```bash
   sudo apt-get update && sudo apt-get install -y restic gnupg
   ```
2. **Create `/etc/restic.env` (mode 600) with Spaces credentials:**
   ```bash
   sudo tee /etc/restic.env >/dev/null <<'EOV'
   export RESTIC_REPOSITORY="s3:https://nyc3.digitaloceanspaces.com/blackroad-backups"
   export AWS_ACCESS_KEY_ID="${DO_SPACES_KEY}"
   export AWS_SECRET_ACCESS_KEY="${DO_SPACES_SECRET}"
   export RESTIC_PASSWORD="${RESTIC_PASSWORD}" # 20+ random chars, store offline
   export RESTIC_PROGRESS_FPS=0
   EOV
   sudo chmod 600 /etc/restic.env
   ```
   - Generate credentials in the DigitalOcean control panel with read/write access **only** to `blackroad-backups`.
   - Store the key ID, secret, and passphrase in 1Password and an offline envelope.
3. **Initialise the repository:**
   ```bash
   sudo -u backup . /etc/restic.env && restic init
   ```
   (Replace `backup` with whichever service account executes backups; by default run as `root`.)
4. **Update the backup unit:** Point `ops/backup/restic.env` to source `/etc/restic.env` or replace its placeholders so `backup.timer` pushes to Spaces as well as the existing MinIO target. The repository copy of `restic.env` no longer ships static credentials—populate the variables at deploy time via your secret manager or an OIDC exchange job. Example combined command in `ops/backup/backup.service`:
   ```bash
   ExecStart=/bin/bash -c '. /etc/restic.env && restic backup /srv/blackroad-api /var/www/blackroad /etc/nginx /etc/systemd/system/blackroad-* /srv/blackroad-backups --tag daily'
   ```
5. **Retention + pruning:**
   ```bash
   sudo -u backup . /etc/restic.env && \
   restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
   ```
6. **Cron (if systemd not available):** Add to `/etc/cron.d/restic-blackroad`:
   ```
   0 3 * * * root . /etc/restic.env && restic backup /srv/blackroad-api /var/www/blackroad /etc/nginx /etc/systemd/system/blackroad-* /srv/blackroad-backups --tag daily && restic forget --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --prune
   ```

### 2.3 Bucket policy quick win

Apply a restrictive bucket policy so only the backup droplet can write objects:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowBackupHost",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::digitalocean:access-key/${DO_SPACES_KEY}"},
      "Action": ["s3:PutObject", "s3:DeleteObject", "s3:ListBucket"],
      "Resource": [
        "arn:aws:s3:::blackroad-backups",
        "arn:aws:s3:::blackroad-backups/*"
      ],
      "Condition": {
        "IpAddress": {"aws:SourceIp": "${BACKUP_DROPLET_PUBLIC_IP}/32"}
      }
    }
  ]
}
```

### 2.4 Verify + drill

1. **Nightly verification:** Append `restic check` after backups twice per week (e.g., Tuesday & Friday runs) to catch corruption early.
2. **Monthly restore drill (non-negotiable):**
   - `sudo mkdir -p /tmp/restore-test`
   - `sudo . /etc/restic.env && restic restore latest --target /tmp/restore-test`
   - Open `restore-test/srv/blackroad-api/package.json` and confirm dependencies look current.
   - Capture screenshot / logs, file under `backups/restore-log/YYYY-MM-DD.md`.
3. **Cross-verify local snapshots:** Ensure `/srv/blackroad-backups/.last_snapshot` timestamp updates daily. If it stalls, alert the on-call engineer.
4. **Key escrow:** Print the RESTIC_PASSWORD and Spaces credentials, seal them with evidence tape, and log location in the asset register.

---

## 3. Billing + finance hygiene

- **DigitalOcean:** Enable billing alerts (`Settings → Billing → Notifications`) for spend > $500/month, tie to `finance@blackroad.io`, and forward alerts into the Finance Slack channel.
- **AWS:** Create a Budget with 80%/90%/100% email + webhook notifications (webhook can call Opsgenie). Require passkeys on the payer account.
- **Stripe & Brex:**
  - Enable WebAuthn MFA for all admins.
  - Configure daily and single-transaction spend alerts delivered to the shared `treasury@blackroad.io` mailbox and Finance Slack.
  - Reconcile alerts with accounting weekly; document in `docs/TREASURY.md` if thresholds change.
- **Credit cards & banks:** Wherever supported (e.g., Mercury, Brex), enable push notifications for new charges and log acknowledgements in the treasury runbook.

---

## 4. Minimal incident checklist (print + pin)

1. **Lost laptop/phone:**
   - Immediately revoke sessions via Google Workspace, Okta, GitHub, and 1Password.
   - Remove device from passkey lists, rotate PATs/SSH keys, and trigger `ops/scripts/test-restore.sh` to confirm backups untouched.
   - Rebuild the workstation using `/srv/blackroad-backups` or restic restore.
2. **Phishy login page spotted:**
   - From a known-good device, change the affected password, re-enroll passkeys, rotate recovery codes, and review recent sign-ins/audit logs.
   - Notify #security, attach screenshots, and add the domain to the blocklist.
3. **Backup failure or bad restore:**
   - Stop all cron/systemd backup jobs.
   - Fix the issue (credentials, disk space, bucket policy) immediately.
   - Re-run `restic backup` followed by full restore test before marking the incident resolved.

Keep a laminated copy with the break-glass materials; update annually.

---

## 5. Tracking & evidence

- Log completion in the Security ops journal (Notion or `security/hardening-log.md`). Include:
  - Date, operator, accounts updated, hardware keys used.
  - Recovery code storage location and witness.
  - Backup repository ID (from `restic snapshots`).
- File monthly restore drill reports under `backups/restore-log/`.
- During quarterly audits, export:
  - Google Workspace 2SV enforcement report.
  - GitHub organization 2FA compliance report (`github.com/orgs/BlackRoadOrg/people?query=2fa%3Adisabled`).
  - Restic `check` output for the past quarter.

Completing every box above brings the environment in line with the 3-2-1 standard, ensures sign-ins resist phishing, and proves backups restore when you need them most.
