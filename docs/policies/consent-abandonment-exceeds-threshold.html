<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Consent abandonment exceeds threshold</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 32px; color: #1f2933; }
    h1 { margin-bottom: 0.25em; }
    h2 { margin-top: 2.5em; }
    pre { background: #f5f7fa; padding: 12px 16px; border-radius: 6px; overflow-x: auto; }
    code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', monospace; font-size: 0.95em; }
    table { border-collapse: collapse; margin-top: 1em; }
    th, td { padding: 6px 12px; border-bottom: 1px solid #e5e9f0; text-align: left; }
    ul { padding-left: 20px; }
  </style>
</head>
<body>
  <h1>Consent abandonment exceeds threshold</h1>
  <p>Alerts when the fraction of consent escalations that are not resolved (no allow within 24h) exceeds 25% on a rolling 7-day window.</p>
  <table>
    <tr><th>Rule ID</th><td>CONSENT_ABANDONMENT_RATE-5a4f3a2a-6f9e-4d3e-a0b7-48c2c11e70de</td></tr>
    <tr><th>Category</th><td>observe</td></tr>
    <tr><th>Severity</th><td>Med</td></tr>
    <tr><th>Owners</th><td>@platform-eng, @secops</td></tr>
    <tr><th>Notify</th><td>slack:#platform</td></tr>
    <tr><th>On match</th><td>Decision: notify<br/>Reason: consent_abandonment_spike</td></tr>
  </table>

  <h2>Expression</h2>
  <pre><code>rate(consent_abandonment(), &quot;168h&quot;) &gt; 0.25
</code></pre>

  <h2>Metrics selectors</h2>
  <h3>Prometheus</h3>
  <pre><code>(
  increase(consent_escalations_started_total[{{window}}])
  -
  increase(consent_escalations_resolved_total[{{window}}])
)
/
clamp_min(increase(consent_escalations_started_total[{{window}}]), 1)</code></pre>
  <h3>ClickHouse</h3>
  <pre><code>WITH started AS (
  SELECT correlation_id, min(ts) AS started_at
  FROM audit_events
  WHERE ts &gt;= now() - INTERVAL {{window}} AND outcome=&#x27;deny&#x27; AND deny_reason=&#x27;consent_required&#x27;
  GROUP BY correlation_id
),
resolved AS (
  SELECT a.correlation_id
  FROM audit_events a
  INNER JOIN started s USING (correlation_id)
  WHERE a.outcome=&#x27;allow&#x27; AND a.ts BETWEEN s.started_at AND s.started_at + INTERVAL 24 HOUR
  GROUP BY a.correlation_id
)
SELECT
  (count() - countIf(correlation_id IN resolved)) / nullIf(count(), 0)
FROM started</code></pre>

  
<h2>Live trend</h2>
<div id="rule-chart" style="height:240px;max-width:720px;border:1px solid #e0e0e0;border-radius:6px;overflow:hidden;"></div>
<script>
(function(){
  const endpoint = "/metrics/consent_abandonment_rate";
  const title = "Consent Abandonment (7d)";
  const el = document.getElementById('rule-chart');
  if (!el || !endpoint) return;
  fetch(endpoint).then(res => res.json()).then(data => {
    const points = Array.isArray(data.points) ? data.points : [];
    const w = el.clientWidth || 640;
    const h = 240;
    if (points.length === 0) {
      el.innerHTML = '<div style="padding:16px;color:#666;font-size:14px;">No data available for the selected window.</div>';
      return;
    }
    const xs = points.map(p => p.t);
    const ys = points.map(p => p.v);
    const x0 = Math.min(...xs);
    const x1 = Math.max(...xs);
    const toX = x => ((x - x0) / ((x1 - x0) || 1)) * (w - 2) + 1;
    const toY = y => h - ((y - 0) / (1 || 1)) * (h - 2) - 1;
    let d = 'M' + toX(xs[0]) + ',' + toY(ys[0]);
    for (let i = 1; i < xs.length; i++) {
      d += ' L' + toX(xs[i]) + ',' + toY(ys[i]);
    }
    const rightLabelX = Math.max(w - 48, 8);
    el.innerHTML = '<svg width="' + w + '" height="' + h + '" viewBox="0 0 ' + w + ' ' + h + '"><rect width="' + w + '" height="' + h + '" fill="white" stroke="#ddd"/><path d="' + d + '" fill="none" stroke="#1f77b4" stroke-width="2"/><text x="8" y="18" font-size="12" fill="#333">' + title + '</text><text x="' + rightLabelX + '" y="18" font-size="12" fill="#333">ratio</text></svg>';
  }).catch(() => {
    el.innerHTML = '<div style="padding:16px;color:#b94a48;font-size:14px;">Unable to load live metrics.</div>';
  });
})();
</script>

</body>
</html>
