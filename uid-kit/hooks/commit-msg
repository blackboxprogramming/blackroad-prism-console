#!/usr/bin/env bash
set -euo pipefail

COMMIT_MSG_FILE="$1"
REPO_ROOT="$(git rev-parse --show-toplevel)"
LOCK_FILE="$REPO_ROOT/uid.lock"

if [[ ! -f "$LOCK_FILE" ]]; then
  exit 0
fi

uid="$(<"$LOCK_FILE")"
uid="${uid//[$'\r\n\t ']}"

if [[ -z "$uid" ]]; then
  echo "uid.lock is present but empty; either remove the file or add the active UID." >&2
  exit 1
fi

if ! grep -qE "^UID: $uid$" "$COMMIT_MSG_FILE"; then
  echo "Commit message must include 'UID: $uid' as a standalone footer line." >&2
  exit 1
fi
