version: '3.9'
services:
  glow:
    profiles: ['amd64']
    build:
      context: .
      dockerfile: Dockerfile.amd64
    image: blackroad/glow-agent:amd64
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MODEL_DIR=/opt/blackroad/models/glow
      - DATA_DIR=/opt/blackroad/data
      - LOG_DIR=/opt/blackroad/logs
      - LUCIDIA_BUS=/opt/blackroad/bus/codex_bus.jsonl
    volumes:
      - /opt/blackroad/models/glow:/opt/blackroad/models/glow
      - /opt/blackroad/data:/opt/blackroad/data
      - /opt/blackroad/logs:/opt/blackroad/logs
      - /opt/blackroad/bus:/opt/blackroad/bus
    ports: ['8018:8018']
    command: ['uvicorn', 'glow_agent.app:app', '--host', '0.0.0.0', '--port', '8018']

  glow-jetson:
    profiles: ['jetson']
    build:
      context: .
      dockerfile: Dockerfile.jetson
    image: blackroad/glow-agent:jetson
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - MODEL_DIR=/opt/blackroad/models/glow
      - DATA_DIR=/opt/blackroad/data
      - LOG_DIR=/opt/blackroad/logs
      - LUCIDIA_BUS=/opt/blackroad/bus/codex_bus.jsonl
    volumes:
      - /opt/blackroad/models/glow:/opt/blackroad/models/glow
      - /opt/blackroad/data:/opt/blackroad/data
      - /opt/blackroad/logs:/opt/blackroad/logs
      - /opt/blackroad/bus:/opt/blackroad/bus
    ports: ['8018:8018']
    command: ['uvicorn', 'glow_agent.app:app', '--host', '0.0.0.0', '--port', '8018']
