# Client CA store
ssl_client_certificate /etc/nginx/client_ca/ca.crt;
ssl_verify_depth 2;

# Per-location mTLS + rate limit zone (define zone in http{} too)
location ^~ /api/relay/partner/ {
  # require a valid client certificate for this path
  ssl_verify_client on;
  # quick reject if not verified
  if ($ssl_client_verify != SUCCESS) { return 403; }

  # rate limit to protect backend (60 req/min, burst 10)
  limit_req zone=partner_zone burst=10 nodelay;

  # forward verification metadata to app (for auditing)
  proxy_set_header X-Client-Verify $ssl_client_verify;
  proxy_set_header X-Client-DN     $ssl_client_s_dn;
  proxy_set_header X-Client-CN     $ssl_client_s_dn_cn;

  proxy_set_header Host $host;
  proxy_pass http://127.0.0.1:4000;
}
