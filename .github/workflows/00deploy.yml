name: Deploy to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: SSH to droplet and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: root
          key: ${{ secrets.DROPLET_SSH_KEY }}
          script: |
            cd /root/blackroad-prism-console
            git pull origin main || true
            docker stop nginx llm || true
            docker rm nginx llm || true

            docker run -d --name llm -p 8000:8000 blackroad-prism-console-llm
            cat > /root/nginx.conf <<'EOF'
            server {
                listen 80;
                server_name blackroad.io blackroadinc.us;

                location / {
                    proxy_pass http://172.17.0.1:8000;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            EOF
            docker run -d --name nginx -p 80:80 -v /root/nginx.conf:/etc/nginx/conf.d/default.conf:ro nginx:alpine
