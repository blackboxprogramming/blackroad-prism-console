name: Uptime Ping
on:
  schedule: [{ cron: '*/10 * * * *' }] # every 10 minutes
  workflow_dispatch:
permissions: { contents: read, issues: write }
jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Hit health endpoints
        id: ping
        run: |
          URL="${{ vars.BLACKROAD_URL || 'https://blackroad.io' }}"
          set +e
          curl -fsS "$URL/" -o /dev/null; A=$?
          curl -fsS "$URL/status" -o /dev/null; B=$?
          if [ $A -ne 0 ] || [ $B -ne 0 ]; then
            echo "down=true" >> $GITHUB_OUTPUT
          else
            echo "down=false" >> $GITHUB_OUTPUT
          fi
      - name: Open/append incident
        if: steps.ping.outputs.down == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title='ðŸš¨ Uptime: blackroad.io is DOWN';
            const query=`repo:${context.repo.owner}/${context.repo.repo} in:title "${title}" state:open`;
            const {data:{items}} = await github.search.issuesAndPullRequests({ q: query });
            const body=`Automated ping failed at ${new Date().toISOString()}\nURL: ${process.env.URL || 'https://blackroad.io'}`;
            if (items.length) {
              await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: items[0].number, body});
            } else {
              await github.issues.create({owner: context.repo.owner, repo: context.repo.repo, title, body, labels:['incident','uptime']});
            }
