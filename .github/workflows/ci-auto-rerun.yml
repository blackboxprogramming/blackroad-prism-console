name: "ğŸ” Auto Rerun Failing CI"

on:
  workflow_run:
    workflows:
      - "ğŸŸ¢ Node CI â€“ 20"
      - "ğŸ Python CI â€“ 3.12"
    types: [completed]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.id }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  rerun:
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.run_attempt < 3 &&
      !contains(github.event.workflow_run.head_commit.message, '[no-rerun]')
    runs-on: ubuntu-latest
    steps:
      - name: Check for no-rerun label
        id: guard
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.workflow_run.pull_requests?.[0];
            if (!pr) {
              core.setOutput('skip', 'false');
              return;
            }
            const { data: labels } = await github.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            const skip = labels.some((label) => label.name.toLowerCase() === 'no-rerun');
            core.setOutput('skip', skip ? 'true' : 'false');
      - name: Trigger rerun
        if: steps.guard.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.actions.reRunWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
