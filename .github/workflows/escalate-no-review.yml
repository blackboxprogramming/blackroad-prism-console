name: Escalate stale PRs
on:
  schedule:
    - cron: "0 * * * *"   # hourly
  workflow_dispatch: {}

permissions:
    - cron: "0 * * * *" # hourly
  workflow_dispatch: {}

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  escalate:
    runs-on: ubuntu-latest
    steps:
      - name: Find open PRs updated >24h ago with no reviews
      - name: Find open PRs updated >24h ago
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo
            const pulls = await github.paginate(github.rest.pulls.list, {owner, repo, state:"open", per_page:100})
            const horizon = Date.now() - 24*60*60*1000  // adjust SLA if you want
            for (const pr of pulls) {
              if (pr.draft) continue
              if (new Date(pr.updated_at).getTime() > horizon) continue

              const reviews = await github.rest.pulls.listReviews({owner, repo, pull_number: pr.number, per_page: 1})
              if (reviews.data.length) continue

            const since = new Date(Date.now() - 24*60*60*1000).toISOString()
            const {data: pulls} = await github.rest.pulls.list({owner, repo, state:"open", per_page:100})
            for (const pr of pulls) {
              if (new Date(pr.updated_at) > new Date(since)) continue
              // skip drafts
              if (pr.draft) continue

              // has any review? skip if so
              const {data: reviews} = await github.rest.pulls.listReviews({owner, repo, pull_number: pr.number, per_page: 1})
              if (reviews.length) continue

              // comment or update existing escalation comment
              const marker = "(Escalation: no review in 24h)"
              const {data: comments} = await github.rest.issues.listComments({owner, repo, issue_number: pr.number, per_page:100})
              const mine = comments.find(c => c.user?.type==="Bot" && c.body?.includes(marker))
              const body = `Heads up: escalating for visibility ${marker}`
              if (mine) {
                await github.rest.issues.updateComment({owner, repo, comment_id: mine.id, body})
              } else {
                await github.rest.issues.createComment({owner, repo, issue_number: pr.number, body})
              }
            }
