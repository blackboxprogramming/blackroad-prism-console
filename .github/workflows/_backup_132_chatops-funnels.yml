name: ChatOps: Funnels JSON
on: { issue_comment: { types: [created] } }
permissions: { contents: write, pull-requests: write }
jobs:
  edit:
    if: startsWith(github.event.comment.body, '/funnel ')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { fetch-depth: 0 }
      - name: Parse command
        id: p
        run: |
          RAW="${{ github.event.comment.body }}"
          echo "RAW=$RAW"
          # /funnel set "<name>" window <days> steps <id1,id2,id3>
          if [[ "$RAW" =~ ^/funnel[[:space:]]+set[[:space:]]+"([^"]+)"[[:space:]]+window[[:space:]]+([0-9]+)[[:space:]]+steps[[:space:]]+([a-zA-Z0-9_,-]+) ]]; then
            echo "name=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "days=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "steps=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
          else
            echo "Invalid syntax"; exit 1
          fi
      - name: Modify funnels.json
        run: |
          FILE="sites/blackroad/public/funnels.json"
          test -f "$FILE" || echo '{"funnels":[]}' > "$FILE"
          node - <<'NODE'
          const fs=require('fs'); const p=require('path');
          const file=p.join(process.cwd(),'sites','blackroad','public','funnels.json');
          const name=process.env.NAME, days=parseInt(process.env.DAYS||'14',10);
          const steps=(process.env.STEPS||'').split(',').map(s=>({id:s}));
          const j=JSON.parse(fs.readFileSync(file,'utf8'));
          const i=(j.funnels||[]).findIndex(f=>f.name===name);
          if (i>=0){ j.funnels[i].windowDays=days; j.funnels[i].steps=steps; }
          else { (j.funnels ||= []).push({ name, description:"(edited via ChatOps)", windowDays:days, steps }); }
          fs.writeFileSync(file, JSON.stringify(j,null,2));
NODE
        env:
          NAME: ${{ steps.p.outputs.name }}
          DAYS: ${{ steps.p.outputs.days }}
          STEPS: ${{ steps.p.outputs.steps }}
      - name: Commit changes
        env: { GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }} }
        run: |
          git add sites/blackroad/public/funnels.json
          git diff --staged --quiet || (git -c user.name=blackroad-bot -c user.email=bot@users.noreply.github.com commit -m "funnels: set \"${{ steps.p.outputs.name }}\" steps=${{ steps.p.outputs.steps }}" && git push)
      - name: Ack
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.issue.number, body: "âœ… Funnels updated. Check **/metrics**."});
