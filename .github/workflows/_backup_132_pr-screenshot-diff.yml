name: PR Screenshot Diff (Pages build)
on:
  pull_request:
    paths: [ 'sites/blackroad/**' ]
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: write
jobs:
  shot-diff:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { fetch-depth: 0 }
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install deps & build (PR)
        run: |
          cd sites/blackroad
          npm ci --omit=optional || npm i --package-lock-only
          npm run build
      - name: Checkout main to baseline/
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: baseline
      - name: Build baseline (main)
        run: |
          cd baseline/sites/blackroad
          npm ci --omit=optional || npm i --package-lock-only
          npm run build
      - name: Install tooling
        run: |
          npm i --no-save puppeteer@22 pixelmatch@5 pngjs@7 http-server@14
      - name: Run screenshot diff
        run: |
          node .github/tools/site/screenshot-diff.js \
            "sites/blackroad/dist" "baseline/sites/blackroad/dist" "artifacts/pr-diff"
      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: pr-screenshots
          path: artifacts/pr-diff/*
      - name: Comment result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs'); const p = 'artifacts/pr-diff/summary.json';
            let pct = 'n/a'; try{ pct = JSON.parse(fs.readFileSync(p,'utf8')).mismatchPct }catch{}
            const body = `üñºÔ∏è Screenshot diff mismatch: **${pct}%**\nArtifacts: **pr-screenshots** (base.png, pr.png, diff.png)`;
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.pull_request.number, body});
