name: Security Pack (flag-aware)
on:
  pull_request:
  schedule: [{ cron: '0 6 * * 1' }]
permissions: { contents: read, security-events: write }
jobs:
  flags:
    uses: ./.github/workflows/flags.yml
  semgrep:
    needs: flags
    if: needs.flags.outputs.security_scans == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - run: docker run --rm -v "$PWD:/src" returntocorp/semgrep semgrep --config p/default --timeout 120 --error || true
  trivy:
    needs: flags
    if: needs.flags.outputs.security_scans == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - run: docker run --rm -v "$PWD:/src" aquasec/trivy fs --exit-code 0 --severity HIGH,CRITICAL /src || true
  gitleaks:
    needs: flags
    if: needs.flags.outputs.security_scans == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - run: docker run --rm -v "$PWD:/repo" zricethezav/gitleaks:latest detect -s /repo --no-banner --redact --exit-code 0 || true
