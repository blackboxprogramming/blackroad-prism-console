name: CI
on:
  push: { branches: [main] }
  pull_request:
    paths:
      - '**.py'
      - '**.ts'
      - '**.tsx'
      - '.pre-commit-config.yaml'
      - 'package.json'
      - 'requirements*.txt'
      - 'pnpm-lock.yaml'
      - 'yarn.lock'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Python
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install Python deps
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt || true
          pip install -r requirements-dev.txt || true

      # Node (TS/JS)
      - uses: actions/setup-node@v4
        with: { node-version: '20' }
      - name: Install Node deps
        run: |
          if [ -f package-lock.json ]; then npm ci; fi
          if [ -f pnpm-lock.yaml ]; then corepack enable && pnpm -v && pnpm i --frozen-lockfile; fi
          if [ -f yarn.lock ]; then yarn install --frozen-lockfile; fi

      - name: Pre-commit
        run: |
          pip install pre-commit || true
          pre-commit run --all-files || (git status --porcelain && exit 1)

      - name: Python tests
        if: ${{ hashFiles('pytest.ini','pyproject.toml') != '' }}
        run: |
          if command -v pytest >/dev/null 2>&1; then pytest -q; fi

      - name: TS/JS tests
        if: ${{ hashFiles('package.json') != '' }}
        run: |
          npm test --if-present
