name: ci
on: [push, pull_request]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - run: python -m pip install -U pip pytest jsonschema
      - run: pytest -q
      - name: Determinism smoke
        run: |
          python -m pip install .
          brc plm:items:load --dir fixtures/plm/items
          brc plm:bom:load --dir fixtures/plm/boms
          A1=$(sha256sum artifacts/plm/items.json | cut -d' ' -f1)
          A2=$(sha256sum artifacts/plm/items.json | cut -d' ' -f1)
          test "$A1" = "$A2"
    - name: Contract validation
      run: python scripts/validate_contracts.py
    - name: Changelog guard
      run: |
        CHANGED=$(git diff --name-only HEAD~1 | grep -E '^(plm|mfg|cli|contracts)/' || true)
        if [ -n "$CHANGED" ] && ! git diff --name-only HEAD~1 | grep -q '^CHANGELOG.md$'; then
          echo 'Please update CHANGELOG.md'; exit 1; fi
