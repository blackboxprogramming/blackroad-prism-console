name: Prism â€” SSH Deploy to blackroad.io
on:
  push:
    branches: [ main ]
    paths:
      - "frontend/**"
      - "sites/blackroad/**"
      - "services/api/**"
      - "nginx/blackroad.io.conf"
      - "systemd/**"
      - ".github/workflows/prism-ssh-deploy.yml"
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine site directory
        id: site
        run: |
          if [ -d sites/blackroad ]; then
            echo "dir=sites/blackroad" >> "$GITHUB_OUTPUT"
          else
            echo "dir=frontend" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: "${{ steps.site.outputs.dir }}/package-lock.json"

      - name: Build site
        working-directory: ${{ steps.site.outputs.dir }}
        run: |
          npm ci
          npm run build

      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: Add host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync site
        run: |
          rsync -avz --delete --rsync-path="sudo rsync" ${{ steps.site.outputs.dir }}/dist/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/var/www/blackroad/

      - name: Rsync API source
        run: |
          rsync -avz --delete --rsync-path="sudo rsync" services/api/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/blackroad/api/

      - name: Upload config files
        run: |
          scp nginx/blackroad.io.conf ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/blackroad.io.conf
          scp systemd/blackroad-api.service ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/tmp/blackroad-api.service

      - name: Remote activate
        run: |
          ssh -tt ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} <<'EOS'
          set -euo pipefail
          sudo mv /tmp/blackroad.io.conf /etc/nginx/sites-available/blackroad.io
          sudo ln -sf /etc/nginx/sites-available/blackroad.io /etc/nginx/sites-enabled/blackroad.io
          sudo nginx -t
          sudo systemctl reload nginx
          sudo mv /tmp/blackroad-api.service /etc/systemd/system/blackroad-api.service
          sudo systemctl daemon-reload
          sudo systemctl enable --now blackroad-api
          sudo systemctl status blackroad-api --no-pager
          curl http://127.0.0.1:4000/api/health
          curl -I http://localhost
          EOS
