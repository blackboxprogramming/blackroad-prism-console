name: Prism ChatOps
on:
  issue_comment:
    types: [created]
permissions:
  contents: write
  pull-requests: write
  issues: write
jobs:
  chatops:
    if: startsWith(github.event.comment.body, '/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Parse command
        id: p
        run: echo "cmd=${{ github.event.comment.body }}" >> "$GITHUB_OUTPUT"

      # /deploy → build site + upload via SSH deploy workflow
      - name: Deploy
        if: contains(steps.p.outputs.cmd, '/deploy')
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          issue-number: ${{ github.event.issue.number || github.event.pull_request.number }}
          body: "▶️ Kicking off deploy…"
      - name: Trigger SSH deploy
        if: contains(steps.p.outputs.cmd, '/deploy')
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: prism-ssh-deploy.yml
          token: ${{ secrets.GITHUB_TOKEN }}

      # /status → show API + site probe results
      - name: Status
        if: contains(steps.p.outputs.cmd, '/status')
        run: |
          curl -fsS http://blackroad.io/api/health.json || true
          curl -I -s http://blackroad.io | head -1 || true

      # /fix → run format/lint (no-op here; CI will enforce)
      - name: Acknowledge
        if: contains(steps.p.outputs.cmd, '/fix') || contains(steps.p.outputs.cmd, '/format')
        run: echo "OK"
