name: Generate Sitemap & Robots
on:
  push:
    branches: [ main ]
    paths:
      - 'sites/blackroad/**'
  workflow_dispatch:
permissions: { contents: write }
jobs:
  sitemap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Build blog (to ensure index.json exists)
        run: |
          node ./sites/blackroad/scripts/build-blog.js || true
      - name: Generate sitemap.xml & robots.txt
        run: |
          set -eux
          ROOT="sites/blackroad"
          DIST="$ROOT/dist"
          PUB="$ROOT/public"
          mkdir -p "$DIST"
          DOMAIN="${{ vars.BLACKROAD_DOMAIN || 'blackroad.io' }}"
          BASE="https://${DOMAIN}"
          BLOG_INDEX="$PUB/blog/index.json"
          routes="/ /docs /status /snapshot /portal /playground /contact /tutorials /roadmap /changelog /blog"
          {
            echo '<?xml version="1.0" encoding="UTF-8"?>'
            echo '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'
            for r in $routes; do
              echo "  <url><loc>${BASE}${r}</loc></url>"
            done
            if [ -f "$BLOG_INDEX" ]; then
              node -e "const fs=require('fs');const j=JSON.parse(fs.readFileSync(process.argv[1],'utf8'));(j.posts||[]).forEach(p=>console.log(p.slug));" "$BLOG_INDEX" | while read -r slug; do
                echo "  <url><loc>${BASE}/blog/${slug}.html</loc></url>"
              done
            fi
            echo '</urlset>'
          } > "$DIST/sitemap.xml"
          cat > "$DIST/robots.txt" <<TXT
          User-agent: *
          Allow: /
          Sitemap: ${BASE}/sitemap.xml
          TXT
      - name: Commit artifacts (idempotent)
        run: |
          git add sites/blackroad/dist/sitemap.xml sites/blackroad/dist/robots.txt
          git diff --staged --quiet || (git config user.name  "${{ secrets.BOT_USER || 'blackroad-bot' }}"; git config user.email "${{ secrets.BOT_USER || 'blackroad-bot' }}@users.noreply.github.com"; git commit -m "chore(site): update sitemap & robots"; git push)
