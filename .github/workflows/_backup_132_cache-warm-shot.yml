name: Cache Warm + Screenshot
on:
  schedule: [ { cron: "12 7 * * *" } ]  # daily 07:12 UTC
  workflow_dispatch:
permissions:
  contents: write
  actions: read
  pull-requests: write
jobs:
  warm-and-shot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { persist-credentials: false, fetch-depth: 0 }
      - name: Warm cache
        id: warm
        run: |
          set -e
          BASE="${{ vars.BLACKROAD_URL || format('https://{0}', vars.BLACKROAD_DOMAIN || '') }}"
          if [ -z "$BASE" ]; then BASE="https://$(echo '${{ github.repository }}' | cut -d'/' -f1).github.io"; fi
          urls=("$BASE/" "$BASE/status" "$BASE/sitemap.xml" "$BASE/robots.txt")
          echo "Warming: ${urls[*]}"
          for u in "${urls[@]}"; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$u" || echo 000)
            echo "$u -> $code"
          done
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install Puppeteer deps
        run: |
          npm i --no-save puppeteer@22
      - name: Screenshot homepage
        run: |
          node .github/tools/site/screenshot.js
      - name: Upload screenshot artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: site-screenshot
          path: artifacts/site-screenshots/*
      - name: Commit snapshot into site (idempotent)
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet -- sites/blackroad/public/snapshots; then
            echo "No snapshot changes to commit."
            exit 0
          fi
          git config user.name  "${{ secrets.BOT_USER || 'blackroad-bot' }}"
          git config user.email "${{ secrets.BOT_USER || 'blackroad-bot' }}@users.noreply.github.com"
          git add sites/blackroad/public/snapshots
          git commit -m "chore(site): update homepage snapshot"
          git push "https://${BOT_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${GITHUB_REF#refs/heads/}
