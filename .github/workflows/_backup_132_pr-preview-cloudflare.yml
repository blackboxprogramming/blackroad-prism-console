name: PR Preview — Cloudflare Pages
on:
  pull_request:
    paths: [ 'sites/blackroad/**' ]
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: write
jobs:
  cf-preview:
    if: ${{ secrets.CF_API_TOKEN != '' && secrets.CF_ACCOUNT_ID != '' && vars.CF_PAGES_PROJECT != '' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Build site
        run: |
          cd sites/blackroad
          npm ci --omit=optional || npm i --package-lock-only
          npm run build
      - name: Deploy Preview (Cloudflare Pages)
        id: cf
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ vars.CF_PAGES_PROJECT }}
          directory: sites/blackroad/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
      - name: Comment Preview (Cloudflare Pages)
        uses: actions/github-script@v7
        with:
          script: |
            // pages-action doesn't expose url output consistently; link project + commit
            const pr = context.payload.pull_request.number;
            const proj = process.env.CF_PAGES_PROJECT || '';
            const commit = context.payload.pull_request.head.sha.substring(0,7);
            const msg = `☁️ Cloudflare Pages preview deployed for ${commit} (project: **${proj}**). Check the Pages dashboard for the preview URL.`;
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: pr, body: msg});
