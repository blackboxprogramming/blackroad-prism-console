name: Apply Branch Protection (best-effort)
on:
  push: { branches: [ main ] }
  workflow_dispatch:
permissions:
  contents: read
jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Preflight admin token
        id: pre
        run: |
          if [ -z "${ADMIN_TOKEN:-}" ]; then echo "go=no" >> "$GITHUB_OUTPUT"; else echo "go=yes" >> "$GITHUB_OUTPUT"; fi
        env:
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
      - name: Configure protection
        if: steps.pre.outputs.go == 'yes'
        env:
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -e
          BASE="https://api.github.com/repos/${OWNER}/${REPO}/branches/main/protection"
          JSON='{
            "required_status_checks":{"strict":true,"checks":[
              {"context":"Deploy Quantum App (safe)"},
              {"context":"CodeQL"},
              {"context":"Super-Linter"},
              {"context":"OSSF Scorecard"}
            ]},
            "enforce_admins":true,
            "required_pull_request_reviews":{"dismiss_stale_reviews":true,"require_code_owner_reviews":true,"required_approving_review_count":1},
            "required_linear_history":true,"allow_force_pushes":false,"allow_deletions":false,"required_conversation_resolution":true
          }'
          curl -sS -X PUT -H "Authorization: Bearer $ADMIN_TOKEN" -H "Accept: application/vnd.github+json" "$BASE" -d "$JSON" -o /tmp/resp.json -w "HTTP %{http_code}\n"
      - name: Summary
        if: steps.pre.outputs.go != 'yes'
        run: echo "ℹ️ Skipping branch protection (no ADMIN_TOKEN secret)." >> $GITHUB_STEP_SUMMARY

