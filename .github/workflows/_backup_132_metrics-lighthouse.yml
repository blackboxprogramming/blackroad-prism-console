name: Metrics: Lighthouse
on:
  push:
    branches: [ main ]
    paths: [ 'sites/blackroad/**' ]
  schedule: [ { cron: "23 4 * * *" } ] # daily
  workflow_dispatch:
permissions: { contents: write }
jobs:
  lh:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Run Lighthouse (public site)
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            ${{ vars.BLACKROAD_URL || 'https://blackroad.io' }}/
            ${{ vars.BLACKROAD_URL || 'https://blackroad.io' }}/status
            ${{ vars.BLACKROAD_URL || 'https://blackroad.io' }}/blog
          uploadArtifacts: true
          temporaryPublicStorage: true
      - name: Aggregate â†’ metrics/lh.json
        run: |
          node - <<'NODE'
          const fs=require('fs'), path=require('path');
          const base=process.cwd();
          const manPath = path.join(base,'./lhci_reports/manifest.json');
          if (!fs.existsSync(manPath)) { console.log('No lhci manifest.'); process.exit(0); }
          const man = JSON.parse(fs.readFileSync(manPath,'utf8'));
          // Average category scores and core metrics across all reports
          const acc = { count:0, perf:0,a11y:0,bp:0,seo:0,pwa:0, LCP:0,FCP:0,CLS:0,TBT:0,TTI:0 }
          for (const e of man) {
            const j = JSON.parse(fs.readFileSync(e.jsonPath,'utf8'));
            const cat = j.categories||{};
            acc.count++;
            acc.perf += (cat.performance?.score ?? 0);
            acc.a11y += (cat.accessibility?.score ?? 0);
            acc.bp   += (cat['best-practices']?.score ?? 0);
            acc.seo  += (cat.seo?.score ?? 0);
            acc.pwa  += (cat.pwa?.score ?? 0);
            const a=j.audits||{};
            acc.LCP += (a['largest-contentful-paint']?.numericValue ?? 0);
            acc.FCP += (a['first-contentful-paint']?.numericValue ?? 0);
            acc.CLS += (a['cumulative-layout-shift']?.numericValue ?? 0);
            acc.TBT += (a['total-blocking-time']?.numericValue ?? 0);
            acc.TTI += (a['interactive']?.numericValue ?? 0);
          }
          if (acc.count>0){
            for (const k of ['perf','a11y','bp','seo','pwa','LCP','FCP','CLS','TBT','TTI']) acc[k] /= acc.count;
          }
          const rec = { ts:new Date().toISOString(), ...acc };
          const file=path.join(base,'sites','blackroad','public','metrics','lh.json');
          let data={ history:[] }; try{ data=JSON.parse(fs.readFileSync(file,'utf8')); }catch{}
          data.history = [rec, ...data.history].slice(0,90);
          fs.mkdirSync(path.dirname(file), { recursive:true });
          fs.writeFileSync(file, JSON.stringify(data,null,2));
          console.log('LH record:', rec);
NODE
      - name: Commit metrics (if changed)
        env: { GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }} }
        run: |
          git add sites/blackroad/public/metrics/lh.json
          git diff --staged --quiet || (git config user.name "${{ secrets.BOT_USER || 'blackroad-bot' }}"; git config user.email "${{ secrets.BOT_USER || 'blackroad-bot' }}@users.noreply.github.com"; git commit -m "metrics(lighthouse): append record"; git push)
