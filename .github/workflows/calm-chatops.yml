name: Calm ChatOps v2
on: { issue_comment: { types: [created] } }
permissions: { contents: write, pull-requests: write, issues: write, actions: read }
jobs:
  chatops:
    if: startsWith(github.event.comment.body, '/')
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      BOT_USER:  ${{ secrets.BOT_USER || 'blackroad-bot' }}
    steps:
      - uses: actions/checkout@v4
        with: { persist-credentials: false, fetch-depth: 0 }
      - run: |
          git config user.name  "$BOT_USER"
          git config user.email "$BOT_USER@users.noreply.github.com"
      - id: parse
        run: echo "cmd=${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
      - if: contains(steps.parse.outputs.cmd, '/fix')
        run: |
          .github/tools/autoheal.sh || true
          if ! git diff --quiet; then git add -A; git commit -m "chore(chatops): auto-heal"; [ -n "$BOT_TOKEN" ] && git push "https://${BOT_TOKEN}@github.com/${{ github.repository }}.git" "HEAD:$(git rev-parse --abbrev-ref HEAD)"; fi
      - if: contains(steps.parse.outputs.cmd, '/format')
        run: |
          npm i -D prettier >/dev/null 2>&1 || true
          npx --yes prettier -w . || true
          if ! git diff --quiet; then git add -A; git commit -m "chore(chatops): prettier"; [ -n "$BOT_TOKEN" ] && git push "https://${BOT_TOKEN}@github.com/${{ github.repository }}.git" "HEAD:$(git rev-parse --abbrev-ref HEAD)"; fi
      - if: contains(steps.parse.outputs.cmd, '/lint')
        run: |
          npm i -D eslint eslint-config-prettier >/dev/null 2>&1 || true
          [ -f eslint.config.js ] || echo 'export default [];' > eslint.config.js
          npx --yes eslint . --ext .js,.mjs,.cjs --fix || true
          if ! git diff --quiet; then git add -A; git commit -m "chore(chatops): eslint --fix"; [ -n "$BOT_TOKEN" ] && git push "https://${BOT_TOKEN}@github.com/${{ github.repository }}.git" "HEAD:$(git rev-parse --abbrev-ref HEAD)"; fi
      - if: contains(steps.parse.outputs.cmd, '/bump deps')
        run: |
          npm i -g npm-check-updates >/dev/null 2>&1 || true
          ncu -u || true
          npm i || npm i --package-lock-only || true
          if ! git diff --quiet; then git add -A; git commit -m "chore(deps): bump via ChatOps"; [ -n "$BOT_TOKEN" ] && git push "https://${BOT_TOKEN}@github.com/${{ github.repository }}.git" "HEAD:$(git rev-parse --abbrev-ref HEAD)"; fi
      - if: startsWith(steps.parse.outputs.cmd, '/rerun ')
        uses: actions/github-script@v7
        with:
          script: |
            const wf = `${{ steps.parse.outputs.cmd }}`.replace('/rerun ','').trim()+'.yml';
            try{ await github.actions.createWorkflowDispatch({owner: context.repo.owner, repo: context.repo.repo, workflow_id: wf, ref: context.ref.replace('refs/heads/','')}); }catch(e){}
