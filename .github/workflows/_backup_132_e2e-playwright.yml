name: E2E — Playwright (routes + screenshots from sitemap)
on:
  pull_request:
    paths: [ 'sites/blackroad/**' ]
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: write
jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Install site & Playwright
        run: |
          cd sites/blackroad
          npm ci --omit=optional || npm i --package-lock-only
          npm i -D @playwright/test@1 http-server@14
          npx playwright install --with-deps
      - name: Build site
        run: cd sites/blackroad && npm run build
      - name: Serve built site
        working-directory: sites/blackroad
        run: npx http-server dist -p 4178 -s & sleep 2
      - name: Run sitemap-driven tests
        working-directory: sites/blackroad
        env:
          E2E_BASE: http://127.0.0.1:4178
        run: node ../tests/run-e2e-from-sitemap.js
      - name: Upload E2E artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: e2e-artifacts
          path: sites/blackroad/test-results/**
      - name: Comment summary
        if: always() && github.event.pull_request.number
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.pull_request.number, body: "✅ Playwright (sitemap-driven) ran. Artifacts: **e2e-artifacts**."});
