name: review-apps
on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_target:
    types: [closed]
concurrency:
  group: review-${{ github.event.pull_request.number }}
  cancel-in-progress: true
permissions: {}
jobs:
  create:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { fetch-depth: 0 }
      - name: Create/Update review app
        uses: dokku/github-action@v1.8.0
        with:
          command: "review-apps:create"
          git_remote_url: "ssh://dokku@${{ secrets.DOKKU_HOST }}:22/blackroad"
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh_host_key: ${{ secrets.SSH_HOST_KEY }}
          # optional: override name -> review-blackroad-mybranch
          # review_app_name: "review-blackroad-${{ github.head_ref }}"

  destroy:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed'
    runs-on: ubuntu-24.04
    steps:
      - name: Destroy review app
        uses: dokku/github-action@v1.8.0
        with:
          command: "review-apps:destroy"
          git_remote_url: "ssh://dokku@${{ secrets.DOKKU_HOST }}:22/blackroad"
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          ssh_host_key: ${{ secrets.SSH_HOST_KEY }}

