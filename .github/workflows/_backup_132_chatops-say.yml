name: ChatOps: Say to Inbox
on: { issue_comment: { types: [created] } }
permissions: { contents: write, pull-requests: write }
jobs:
  say:
    if: startsWith(github.event.comment.body, '/say ')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Append to inbox.json
        run: |
          node - <<'NODE'
          const fs=require('fs'), path=require('path');
          const msg = process.env.MSG.replace(/^\/say\s+/,'').trim();
          const who = process.env.USER || 'someone';
          const file = path.join(process.cwd(),'sites','blackroad','public','inbox.json');
          let j={ messages:[] }; try{ j=JSON.parse(fs.readFileSync(file,'utf8')); }catch{}
          j.messages.unshift({ ts:new Date().toISOString(), from: who, text: msg });
          j.messages = j.messages.slice(0,100);
          fs.mkdirSync(path.dirname(file), { recursive:true });
          fs.writeFileSync(file, JSON.stringify(j,null,2));
NODE
        env:
          MSG: ${{ github.event.comment.body }}
          USER: ${{ github.event.comment.user.login }}
      - name: Commit inbox (if changed)
        env: { GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }} }
        run: |
          git add sites/blackroad/public/inbox.json
          git diff --staged --quiet || (git config user.name "${{ secrets.BOT_USER || 'blackroad-bot' }}"; git config user.email "${{ secrets.BOT_USER || 'blackroad-bot' }}@users.noreply.github.com"; git commit -m "inbox: new message"; git push)
      - name: Ack
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.issue.number, body: "ðŸ“¬ Message posted to [/inbox](/inbox)."})
