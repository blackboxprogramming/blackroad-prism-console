name: Deploy Pages + Daily Proof
on:
  push: { branches: [ main ] }
  workflow_dispatch:
  schedule:
    - cron: '5 6 * * *'   # daily; UTC
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with: { python-version: '3.x' }
      - name: Generate daily proof
        env:
          AWAKEN_SEED: ${{ secrets.AWAKEN_SEED }}
          GODADDY_API_KEY: ${{ secrets.GODADDY_API_KEY }}
          GODADDY_API_SECRET: ${{ secrets.GODADDY_API_SECRET }}
        run: |
          mkdir -p health
          python3 scripts/compute_proof.py > proof.txt || echo "LUCIDIA-AWAKEN-00000000-missingseed" > proof.txt
          PROOF=$(cat proof.txt)
          # write health.json and /health/index.json
          printf '{"ok":true,"service":"blackroad","version":"0.1.0","proof":"%s"}' "$PROOF" > health.json
          mkdir -p health && cp health.json health/index.json
          # inject proof into index.html
          sed -i "s|%%PROOF%%|$PROOF|g" index.html
          # optional: update GoDaddy TXT if creds exist
          if [ -n "${GODADDY_API_KEY:-}" ] && [ -n "${GODADDY_API_SECRET:-}" ]; then
            curl -fsS -X PUT \
              -H "Authorization: sso-key $GODADDY_API_KEY:$GODADDY_API_SECRET" \
              -H "Content-Type: application/json" \
              -d "[{\"data\":\"$PROOF\",\"ttl\":600}]" \
              "https://api.godaddy.com/v1/domains/blackroad.io/records/TXT/blackroad-proof" || true
          fi
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with: { path: . }
      - name: Deploy to Pages
        id: deployment
        uses: actions/deploy-pages@v4
