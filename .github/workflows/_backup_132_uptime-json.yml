name: Uptime JSON (commit status.json)
on:
  schedule: [ { cron: "*/30 * * * *" } ]  # every 30 min
  workflow_dispatch:
permissions:
  contents: write
jobs:
  write-json:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { persist-credentials: false, fetch-depth: 0 }
      - name: Ping endpoints
        id: ping
        run: |
          set -e
          URL_MAIN="${{ vars.BLACKROAD_URL || format('https://{0}', vars.BLACKROAD_DOMAIN || 'blackroad.io') }}"
          URL_PAGES="https://$(echo '${{ github.repository }}' | cut -d'/' -f1).github.io"
          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          code_main=$(curl -s -o /dev/null -w "%{http_code}" "$URL_MAIN" || echo 000)
          code_pages=$(curl -s -o /dev/null -w "%{http_code}" "$URL_PAGES" || echo 000)
          mkdir -p sites/blackroad/public
          cat > sites/blackroad/public/status.json <<JSON
          {
            "timestamp": "$ts",
            "checks": [
              { "name": "main", "url": "$URL_MAIN", "status": $code_main },
              { "name": "pages", "url": "$URL_PAGES", "status": $code_pages }
            ]
          }
          JSON
      - name: Commit status.json
        run: |
          if git diff --quiet; then
            echo "No changes"; exit 0
          fi
          git config user.name  "${{ secrets.BOT_USER || 'blackroad-bot' }}"
          git config user.email "${{ secrets.BOT_USER || 'blackroad-bot' }}@users.noreply.github.com"
          git add sites/blackroad/public/status.json
          git commit -m "chore(status): update status.json"
          git push "https://${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git" HEAD:${GITHUB_REF#refs/heads/}
