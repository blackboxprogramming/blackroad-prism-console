name: Ensure Repo Project
on:
  push: { branches: [ main ] }
  workflow_dispatch:
permissions:
  repository-projects: write
  contents: read
jobs:
  ensure-project:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            try {
              const owner = context.repo.owner, repo = context.repo.repo;
              const hdr = { 'Accept': 'application/vnd.github.inertia-preview+json' };
              const projects = await github.request('GET /repos/{owner}/{repo}/projects',{owner,repo,headers:hdr});
              let project = projects.data.find(p => p.name === 'Quantum Auto');
              if (!project) {
                const created = await github.request('POST /repos/{owner}/{repo}/projects',{owner,repo,name:'Quantum Auto',body:'Automanaged board',headers:hdr});
                project = created.data;
              }
              const cols = await github.request('GET /projects/{project_id}/columns',{project_id:project.id,headers:hdr});
              const want = ['Backlog','To do','In progress','Done'];
              const by = Object.fromEntries(cols.data.map(c=>[c.name,c]));
              for (const n of want) if (!by[n]) await github.request('POST /projects/{project_id}/columns',{project_id:project.id,name:n,headers:hdr});
            } catch (e) {
              if (e.status === 410 || e.status === 403 || e.status === 404) {
                core.warning('Projects Classic not enabled or not permitted â€” skipping.');
              } else {
                throw e;
              }
            }

