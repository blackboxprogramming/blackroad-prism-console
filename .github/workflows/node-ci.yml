name: "ðŸ§ª Node CI"

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - '.github/workflows/node-ci.yml'
      - '.github/workflows/node-tests.yml'
      - 'package.json'
      - 'package-lock.json'
      - 'jest.config.js'
      - 'srv/**'
      - 'lib/**'
      - 'tests/**'
      - 'app/**'
      - 'frontend/**'
      - 'scripts/**'
  push:
    branches:
      - main
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'jest.config.js'
      - 'srv/**'
      - 'lib/**'
      - 'tests/**'
      - 'app/**'
      - 'frontend/**'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: read

concurrency:
  group: node-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != format('refs/heads/{0}', github.event.repository.default_branch) }}

jobs:
  tests:
    name: "ðŸ§ª Node tests"
    uses: ./.github/workflows/node-tests.yml
    secrets: inherit
    with:
      node-version: '20'
      install-command: npm ci --no-audit --no-fund
      test-command: npm test -- --ci --runInBand
      junit-path: reports/junit.xml
      artifact-name: node-ci-junit
      package-manager: npm
      cache-dependency-path: |
        package-lock.json
        sites/blackroad/package-lock.json
      working-directory: .
