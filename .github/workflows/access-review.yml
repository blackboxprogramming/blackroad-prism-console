name: access-review

on:
  schedule:
    - cron: "0 15 1 */3 *"
  workflow_dispatch: {}

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: AWS: roles & users
        run: |
          aws iam list-users > aws_users.json
          aws iam list-roles > aws_roles.json
      - name: Okta: groups & app assignments
        run: |
          curl -s -H "Authorization: SSWS $OKTA_TOKEN" "$OKTA_URL/api/v1/groups" > okta_groups.json
        env:
          OKTA_TOKEN: ${{ secrets.OKTA_TOKEN }}
          OKTA_URL: ${{ secrets.OKTA_URL }}
      - name: GitHub: members & teams
        run: gh api orgs/${{ github.repository_owner }}/members --paginate > gh_members.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 1Password: vault audit (summary)
        run: op vault list --format json > op_vaults.json
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SA_TOKEN }}
      - name: Package evidence
        run: |
          mkdir -p evidence/access
          mv *.json evidence/access/
          zip -r evidence-access-$(date +%F).zip evidence
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: access-review
          path: evidence-access-*.zip
