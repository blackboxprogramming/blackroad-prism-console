name: Codex Bridge
on:
  issue_comment:
    types: [created]
permissions:
  contents: write
  pull-requests: write
  issues: write
jobs:
  apply:
    if: startsWith(github.event.comment.body, '/codex ')
    runs-on: ubuntu-latest
    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      BOT_USER: ${{ secrets.BOT_USER || 'blackroad-bot' }}
      CODEx_BODY: ${{ github.event.comment.body }}
      CODEx_PERMISSION: ${{ github.event.comment.author_association }}
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { persist-credentials: false, fetch-depth: 0 }
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - name: Run Codex Bridge
        run: node .github/tools/codex-apply.js
      - name: Comment result
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: "ðŸ§© Codex Bridge processed your request. If nothing changed, it likely skipped due to missing blocks, permissions, or size limits."
            });
