name: Auto route mentions

on:
  workflow_call:
    inputs:
      routes_yaml_path:
        description: Path to the mention routing configuration file.
        required: false
        type: string
        default: ".github/mention-routes.yml"

permissions:
  contents: read
  pull-requests: write
  issues: write
  statuses: write
  id-token: none

jobs:
  route:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    outputs:
      mentions: ${{ steps.route.outputs.mentions }}
      has_mentions: ${{ steps.route.outputs.has_mentions }}
    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}

      - name: Route mentions
        id: route
        uses: ./.github/actions/route-mentions
        with:
          routes_yaml_path: ${{ inputs.routes_yaml_path }}

      - name: Routing status check
        uses: actions/github-script@v7
        env:
          HAS_MENTIONS: ${{ steps.route.outputs.has_mentions }}
          MENTIONS: ${{ steps.route.outputs.mentions }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            if (!pr) {
              core.info('No pull request payload detected; skipping status.');
              return;
            }
            const sha = pr.head.sha;
            const hasMentions = process.env.HAS_MENTIONS === 'true';
            const description = hasMentions
              ? `Mentions posted: ${process.env.MENTIONS}`
              : 'No mentions matched';
            await github.rest.repos.createCommitStatus({
              owner,
              repo,
              sha,
              state: 'success',
              context: 'routing',
              description: description.slice(0, 140),
              target_url: `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`
            });
