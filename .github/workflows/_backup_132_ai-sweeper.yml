name: AI Sweeper (periodic)
on:
  schedule: [ { cron: "17 3 * * *" } ] # daily
  workflow_dispatch:
permissions: { contents: write, pull-requests: write }
jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { fetch-depth: 0 }
      - name: Run format/lint/build
        run: |
          npm run -s format || true
          npm run -s lint || true
          (cd sites/blackroad && npm ci --omit=optional || npm i --package-lock-only && npm run -s build) || true
      - name: Commit trivial fixes
        env: { GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }} }
        run: |
          git add -A
          git diff --staged --quiet || (git config user.name "${{ secrets.BOT_USER || 'blackroad-bot' }}"; git config user.email "${{ secrets.BOT_USER || 'blackroad-bot' }}@users.noreply.github.com"; git commit -m "chore: sweeper auto-fix"; git push)
      - name: Open PR if there are changes
        uses: actions/github-script@v7
        with:
          script: |
            const {data: compare} = await github.repos.compareCommits({owner: context.repo.owner, repo: context.repo.repo, base: context.payload.repository.default_branch, head: 'HEAD'});
            if (compare.status !== 'ahead') return;
            const branch = 'ai-sweeper/' + Date.now();
            await github.git.createRef({owner: context.repo.owner, repo: context.repo.repo, ref: `refs/heads/${branch}`, sha: context.sha});
            await github.pulls.create({owner: context.repo.owner, repo: context.repo.repo, head: branch, base: context.payload.repository.default_branch, title: 'chore: AI Sweeper auto-fixes', body: 'Periodic lint/build fixes.'});
