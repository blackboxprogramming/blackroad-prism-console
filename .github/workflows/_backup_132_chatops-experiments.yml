name: ChatOps: Experiments JSON
on: { issue_comment: { types: [created] } }
permissions: { contents: write, pull-requests: write }
jobs:
  edit:
    if: startsWith(github.event.comment.body, '/exp ')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Parse command
        id: p
        run: |
          RAW="${{ github.event.comment.body }}"
          echo "RAW=$RAW"
          # /exp set <id> active on|off weights A=<num> B=<num>
          if [[ "$RAW" =~ ^/exp[[:space:]]+set[[:space:]]+([a-zA-Z0-9_-]+)[[:space:]]+active[[:space:]]+(on|off)[[:space:]]+weights[[:space:]]+A=([0-9.]+)[[:space:]]+B=([0-9.]+) ]]; then
            echo "id=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "active=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "wa=${BASH_REMATCH[3]}" >> $GITHUB_OUTPUT
            echo "wb=${BASH_REMATCH[4]}" >> $GITHUB_OUTPUT
          else
            echo "Invalid syntax"; exit 1
          fi
      - name: Modify experiments.json
        run: |
          FILE="sites/blackroad/public/experiments.json"
          test -f "$FILE" || echo '{"experiments":[]}' > "$FILE"
          node - <<'NODE'
          const fs=require('fs'); const p=require('path');
          const file = p.join(process.cwd(),'sites','blackroad','public','experiments.json');
          const id=process.env.EID, act=process.env.ACT==='on', wa=parseFloat(process.env.WA||'0.5'), wb=parseFloat(process.env.WB||'0.5');
          const j = JSON.parse(fs.readFileSync(file,'utf8'));
          const i = (j.experiments||[]).findIndex(e=>e.id===id);
          if (i>=0){ j.experiments[i].active=act; j.experiments[i].weights={A:wa,B:wb}; }
          else { (j.experiments ||= []).push({ id, active: act, weights: {A:wa,B:wb}, desc: "" }); }
          fs.writeFileSync(file, JSON.stringify(j,null,2));
NODE
        env:
          EID: ${{ steps.p.outputs.id }}
          ACT: ${{ steps.p.outputs.active }}
          WA: ${{ steps.p.outputs.wa }}
          WB: ${{ steps.p.outputs.wb }}
      - name: Commit changes
        env: { GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }} }
        run: |
          git add sites/blackroad/public/experiments.json
          git diff --staged --quiet || (git -c user.name=blackroad-bot -c user.email=bot@users.noreply.github.com commit -m "exp: set ${{ steps.p.outputs.id }} active=${{ steps.p.outputs.active }} weights A=${{ steps.p.outputs.wa }} B=${{ steps.p.outputs.wb }}" && git push)
      - name: Ack
        uses: actions/github-script@v7
        with:
          script: |
            await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: context.payload.issue.number, body: "âœ… Experiments updated. Deploy to apply."});
