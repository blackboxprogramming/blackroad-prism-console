name: Fix Anything (Codex driver)
on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Super-Linter (flag-aware)"
      - "Security Pack (flag-aware)"
      - "LLM Quality (flag-aware)"
      - "Monorepo Matrix"
      - "Lighthouse CI (blackroad, flag-aware)"
      - "Link Check (advisory)"
    types: [completed]
permissions:
  contents: write
  pull-requests: write
jobs:
  fix:
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event.workflow_run.conclusion == 'timed_out' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with: { fetch-depth: 0, persist-credentials: false }
      - name: Apply FIX ANYTHING playbook
        run: node .github/tools/codex-apply.js ".github/prompts/codex-fix-anything.md" || true
      - name: Format & Lint (non-blocking)
        run: |
          npm i -D prettier eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin || true
          npx prettier -w . || true
          npx eslint . --ext .js,.jsx,.ts,.tsx --fix || true
      - name: Commit and push changes
        env: { GITHUB_TOKEN: ${{ secrets.BOT_TOKEN || secrets.GITHUB_TOKEN }} }
        run: |
          git add -A
          git diff --staged --quiet || git commit -m "chore(auto-fix): remediate failing workflows" || true
          BRANCH="$(git rev-parse --abbrev-ref HEAD)"
          if [ "$BRANCH" != "HEAD" ]; then
            git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:"$BRANCH" || true
          fi
      - uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const pr = (run.pull_requests && run.pull_requests[0]) || null;
            if(pr){
              await github.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body: "ðŸ¤– Fix Anything attempted remediation. Re-run the failing job to validate."});
            }
