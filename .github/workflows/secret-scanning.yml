name: Secret Scanning Guardrail

on:
  workflow_dispatch:
  schedule:
    - cron: '30 5 * * *'
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  security-events: read

jobs:
  verify:
    name: Verify secret scanning hygiene
    runs-on: ubuntu-latest
    steps:
      - name: List open secret scanning alerts
        id: alerts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data } = await github.rest.secretScanning.listAlertsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });

            core.setOutput('count', String(data.length));
            if (data.length === 0) {
              core.info('No open secret scanning alerts.');
              return;
            }

            const details = data
              .slice(0, 20)
              .map(alert => `#${alert.number} • ${alert.secret_type} • ${alert.state}`)
              .join('\n');
            core.setOutput('sample', details);
            core.setFailed(`There are ${data.length} open secret scanning alerts. Resolve or dismiss them before merging.`);
      - name: Emit alert summary
        if: ${{ steps.alerts.outputs.count != '0' }}
        run: |
          echo "Open secret scanning alerts:" >&2
          echo "${{ steps.alerts.outputs.sample }}" >&2
