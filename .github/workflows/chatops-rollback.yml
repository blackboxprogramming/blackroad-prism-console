name: ChatOps: Rollback deploy
on:
  issue_comment:
    types: [created]
permissions:
  actions: write
  issues: write
jobs:
  run:
    if: startsWith(github.event.comment.body, '/rollback blackroad')
    runs-on: ubuntu-latest
    steps:
      - name: Find last successful run
        id: last
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-blackroad.yml',
              status: 'success',
              branch: context.payload.repository.default_branch,
              per_page: 1
            });
            if (!data.workflow_runs.length) {
              core.setFailed('No successful runs');
              return;
            }
            core.setOutput('sha', data.workflow_runs[0].head_sha);
      - name: Dispatch rollback
        if: steps.last.outputs.sha
        uses: actions/github-script@v7
        with:
          script: |
            await github.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy-blackroad.yml',
              ref: '${{ steps.last.outputs.sha }}'
            });
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `‚è™ Rollback dispatched to commit \`${{ steps.last.outputs.sha }}\``
            });
