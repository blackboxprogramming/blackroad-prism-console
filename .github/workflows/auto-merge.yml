name: Auto Merge (label-driven)
on:
  pull_request:
    types: [labeled, synchronize, reopened, ready_for_review]
  check_suite:
    types: [completed]
permissions: { contents: write, pull-requests: write }
jobs:
  merge:
    if: github.event_name == 'check_suite' || contains(github.event.pull_request.labels.*.name, 'automerge')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const {owner,repo} = context.repo;
            const pr = context.payload.pull_request || (await github.search.issuesAndPullRequests({q:`repo:${owner}/${repo} is:pr is:open label:automerge` })).data.items[0];
            if (!pr) return;
            const num = pr.number || pr;
            const checks = await github.checks.listForRef({owner,repo,ref: pr.head.sha});
            const allGreen = checks.data.check_runs.every(c=>['success','skipped','neutral'].includes(c.conclusion||''));
            if (!allGreen) return;
            try { await github.pulls.merge({owner,repo,pull_number:num,merge_method:'squash'}); } catch(e){}
