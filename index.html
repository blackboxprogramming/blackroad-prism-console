<!doctype html><html><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>BlackRoad</title>
<style>
:root{--accent:#FF4FD8;--accent-2:#0096FF;--accent-3:#FDBA2D}
html,body{margin:0;height:100%;background:#0b0b0f;color:#eaeaf0;font-family:Inter,system-ui,sans-serif}
.wrap{min-height:100dvh;display:grid;place-items:center}
.card{padding:24px;border:1px solid #222;border-radius:16px;background:linear-gradient(180deg,#0f0f16,#0b0b0f)}
.badge{display:inline-block;padding:6px 10px;border-radius:9999px;background:var(--accent);color:#0b0b0f;font-weight:700}
a{color:var(--accent-2);text-decoration:none}
</style></head><body>
<!-- BLACKROAD OK -->
<div class="wrap"><div class="card">
  <div class="badge">BlackRoad</div>
  <h1>We’re online.</h1>
  <p>Daily proof: <code id="proof">%%PROOF%%</code></p>
  <p><a href="/health.json">/health.json</a> &nbsp; <a href="/health/">/health/</a></p>
  <small>Palette: #FF4FD8 · #0096FF · #FDBA2D</small>
</div></div>
</body></html>
<!-- FILE: /var/www/blackroad/index.html -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>BlackRoad.io — Codex Portal</title>
    <meta
      name="description"
      content="BlackRoad.io — AI-native co-coding portal (Codex + Lucidia)."
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>" />
    <!-- Fonts (optional, safe fallbacks) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0c0f14; /* deep slate */
        --panel: #12161d; /* card/side panels */
        --panel-2: #0f141b;
        --text: #e7ecf3; /* high-contrast on dark */
        --muted: #91a0b3;
        --border: #1f2632;

        /* Brand palette (locked) */
        --accent: #ff4fd8; /* primary neon magenta  */
        --accent-2: #0096ff; /* electric blue         */
        --accent-3: #fdba2d; /* amber                 */

        --ok: #19c37d;
        --warn: #f5a524;
        --err: #ef4444;

        --radius: 10px;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family:
          Inter,
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          'Helvetica Neue',
          Arial,
          'Noto Sans',
          sans-serif;
        letter-spacing: 0.2px;
      }
      a {
        color: var(--accent-2);
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }

      .skip-link {
        position: absolute;
        left: -999px;
        top: auto;
        width: 1px;
        height: 1px;
        overflow: hidden;
      }
      .skip-link:focus {
        left: 10px;
        top: 10px;
        width: auto;
        height: auto;
        background: var(--accent-2);
        color: #000;
        padding: 8px;
        border-radius: var(--radius);
        z-index: 1000;
      }

      .app {
        display: grid;
        grid-template-columns: 260px 1fr;
        grid-template-rows: 56px 1fr;
        grid-template-areas:
          'sidebar header'
          'sidebar main';
        height: 100%;
      }

      .sidebar {
        grid-area: sidebar;
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 14px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px;
        border-radius: 8px;
        background: linear-gradient(90deg, rgba(255, 79, 216, 0.14), rgba(0, 150, 255, 0.08));
        border: 1px solid var(--border);
      }
      .brand .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 16px var(--accent);
      }
      .brand .title {
        font-weight: 700;
        letter-spacing: 0.4px;
      }
      .brand .subtitle {
        font-size: 12px;
        color: var(--muted);
      }

      .nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 4px;
      }
      .nav button {
        appearance: none;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        text-align: left;
        padding: 10px 12px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
      }
      .nav button:hover {
        background: #131925;
      }
      .nav button.active {
        background: linear-gradient(90deg, rgba(0, 150, 255, 0.12), rgba(255, 79, 216, 0.1));
        border-color: rgba(0, 150, 255, 0.35);
        outline: 1px solid rgba(255, 79, 216, 0.35);
      }

      .presence {
        margin-top: auto;
        border: 1px dashed var(--border);
        border-radius: 8px;
        padding: 10px;
        font-size: 12px;
        color: var(--muted);
      }
      .presence strong {
        color: var(--text);
      }
      .presence .chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        margin-right: 6px;
      }
      .presence .ok {
        border-color: rgba(25, 195, 125, 0.5);
        color: #a5f3d6;
      }
      .presence .warn {
        border-color: rgba(245, 165, 36, 0.5);
        color: #fde3b3;
      }

      .header {
        grid-area: header;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        background: rgba(10, 14, 19, 0.65);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 2;
      }
      .search {
        display: flex;
        gap: 8px;
        align-items: center;
        width: 520px;
        max-width: 60vw;
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 6px 10px;
      }
      .search input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        color: var(--text);
        font-family: inherit;
        font-size: 14px;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 12px;
        background: transparent;
        color: var(--text);
        cursor: pointer;
      }
      .btn.acc {
        border-color: rgba(255, 79, 216, 0.35);
        background: linear-gradient(90deg, rgba(255, 79, 216, 0.16), rgba(0, 150, 255, 0.12));
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .main {
        grid-area: main;
        padding: 16px;
        overflow: auto;
      }

      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 16px;
      }
      .two-col {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 16px;
      }
      .row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .muted {
        color: var(--muted);
      }
      .mono {
        font-family:
          'JetBrains Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
      }

      /* Chat */
      .chat-wrap {
        display: grid;
        grid-template-rows: 1fr auto;
        height: 60vh;
        min-height: 420px;
      }
      .chat-stream {
        overflow: auto;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #0d1219;
      }
      .bubble {
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        margin-bottom: 10px;
        white-space: pre-wrap;
      }
      .bubble.user {
        background: rgba(0, 150, 255, 0.08);
      }
      .bubble.ai {
        background: rgba(255, 79, 216, 0.08);
      }
      .input-row {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      textarea.input {
        resize: vertical;
        min-height: 48px;
        max-height: 240px;
        flex: 1;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0d1219;
        color: var(--text);
        padding: 10px;
      }

      /* Editor */
      .editor-area {
        width: 100%;
        min-height: 55vh;
        font-size: 13.5px;
        line-height: 1.5;
        padding: 12px;
        border-radius: 8px;
        color: var(--text);
        background: #0d1219;
        border: 1px solid var(--border);
      }

      /* Canvas */
      .canvas-board {
        width: 100%;
        height: 55vh;
        background: #0d1219;
        border: 1px dashed #1e2532;
        border-radius: 8px;
        cursor: crosshair;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        border-bottom: 1px solid var(--border);
        padding: 10px;
        text-align: left;
      }
      tbody tr:hover {
        background: #121826;
      }

      /* Login gate */
      .gate {
        position: fixed;
        inset: 0;
        display: none;
        place-items: center;
        background: rgba(8, 11, 16, 0.8);
        backdrop-filter: blur(6px);
        z-index: 9999;
      }
      .gate .panel {
        width: min(480px, 92vw);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }
      .gate input {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0d1219;
        color: var(--text);
      }
      .gate .row {
        margin-top: 10px;
      }

      /* Tiny helpers */
      .k {
        color: #94a3b8;
        font-size: 12px;
      }
      .kbd {
        border: 1px solid var(--border);
        border-bottom-color: #0a0d12;
        padding: 1px 6px;
        border-radius: 6px;
        background: #0d1219;
      }
    </style>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to main content</a>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="brand">
          <div class="dot" aria-hidden="true"></div>
          <div>
            <div class="title">BlackRoad Codex</div>
            <div class="subtitle">AI‑Native Co‑Coding Portal</div>
          </div>
        </div>
        <nav class="nav" id="nav"></nav>

        <div class="presence" id="presence">
          <div><strong>Presence</strong> <span class="muted">/ live metrics</span></div>
          <div class="row" style="margin-top: 8px">
            <span class="chip ok" id="p-api">API</span>
            <span class="chip ok" id="p-llm">LLM</span>
            <span class="chip warn" id="p-sock">Socket</span>
          </div>
          <div class="k" style="margin-top: 8px">
            ⌘/Ctrl + K to switch views • <span id="version"></span>
          </div>
        </div>
      </aside>

      <!-- Header -->
      <header class="header">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path
              d="M21 21l-4.2-4.2M10.8 18A7.2 7.2 0 1010.8 3.6a7.2 7.2 0 000 14.4z"
              stroke="rgba(255,255,255,.7)"
            />
          </svg>
          <input id="globalSearch" placeholder="Search projects, agents, datasets…" />
          <button class="btn" id="btnSearch">Search</button>
        </div>
        <div style="margin-left: auto" class="row">
          <button class="btn" id="btnLogout" title="Sign out">Logout</button>
          <button class="btn acc" id="btnMint" title="Mint RoadCoin">Mint RC</button>
        </div>
      </header>

      <!-- Main -->
      <main class="main" id="main"></main>
    </div>

    <!-- Login Gate -->
    <div class="gate" id="gate">
      <div class="panel">
        <h2 style="margin: 0 0 12px 0">Sign in to BlackRoad</h2>
        <p class="muted" style="margin: 0 0 12px 0">
          Cookie‑session auth via API. Use your dev credentials.
        </p>
        <label class="k">Username</label>
        <input id="u" autocomplete="username" />
        <div class="row">
          <div style="flex: 1">
            <label class="k">Password</label>
            <input id="p" type="password" autocomplete="current-password" />
          </div>
          <div>
            <label class="k"> </label>
            <button class="btn acc" id="btnLogin">Login</button>
          </div>
        </div>
        <p class="k">
          Dev note: defaults (if enabled) → <code class="kbd">root / Codex2025</code>.
        </p>
        <p class="k">
          If login fails, ensure Nginx proxies <code>/api</code> to the Node API and cookies are
          allowed.
        </p>
      </div>
    </div>

    <!-- Socket.IO (optional presence) -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" defer></script>

    <script>
      (function () {
        const routes = [
          ['chat', 'Chat'],
          ['canvas', 'Canvas'],
          ['editor', 'Editor'],
          ['terminal', 'Terminal'],
          ['roadview', 'RoadView'],
          ['backroad', 'BackRoad'],
          ['projects', 'Projects'],
          ['agents', 'Agents'],
          ['datasets', 'Datasets'],
          ['models', 'Models'],
          ['integrations', 'Integrations'],
        ];

        const qs = (s) => document.querySelector(s);
        const elNav = qs('#nav');
        const elMain = qs('#main');
        const elGate = qs('#gate');

        // Version stamp
        qs('#version').textContent = 'v1.0 ' + new Date().toISOString().split('T')[0];

        // --- Navigation
        routes.forEach(([key, label]) => {
          const b = document.createElement('button');
          b.textContent = label;
          b.dataset.key = key;
          b.onclick = () => navigate(key);
          elNav.appendChild(b);
        });

        function setActive(key) {
          [...elNav.querySelectorAll('button')].forEach((btn) => {
            btn.classList.toggle('active', btn.dataset.key === key);
          });
        }

        window.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
            e.preventDefault();
            const keys = routes.map((r) => r[0]);
            const now = location.hash.replace(/^#\//, '') || keys[0];
            const idx = keys.indexOf(now);
            const nxt = keys[(idx + 1) % keys.length];
            navigate(nxt);
          }
        });

        // --- Auth & API helpers
        const API = {
          base: '',
          async get(path) {
            const r = await fetch(API.base + path, { credentials: 'include' });
            if (!r.ok) throw new Error((await safeText(r)) || r.statusText);
            return r.json();
          },
          async post(path, body) {
            const r = await fetch(API.base + path, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body || {}),
            });
            if (!r.ok) throw new Error((await safeText(r)) || r.statusText);
            try {
              return await r.json();
            } catch {
              return {};
            }
          },
          async del(path) {
            const r = await fetch(API.base + path, { method: 'DELETE', credentials: 'include' });
            if (!r.ok) throw new Error((await safeText(r)) || r.statusText);
            try {
              return await r.json();
            } catch {
              return {};
            }
          },
        };

        async function safeText(r) {
          try {
            return await r.text();
          } catch {
            return '';
          }
        }

        async function checkSession() {
          // Prefer /api/session; fallback /api/auth/session
          try {
            return await API.get('/api/session');
          } catch {
            try {
              return await API.get('/api/auth/session');
            } catch (e) {
              return null;
            }
          }
        }

        async function login(u, p) {
          try {
            return await API.post('/api/login', { username: u, password: p });
          } catch (e) {
            // Fallback optional path
            return await API.post('/api/auth/login', { username: u, password: p });
          }
        }

        async function logout() {
          try {
            await API.post('/api/logout');
          } catch {
            try {
              await API.post('/api/auth/logout');
            } catch {}
          }
        }

        // --- Presence checks
        async function ping(path) {
          try {
            const r = await fetch(path, { method: 'HEAD', credentials: 'include' });
            return r.ok;
          } catch {
            return false;
          }
        }

        async function initPresence() {
          const apiOK = await ping('/api/health').catch(() => false);
          document.getElementById('p-api').classList.toggle('ok', apiOK);
          document.getElementById('p-api').classList.toggle('warn', !apiOK);
          document.getElementById('p-api').textContent = apiOK ? 'API ✓' : 'API ?';

          // LLM ping via lightweight POST (may still be false if model not warmed)
          try {
            const r = await fetch('/api/llm/chat', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                messages: [{ role: 'user', content: 'ping' }],
                stream: false,
                max_tokens: 2,
              }),
            });
            const ok = r.ok;
            document.getElementById('p-llm').classList.toggle('ok', ok);
            document.getElementById('p-llm').classList.toggle('warn', !ok);
            document.getElementById('p-llm').textContent = ok ? 'LLM ✓' : 'LLM ?';
          } catch {
            document.getElementById('p-llm').classList.remove('ok');
            document.getElementById('p-llm').classList.add('warn');
            document.getElementById('p-llm').textContent = 'LLM ?';
          }

          // Socket.IO
          try {
            const ioClient = window.io ? window.io() : null;
            if (ioClient) {
              ioClient.on('connect', () => {
                const el = document.getElementById('p-sock');
                el.classList.remove('warn');
                el.classList.add('ok');
                el.textContent = 'Socket ✓';
              });
              ioClient.on('disconnect', () => {
                const el = document.getElementById('p-sock');
                el.classList.remove('ok');
                el.classList.add('warn');
                el.textContent = 'Socket ?';
              });
            }
          } catch {}
        }

        // --- Views
        const Views = {
          chat() {
            setActive('chat');
            elMain.innerHTML = `
          <div class="two-col">
            <section class="card chat-wrap">
              <div id="chatStream" class="chat-stream mono" aria-live="polite"></div>
              <div class="input-row">
                <textarea id="chatInput" class="input" placeholder="Ask Lucidia / Codex..."></textarea>
                <button class="btn acc" id="btnSend">Send</button>
              </div>
            </section>
            <section class="card">
              <h3 style="margin-top:0">Session Notes</h3>
              <textarea id="notes" class="editor-area" placeholder="Scratchpad…"></textarea>
              <div class="row" style="margin-top:10px">
                <button class="btn" id="btnSaveNotes">Save</button>
                <span class="k">Saved locally. (Wire to /api/notes when ready.)</span>
              </div>
            </section>
          </div>
        `;
            qs('#btnSend').onclick = sendChat;
            qs('#btnSaveNotes').onclick = () =>
              localStorage.setItem('br_notes', qs('#notes').value);
            qs('#notes').value = localStorage.getItem('br_notes') || '';
          },

          canvas() {
            setActive('canvas');
            elMain.innerHTML = `
          <section class="card">
            <h3 style="margin-top:0">Canvas</h3>
            <canvas id="board" class="canvas-board"></canvas>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="clear">Clear</button>
              <span class="k">Simple sketch board for flow diagrams.</span>
            </div>
          </section>
        `;
            const c = qs('#board');
            const ctx = c.getContext('2d');
            const fit = () => {
              c.width = c.clientWidth;
              c.height = c.clientHeight;
            };
            new ResizeObserver(fit).observe(c.parentElement);
            fit();
            let down = false,
              last = null;
            c.addEventListener('pointerdown', (e) => {
              down = true;
              last = [e.offsetX, e.offsetY];
            });
            c.addEventListener('pointerup', () => {
              down = false;
              last = null;
            });
            c.addEventListener('pointermove', (e) => {
              if (!down) return;
              ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue(
                '--accent'
              );
              ctx.lineWidth = 2.0;
              ctx.lineCap = 'round';
              ctx.beginPath();
              ctx.moveTo(last[0], last[1]);
              ctx.lineTo(e.offsetX, e.offsetY);
              ctx.stroke();
              last = [e.offsetX, e.offsetY];
            });
            qs('#clear').onclick = () => ctx.clearRect(0, 0, c.width, c.height);
          },

          editor() {
            setActive('editor');
            elMain.innerHTML = `
          <section class="card">
            <h3 style="margin-top:0">Editor</h3>
            <textarea id="code" class="editor-area mono" spellcheck="false" placeholder="Paste code for Codex review…"></textarea>
            <div class="row" style="margin-top:10px">
              <button class="btn acc" id="run">Ask Codex</button>
              <button class="btn" id="fmt">Format</button>
              <span class="k">Client-only placeholder. Wire to /api/actions/run when backend ready.</span>
            </div>
            <pre id="out" class="mono" style="margin-top:10px"></pre>
          </section>
        `;
            qs('#run').onclick = async () => {
              const src = qs('#code').value;
              qs('#out').textContent = 'Sending to /api/actions/run (stub)…';
              try {
                const r = await API.post('/api/actions/run', { source: src });
                qs('#out').textContent = JSON.stringify(r, null, 2);
              } catch (e) {
                qs('#out').textContent = 'Run disabled or endpoint missing.';
              }
            };
            qs('#fmt').onclick = () => {
              const t = qs('#code');
              t.value = t.value.replace(/\t/g, '  ').trimEnd() + '\n';
            };
          },

          terminal() {
            setActive('terminal');
            elMain.innerHTML = `
          <section class="card">
            <h3 style="margin-top:0">Terminal</h3>
            <div class="mono" id="term" style="white-space:pre-wrap; border:1px solid var(--border); border-radius:8px; padding:12px; background:#0d1219; height:50vh; overflow:auto">Shell disabled (ALLOW_SHELL=false). Enable on server to activate.</div>
            <div class="row" style="margin-top:10px">
              <input id="cmd" class="editor-area mono" style="min-height:42px; height:42px" placeholder="whoami" />
              <button class="btn" id="exec">Exec</button>
            </div>
            <p class="k">When enabled: POST /api/exec {cmd}, stream output over Socket.IO.</p>
          </section>
        `;
            qs('#exec').onclick = async () => {
              const cmd = qs('#cmd').value.trim();
              if (!cmd) return;
              const el = qs('#term');
              el.textContent += '\n$ ' + cmd + '\n';
              try {
                const r = await API.post('/api/exec', { cmd });
                el.textContent += r && r.out ? r.out : '(no output)\n';
              } catch {
                el.textContent += '(exec disabled)\n';
              }
              el.scrollTop = el.scrollHeight;
            };
          },

          roadview() {
            setActive('roadview');
            elMain.innerHTML = viewList('Roads / Flows', 'projects');
          },
          backroad() {
            setActive('backroad');
            elMain.innerHTML = viewList('BackRoad / Pipelines', 'pipelines');
          },

          projects() {
            setActive('projects');
            renderCRUD('projects');
          },
          agents() {
            setActive('agents');
            renderCRUD('agents');
          },
          datasets() {
            setActive('datasets');
            renderCRUD('datasets');
          },
          models() {
            setActive('models');
            renderCRUD('models');
          },
          integrations() {
            setActive('integrations');
            renderCRUD('integrations');
          },
        };

        function viewList(title, key) {
          return `
        <section class="card">
          <h3 style="margin-top:0">${title}</h3>
          <div id="list-${key}">Loading…</div>
        </section>
      `;
        }

        async function renderCRUD(kind) {
          elMain.innerHTML = `
        <section class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">${uc(kind)}</h3>
            <button class="btn acc" id="new">New ${uc(kind).slice(0, -1)}</button>
          </div>
          <div id="wrap">
            <table>
              <thead><tr><th>ID</th><th>Name</th><th>Updated</th><th style="width:180px">Actions</th></tr></thead>
              <tbody id="tbody"><tr><td colspan="4">Loading…</td></tr></tbody>
            </table>
          </div>
        </section>
      `;
          const tbody = qs('#tbody');
          try {
            const rows = await API.get(`/api/${kind}`);
            tbody.innerHTML =
              (rows || [])
                .map(
                  (r) => `
            <tr>
              <td class="mono">${r.id ?? ''}</td>
              <td>${r.name ?? ''}</td>
              <td class="k">${r.updated_at ?? ''}</td>
              <td>
                <button class="btn" data-id="${r.id}" data-act="edit">Edit</button>
                <button class="btn" data-id="${r.id}" data-act="delete">Delete</button>
              </td>
            </tr>
        `
                )
                .join('') || `<tr><td colspan="4">No data.</td></tr>`;
          } catch {
            tbody.innerHTML = `<tr><td colspan="4">Endpoint /api/${kind} unavailable.</td></tr>`;
          }

          elMain.querySelector('#new').onclick = async () => {
            const name = prompt('Name');
            if (!name) return;
            try {
              await API.post(`/api/${kind}`, { name });
              navigate(kind); // reload view
            } catch (e) {
              alert('Create failed.');
            }
          };

          elMain.addEventListener(
            'click',
            async (e) => {
              const t = e.target.closest('button[data-act]');
              if (!t) return;
              const id = t.dataset.id;
              if (t.dataset.act === 'delete') {
                if (!confirm('Delete item ' + id + '?')) return;
                try {
                  await API.del(`/api/${kind}/${id}`);
                  navigate(kind);
                } catch {
                  alert('Delete failed.');
                }
              }
              if (t.dataset.act === 'edit') {
                const name = prompt('New name');
                if (!name) return;
                try {
                  await API.post(`/api/${kind}/${id}`, { name });
                  navigate(kind);
                } catch {
                  alert('Update failed.');
                }
              }
            },
            { once: true }
          );
        }

        function uc(s) {
          return (s || '').charAt(0).toUpperCase() + s.slice(1);
        }

        // --- Chat logic (streaming)
        async function sendChat() {
          const input = qs('#chatInput');
          const stream = qs('#chatStream');
          const text = (input.value || '').trim();
          if (!text) return;

          addBubble(stream, text, 'user');
          input.value = '';
          input.focus();

          // Create assistant bubble and stream into it
          const ai = addBubble(stream, '', 'ai');
          stream.scrollTop = stream.scrollHeight;

          try {
            const r = await fetch('/api/llm/chat', {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ messages: [{ role: 'user', content: text }], stream: true }),
            });

            if (!r.ok || !r.body) {
              ai.textContent = '(chat error)';
              return;
            }

            const reader = r.body.getReader();
            const dec = new TextDecoder();
            let done, chunk;
            while (true) {
              ({ done, value: chunk } = await reader.read());
              if (done) break;
              ai.textContent += dec.decode(chunk, { stream: true });
              stream.scrollTop = stream.scrollHeight;
            }
          } catch {
            ai.textContent = '(no response)';
          }
        }

        function addBubble(stream, text, who) {
          const b = document.createElement('div');
          b.className = 'bubble ' + (who === 'user' ? 'user' : 'ai');
          b.textContent = text;
          stream.appendChild(b);
          return b;
        }

        // --- Routing
        function navigate(key) {
          history.replaceState(null, '', '#/' + key);
          (Views[key] || Views.chat)();
        }

        window.addEventListener('hashchange', () => {
          const k = location.hash.replace(/^#\//, '') || 'chat';
          (Views[k] || Views.chat)();
        });

        // --- Search
        qs('#btnSearch').onclick = () => {
          const q = qs('#globalSearch').value.trim();
          if (!q) {
            alert('Enter a query');
            return;
          }
          navigate('projects');
          // As an example, filter on client after fetch; server-side search can replace this.
          setTimeout(() => {
            alert("Search stub: '" + q + "' — wire to /api/search");
          }, 0);
        };

        // --- Auth flows
        (async function boot() {
          // Presence pings (non-fatal)
          initPresence();

          const sess = await checkSession();
          if (!sess || !sess.user) {
            elGate.style.display = 'grid';
          } else {
            elGate.style.display = 'none';
          }
          // default route
          const initial = location.hash.replace(/^#\//, '') || 'chat';
          navigate(initial);
        })();

        qs('#btnLogin').onclick = async () => {
          const u = qs('#u').value.trim();
          const p = qs('#p').value;
          try {
            await login(u, p);
            elGate.style.display = 'none';
            navigate('chat');
          } catch (e) {
            alert('Login failed. Check API / Nginx / credentials.');
          }
        };

        qs('#btnLogout').onclick = async () => {
          await logout();
          elGate.style.display = 'grid';
        };

        // Mint RC (stub)
        qs('#btnMint').onclick = async () => {
          try {
            const r = await API.post('/api/actions/mint', { amount: 1 });
            alert('Mint result: ' + JSON.stringify(r));
          } catch {
            alert('Mint endpoint not yet enabled.');
          }
        };
      })();
    </script>
  </body>
</html>
