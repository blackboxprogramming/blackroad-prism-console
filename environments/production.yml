name: production
slug: prod
state: active
description: >-
  Primary public environment exposed to customers via blackroad.io. Static
  assets publish through GitHub Pages while the API gateway deploys via the
  `BlackRoad • Deploy` workflow.
contacts:
  reviewers:
    - blackboxprogramming
  slack: "#eng"
domains:
  marketing: https://blackroad.io
  canonical: https://www.blackroad.io
  api: https://api.blackroad.io
  status: https://status.blackroad.io
infrastructure:
  cloud: aws
  region: us-west-2
  terraform:
    root: br-infra-iac/envs/prod
    backend:
      bucket: br-tfstate-<unique>
      key: prod/terraform.tfstate
      region: us-west-2
      lock_table: br-terraform-lock
    modules:
      - modules/network
      - modules/ecs-cluster
      - modules/ecr
      - modules/rds-postgres
    outputs:
      - ecs_cluster
      - private_subnets
      - db_endpoint
    repositories:
      - br-api-gateway
      - br-products-site
automation:
  workflows:
    - name: BlackRoad • Deploy
      file: .github/workflows/blackroad-deploy.yml
      triggers:
        - push (main)
        - workflow_dispatch
      summary: >-
        Builds the SPA, packages the API, triggers the deploy webhook, verifies
        health, and posts Slack status updates.
      secrets:
        - BR_DEPLOY_SECRET
        - BR_DEPLOY_URL
        - CF_ZONE_ID
        - CF_API_TOKEN
        - SLACK_WEBHOOK_URL
deployments:
  - service: marketing-site
    type: static-site
    provider: github-pages
    repo: blackboxprogramming/blackroad-prism-console
    workflow: .github/workflows/blackroad-deploy.yml
    artifacts:
      path: sites/blackroad
    domain: https://blackroad.io
    health_check: https://blackroad.io/healthz
  - service: api-gateway
    type: container-service
    provider: aws-ecs-fargate
    terraform_directory: br-infra-iac/envs/prod
    module: modules/ecs-service-alb
    state: planned
    notes: >-
      Production wiring follows the dev module that provisions api.blackroad.io
      behind an ALB-backed Fargate service.
    health_check: https://api.blackroad.io/health
    workflow: .github/workflows/blackroad-deploy.yml
  - service: ollama-bridge
    type: container-service
    provider: fly-io
    app: blackroad-ollama-bridge
    workflow: .github/workflows/ollama-bridge-deploy.yml
    domain: https://blackroad-ollama-bridge.fly.dev
    health_check: https://blackroad-ollama-bridge.fly.dev/api/llm/health
    environment:
      MODEL_DEFAULT: qwen2:1.5b
    secrets:
      - FLY_API_TOKEN
      - OLLAMA_BASE_URL
    notes: >-
      Runs the lightweight bridge between the Prism console and remote Ollama
      instances. Deployed via Fly.io using the dedicated GitHub Actions workflow
      with health verification.
change_management:
  approvals:
    - .github/workflows/change-approve.yml
  runbooks:
    - README-DEPLOY.md
    - README-OPS.md
    - RUNBOOKS/01_ollama_bridge_rollforward.md
observability:
  health_checks:
    - name: frontend
      url: https://blackroad.io/healthz
    - name: api
      url: https://api.blackroad.io/health
    - name: ollama-bridge
      url: https://blackroad-ollama-bridge.fly.dev/api/llm/health
  scripts:
    - scripts/blackroad-autoheal.sh
