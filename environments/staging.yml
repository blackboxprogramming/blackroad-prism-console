name: staging
slug: stg
state: provisioning
description: >-
  Pre-production environment for QA. Static assets publish to stage.blackroad.io
  while AWS infrastructure scaffolding mirrors production.
contacts:
  slack: "#eng"
domains:
  marketing: https://stage.blackroad.io
infrastructure:
  cloud: aws
  region: us-west-2
  availability_zones:
    - us-west-2a
    - us-west-2b
  network:
    vpc_cidr: 10.30.0.0/16
  terraform:
    root: br-infra-iac/envs/stg
    backend:
      bucket: br-tfstate-<unique>
      key: stg/terraform.tfstate
      region: us-west-2
      lock_table: br-terraform-lock
    modules:
      - modules/network
      - modules/ecs-cluster
      - modules/ecr
      - modules/rds-postgres
    variables:
      rds_instance_class: db.t4g.small
      rds_multi_az: false
      rds_backup_retention_days: 14
    outputs:
      - vpc_id
      - private_subnets
      - ecs_cluster
      - db_endpoint
    repositories:
      - br-api-gateway
      - br-products-site
automation:
  workflows:
    - name: Stage Proof Artifact
      file: .github/workflows/pages-stage.yml
      triggers:
        - push (main, blackroad-stage/**)
        - schedule (daily 06:05 UTC)
        - workflow_dispatch
      summary: >-
        Generates a proof payload, bakes stage assets, and archives the build
        without publishing DNS changes.
      secrets:
        - AWAKEN_SEED
  notifications:
    slack_channel: "#eng"
deployments:
  - service: marketing-site
    type: static-site
    provider: github-pages
    repo: blackboxprogramming/blackroad-prism-console
    workflow: .github/workflows/pages-stage.yml
    artifacts:
      path: blackroad-stage
    domain: https://stage.blackroad.io
    health_check: https://stage.blackroad.io/health.json
  - service: api-gateway
    type: container-service
    provider: aws-ecs-fargate
    terraform_directory: br-infra-iac/envs/stg
    module: modules/ecs-service-alb
    state: planned
    notes: >-
      Network, ECS, and RDS resources are defined; service wiring will follow the
      production module once ready.
    image_repository: br-api-gateway
    scaling:
      desired_count: 1
      min_capacity: 1
      max_capacity: 2
    environment:
      NODE_ENV: staging
change_management:
  approvals:
    - .github/workflows/change-approve.yml
observability:
  health_checks:
    - name: static-health
      url: https://stage.blackroad.io/health.json
  commands:
    - aws ecs describe-services --cluster <cluster-arn> --services api-gateway --region us-west-2
