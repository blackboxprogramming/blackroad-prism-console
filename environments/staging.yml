name: staging
slug: stg
state: active
description: >-
  Pre-production environment that mirrors production wiring for QA, release
  rehearsals, and policy validation before promoting to main.
branch: staging
contacts:
  slack: "#eng"
domains:
  primary: https://stage.blackroad.io
infrastructure:
  cloud: aws
  region: us-west-2
  availability_zones:
    - us-west-2a
    - us-west-2b
  network:
    vpc_cidr: 10.30.0.0/16
  terraform:
    root: br-infra-iac/envs/stg
    backend:
      bucket: br-tfstate-<unique>
      key: stg/terraform.tfstate
      region: us-west-2
      lock_table: br-terraform-lock
    modules:
      - modules/network
      - modules/ecs-cluster
      - modules/ecr
      - modules/rds-postgres
automation:
  required_checks:
    push:
      staging:
        - Stage Proof Artifact
        - stage-stress (when STRESS=true)
  workflows:
    - name: Stage Proof Artifact
      file: .github/workflows/pages-stage.yml
      triggers:
        - push (staging, paths: blackroad-stage/**, sites/blackroad/**)
        - schedule (daily 06:05 UTC)
        - workflow_dispatch
      summary: >-
        Generates the static proof artifact for stage.blackroad.io and archives
        it as a required check before production promotion.
      secrets_required:
        - AWAKEN_SEED
    - name: Stage Stress (safe)
      file: .github/workflows/stage-stress.yml
      triggers:
        - workflow_dispatch (STRESS input)
        - push (staging, paths: blackroad-stage/**)
      summary: >-
        Optional load test harness gated behind the STRESS input for release
        rehearsals.
      notes: Requires explicit opt-in; defaults to a no-op.
    - name: Reusable AWS ECS deploy
      file: .github/workflows/reusable-aws-ecs-deploy.yml
      triggers:
        - workflow_call
      summary: Shared harness that registers a task definition revision and
        deploys staging ECS services.
      secrets_required:
        - AWS_STAGING_DEPLOY_ROLE_ARN
        - AWS_STAGING_EXTERNAL_ID
deployments:
  - service: marketing-site
    type: static-site
    provider: github-pages
    workflow: .github/workflows/pages-stage.yml
    artifact_path: blackroad-stage
    domain: https://stage.blackroad.io
    health_check: https://stage.blackroad.io/health.json
    state: active
  - service: api-gateway
    type: container-service
    provider: aws-ecs-fargate
    terraform_directory: br-infra-iac/envs/stg
    terraform_backend:
      bucket: br-tfstate-<unique>
      key: stg/terraform.tfstate
      region: us-west-2
      lock_table: br-terraform-lock
    module: modules/ecs-service-alb
    state: planned
    notes: >-
      Cluster, subnets, and RDS resources exist; wiring mirrors production once
      the API promotion is enabled.
    image_repository: br-api-gateway
    scaling:
      desired_count: 1
      min_capacity: 1
      max_capacity: 2
    environment:
      NODE_ENV: staging
change_management:
  approvals:
    - .github/workflows/change-approve.yml
  policy_gates:
    - name: release-runbook
      description: Run the infra release policy before cutting over to prod.
      runbook: runbooks/examples/infra_release_policy.yaml
observability:
  health_checks:
    - https://stage.blackroad.io/health.json
    - curl -fsS https://api.staging.blackroad.io/api/llm/health
notes:
  - Exercise the autopal environment access workflow when dual control is
    required.
