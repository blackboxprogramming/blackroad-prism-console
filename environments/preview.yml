name: preview
slug: pr
state: active
description: >-
  Ephemeral review environments created per pull request on AWS ECS Fargate.
  Each PR receives a dedicated hostname under dev.blackroad.io and tears down
  automatically when the PR closes.
contacts:
  slack: "#eng"
domains:
  root: https://dev.blackroad.io
  pattern: https://pr-<pr-number>.dev.blackroad.io
infrastructure:
  cloud: aws
  region: us-east-1
  terraform:
    root: infra/preview-env
    module: modules/preview-env
    backend:
      bucket_secret: PREVIEW_ENV_TF_STATE_BUCKET
      key_pattern: preview/pr-<pr-number>.tfstate
      lock_table_secret: PREVIEW_ENV_TF_LOCK_TABLE
      region: us-east-1
    outputs:
      - preview_url
      - service_name
automation:
  workflows:
    - name: preview-environment
      file: .github/workflows/preview-env.yml
      triggers:
        - pull_request (opened, reopened, synchronize, closed)
      summary: >-
        Builds a PR-specific image, applies the preview Terraform stack, posts
        the URL to GitHub and Slack, and tears the stack down on close.
      secrets:
        - PREVIEW_ENV_AWS_ROLE
        - PREVIEW_ENV_ECR_REGISTRY
        - PREVIEW_ENV_ECR_REPOSITORY
        - PREVIEW_ENV_CLUSTER_ARN
        - PREVIEW_ENV_EXECUTION_ROLE_ARN
        - PREVIEW_ENV_TASK_ROLE_ARN
        - PREVIEW_ENV_PRIVATE_SUBNET_IDS
        - PREVIEW_ENV_PUBLIC_SUBNET_IDS
        - PREVIEW_ENV_VPC_ID
        - PREVIEW_ENV_HOSTED_ZONE_ID
        - PREVIEW_ENV_VARS_JSON
        - PREVIEW_ENV_SECRETS_JSON
        - PREVIEW_ENV_TF_STATE_BUCKET
        - PREVIEW_ENV_TF_LOCK_TABLE
        - SLACK_PREVIEW_CHANNEL
        - SLACK_BOT_TOKEN
    - name: PR Preview Containers
      file: .github/workflows/preview-containers.yml
      triggers:
        - pull_request (opened, reopened, synchronize, ready_for_review)
      summary: >-
        Builds and publishes GHCR container images for each PR, generating SBOMs
        and vulnerability reports plus a sticky comment with pull instructions.
    - name: Cleanup Preview Containers
      file: .github/workflows/preview-containers-cleanup.yml
      triggers:
        - pull_request (closed)
      summary: >-
        Removes the GHCR image tags created for preview containers once the pull
        request closes to avoid stale registries and unnecessary storage costs.
    - name: preview-frontend-host
      file: .github/workflows/preview-frontend-host.yml
      triggers:
        - pull_request (opened, reopened, synchronize, closed)
      summary: >-
        Provisions or tears down ECS services behind the dev.blackroad.io ALB for
        frontend-only previews, wiring Route53 records and listener rules per PR.
      secrets:
        - AWS_ROLE_TO_ASSUME
      variables:
        - AWS_REGION
        - ECR_REPO
        - ECS_CLUSTER
        - VPC_ID
        - SUBNETS
        - SERVICE_SG
        - ALB_ARN
        - HTTPS_LISTENER_ARN
        - ALB_ZONE_ID
        - ALB_DNS
        - HOSTED_ZONE_ID
        - CONTAINER_PORT
deployments:
  - service: web-console
    type: container-service
    provider: aws-ecs-fargate
    workflow: .github/workflows/preview-env.yml
    terraform_directory: infra/preview-env
    terraform_backend:
      bucket_secret: PREVIEW_ENV_TF_STATE_BUCKET
      lock_table_secret: PREVIEW_ENV_TF_LOCK_TABLE
      key_template: preview/pr-<pr-number>.tfstate
    domain_pattern: https://pr-<pr-number>.dev.blackroad.io
    health_check: https://pr-<pr-number>.dev.blackroad.io/health
    environment:
      AWS_REGION: us-east-1
      PREVIEW_DOMAIN: dev.blackroad.io
    secrets:
      - PREVIEW_ENV_AWS_ROLE
      - PREVIEW_ENV_ECR_REGISTRY
      - PREVIEW_ENV_ECR_REPOSITORY
      - PREVIEW_ENV_CLUSTER_ARN
      - PREVIEW_ENV_EXECUTION_ROLE_ARN
      - PREVIEW_ENV_TASK_ROLE_ARN
      - PREVIEW_ENV_PRIVATE_SUBNET_IDS
      - PREVIEW_ENV_PUBLIC_SUBNET_IDS
      - PREVIEW_ENV_VPC_ID
      - PREVIEW_ENV_HOSTED_ZONE_ID
      - PREVIEW_ENV_VARS_JSON
      - PREVIEW_ENV_SECRETS_JSON
      - SLACK_PREVIEW_CHANNEL
      - SLACK_BOT_TOKEN
    notifications:
      slack:
        channel_secret: SLACK_PREVIEW_CHANNEL
        token_secret: SLACK_BOT_TOKEN
change_management:
  approvals: []
observability:
  verification:
    - terraform output -raw preview_url
    - aws ecs describe-services --cluster <cluster-arn> --services pr-<pr-number> --region us-east-1
