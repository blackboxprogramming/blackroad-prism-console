<!-- FILE: /var/www/blackroad/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlackRoad.io</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2318253a'/%3E%3Cpath d='M16 40C24 20 40 20 48 40' stroke='%23ff4fd8' stroke-width='6' fill='none'/%3E%3C/svg%3E" />
  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Styled Components UMD for CSS-in-JS -->
  <script crossorigin src="https://unpkg.com/styled-components/dist/styled-components.min.js"></script>
  <!-- Babel for in-browser JSX transform -->
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --subpanel:#0b1324; --text:#e2e8f0; --muted:#9aa4b2; --border:#1f2a44;
      /* BlackRoad brand */
      --accent:#FF4FD8; --accent-2:#0096FF; --accent-3:#FDBA2D;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444; --shadow:0 6px 30px rgba(0,0,0,.35); --radius:16px;
    }
    html, body, #root { height: 100%; }
    body{ margin:0; background:
      radial-gradient(1200px 900px at 80% -10%, rgba(255,79,216,.20), transparent 40%),
      radial-gradient(1000px 800px at -20% 100%, rgba(0,150,255,.16), transparent 50%),
      var(--bg);
      color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
    *{ box-sizing: border-box }
    .hl-key{ color:#93c5fd } .hl-str{ color:#f472b6 } .hl-num{ color:#f59e0b } .hl-com{ color:#64748b; font-style:italic } .hl-fn{ color:#22d3ee }
    .tag{ display:inline-flex; gap:.5rem; align-items:center; padding:.2rem .6rem; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:.8rem }
    .dot{ width:.5rem; height:.5rem; border-radius:1rem; background:var(--muted) }
    .btn{ appearance:none; background:#121a30; border:1px solid var(--border); color:var(--text); padding:.55rem .9rem; border-radius:.75rem; cursor:pointer; box-shadow:var(--shadow); transition: all .2s ease; }
    .btn:hover{ transform: translateY(-1px); border-color:#29406c }
    .btn.primary{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#0b1220; font-weight:700; }
    .btn.ghost{ background: transparent }
    .btn.small{ padding:.35rem .6rem; font-size:.85rem }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--border); padding:.2rem .5rem; border-radius:.6rem; font-size:.8rem; color:var(--muted) }
    .co-btn { background: conic-gradient(from 180deg at 50% 50%, var(--accent-3), var(--accent), var(--accent-2), var(--accent-3)); color:#0b1220; font-weight:800; border:none; border-radius:20px; padding:1.05rem 1.2rem; box-shadow: 0 10px 40px rgba(255,79,216,.35); transition: transform .2s ease, filter .2s ease; cursor:pointer; width:100%; }
    .co-btn:hover{ transform: translateY(-2px); filter: brightness(1.05) }
    ::-webkit-scrollbar{ width:10px; height:10px } ::-webkit-scrollbar-thumb{ background:#1b2744; border-radius:8px } ::-webkit-scrollbar-track{ background:transparent }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const styled = window.styled;

    // -------- API helpers (server sessions) --------
    async function apiGet(p){ const r = await fetch(p,{credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function apiPost(p, body={}){ const r = await fetch(p,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function apiPut(p, body={}){ const r = await fetch(p,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(body)}); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    async function apiDel(p){ const r = await fetch(p,{method:'DELETE',credentials:'include'}); if(!r.ok) throw new Error(await r.text()); return r.json(); }

    // THEME & LAYOUT
    const theme = { colors: Object.fromEntries(['--bg','--panel','--subpanel','--text','--muted','--border','--accent','--accent-2','--accent-3','--good','--warn','--bad'].map(k=>[k.replace('--',''), getComputedStyle(document.documentElement).getPropertyValue(k)])), radius:'16px', shadow:'var(--shadow)' };
    const Shell = styled.div`display:flex; flex-direction:column; height:100%; width:100%;`;
    const Header = styled.header`display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom: 1px solid ${theme.colors.border}; background: rgba(8,14,28,.6); backdrop-filter: blur(8px); position:sticky; top:0; z-index:50;`;
    const Brand = styled.div`display:flex; align-items:center; gap:.8rem; font-weight:800; letter-spacing:.3px; font-size:1.05rem; .logo{ width:28px; height:28px; border-radius:7px; background: conic-gradient(from 45deg, var(--accent-3), var(--accent), var(--accent-2), var(--accent-3)); box-shadow:${theme.shadow}; }`;
    const NavTabs = styled.nav`display:flex; gap:.6rem; flex-wrap:wrap; .tab{ padding:.45rem .75rem; border-radius:10px; color:${theme.colors.muted}; border:1px solid transparent; cursor:pointer; transition:.2s; } .tab:hover{ color:${theme.colors.text}; border-color:${theme.colors.border}; background:#0e172a; } .tab.active{ color:#0b1220; background: linear-gradient(135deg, var(--accent), var(--accent-2)); font-weight:700 }`;
    const HeaderRight = styled.div`display:flex; align-items:center; gap:.6rem;`;
    const Body = styled.main`flex:1; display:grid; gap:14px; padding:14px; grid-template-columns: 260px 1fr 320px; @media (max-width: 1200px){ grid-template-columns: 230px 1fr 300px; } @media (max-width: 980px){ grid-template-columns: 1fr; }`;
    const Panel = styled.section`background: ${theme.colors.panel}; border:1px solid ${theme.colors.border}; border-radius:var(--radius); box-shadow:${theme.shadow}; display:flex; flex-direction:column; min-height:120px; overflow:hidden;`;
    const ColumnScroll = styled.div`overflow:auto; height: calc(100vh - 110px);`;
    const SideHeader = styled.div`padding:16px 16px 10px 16px; border-bottom: 1px solid ${theme.colors.border}; display:flex; align-items:center; gap:.6rem; font-size:.95rem; color:${theme.colors.muted}; text-transform:uppercase; letter-spacing:.12em;`;
    const SideList = styled.ul`list-style:none; margin:0; padding:6px; display:flex; flex-direction:column; gap:8px; li{ display:flex; align-items:center; gap:.6rem; padding:.6rem .7rem; border-radius:10px; cursor:pointer; color:${theme.colors.muted}; transition:.18s; } li:hover{ background:${theme.colors.subpanel}; color:${theme.colors.text}; } li.active{ color:${theme.colors.text}; background:#0e1a34; border:1px solid ${theme.colors.border}; }`;
    const FooterNote = styled.div`padding:14px; border-top:1px solid ${theme.colors.border}; color:${theme.colors.muted}; font-size:.85rem;`;
    const Tabs = styled.div`display:flex; gap:8px; padding:10px; border-bottom:1px solid ${theme.colors.border}; button{ background:transparent; border:1px solid transparent; color:${theme.colors.muted}; padding:.45rem .75rem; border-radius:10px; cursor:pointer } button:hover{ border-color:${theme.colors.border}; color:${theme.colors.text} } button.active{ color:#0b1220; font-weight:700; background:linear-gradient(135deg, var(--accent), var(--accent-2)); }`;
    const ContentScroll = styled.div`padding: 10px; overflow:auto; height: calc(100% - 54px);`;
    const Card = styled.div`border-top:1px solid ${theme.colors.border}; padding:12px 14px; display:flex; flex-direction:column; gap:10px;`;
    const SwitchWrap = styled.label`display:inline-flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none; input{ position:absolute; opacity:0 } .switch{ width:44px; height:24px; background:#14203b; border:1px solid ${theme.colors.border}; border-radius:20px; position:relative; transition:.2s } .switch::after{ content:""; position:absolute; width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg, var(--accent), var(--accent-2)); top:2px; left:2px; transition:.2s } input:checked + .switch{ background:#09122a } input:checked + .switch::after{ left:22px }`;

    // ------- Sparkline -------
    function Sparkline({ data, color = theme.colors['accent-2'] }){
      const ref = useRef(null);
      useEffect(()=>{
        const cvs = ref.current; if(!cvs) return; const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * devicePixelRatio; const h = cvs.height = cvs.clientHeight * devicePixelRatio;
        ctx.clearRect(0,0,w,h);
        const min = Math.min(...data), max = Math.max(...data);
        const norm = v => h - ( (v - min) / (max - min || 1) ) * (h-6) - 3;
        ctx.lineWidth = 2 * devicePixelRatio; ctx.strokeStyle = color; ctx.beginPath();
        data.forEach((v,i)=>{ const x = (i/(data.length-1)) * (w-6) + 3; const y = norm(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
        ctx.stroke();
      },[data,color]);
      return <div style={{width:'100%', height:36}}><canvas ref={ref} style={{width:'100%', height:'100%'}}/></div>
    }

    // ------- Syntax highlight -------
    function highlightJS(src){ const esc = src.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); let out = esc.replace(/(\/\*[\s\S]*?\*\/|\/\/.*$)/gm, '<span class="hl-com">$1<\/span>'); out = out.replace(/([`'\"])(?:(?!\1|\\).|\\.)*\1/gm, m=>`<span class="hl-str">${m}<\/span>`); out = out.replace(/\b(0x[\da-fA-F]+|\d+\.?\d*)\b/gm,'<span class="hl-num">$1<\/span>'); out = out.replace(/\b(const|let|var|function|return|if|else|for|while|class|new|try|catch|throw|await|async|import|from|export|switch|case|break|continue)\b/gm,'<span class="hl-key">$1<\/span>'); out = out.replace(/(\b[A-Za-z_][A-Za-z0-9_]*)(?=\s*\()/g,'<span class="hl-fn">$1<\/span>'); return out; }
    function CodeEditor({ value, onChange }){ const [code, setCode] = useState(value||''); useEffect(()=>setCode(value||''),[value]); const onInput = (e)=>{ setCode(e.target.value); onChange && onChange(e.target.value); }; return (
      <div style={{position:'relative', height:260, border:'1px solid var(--border)', borderRadius:'12px', overflow:'hidden', background:'#0b1324'}}>
        <pre aria-hidden style={{margin:0, position:'absolute', inset:0, pointerEvents:'none', padding:'12px 14px', fontFamily:'ui-monospace, Menlo, Monaco, Consolas', fontSize:13, lineHeight:1.6, color:'#c7d2fe', whiteSpace:'pre', overflow:'auto'}} dangerouslySetInnerHTML={{__html: highlightJS(code)}} />
        <textarea value={code} onChange={onInput} spellCheck={false} style={{position:'absolute', inset:0, resize:'none', padding:'12px 14px', fontFamily:'ui-monospace, Menlo, Monaco, Consolas', fontSize:13, lineHeight:1.6, color:'transparent', caretColor:'#93c5fd', background:'transparent', border:'none', outline:'none'}} />
        <div style={{position:'absolute', right:10, bottom:10, display:'flex', gap:6}}>
          <button className="btn small" onClick={()=>navigator.clipboard.writeText(code)}>Copy</button>
          <button className="btn small" onClick={()=>downloadText('snippet.js', code)}>Download</button>
        </div>
      </div>
    ); }
    function downloadText(filename, text){ const blob = new Blob([text], {type:'text/plain'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url); }

    function Terminal({ onCommand }){ const [lines, setLines] = useState([`Lucidia shell -- type 'help' to see commands.`]); const [input, setInput] = useState(''); const scrollRef = useRef(null); useEffect(()=>{ scrollRef.current && (scrollRef.current.scrollTop = scrollRef.current.scrollHeight); },[lines]); const run = async (cmd)=>{ const out = await onCommand(cmd); setLines(l => [...l, `> ${cmd}`, ...(Array.isArray(out)?out:[String(out)]) ]); }; const onKey = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); const cmd = input.trim(); if(cmd) run(cmd); setInput(''); } }; return (
      <div style={{border:'1px solid var(--border)', borderRadius:'12px', background:'#0b1324', display:'flex', flexDirection:'column', height:300}}>
        <div ref={scrollRef} style={{flex:1, overflow:'auto', padding:'10px 12px', fontFamily:'ui-monospace, Menlo, Monaco, Consolas', fontSize:13}}>
          {lines.map((l,i)=> <div key={i} style={{color: l.startsWith('!')? 'var(--bad)': '#cbd5e1'}}>{l}</div>)}
        </div>
        <div style={{display:'flex', gap:8, padding:8, borderTop:'1px solid var(--border)'}}>
          <span className="tag"><span className="dot" style={{background:'var(--good)'}}></span> ready</span>
          <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={onKey} placeholder="Type a command…" style={{flex:1, background:'#09122a', border:'1px solid var(--border)', borderRadius:10, color:'var(--text)', padding:'8px 10px'}} />
          <button className="btn" onClick={()=>{ const cmd = input.trim(); if(cmd){ run(cmd); setInput(''); }}}>Run</button>
        </div>
      </div>
    ); }

    function ActivityItem({ item, onOpen }){ return (
      <div onClick={()=>onOpen(item)} style={{border:'1px solid var(--border)', background:'#0b1324', padding:'10px 12px', borderRadius:12, display:'flex', gap:10, alignItems:'flex-start', cursor:'pointer'}}>
        <div className="dot" style={{background:item.kind==='build'? 'var(--accent-2)': item.kind==='commit'? 'var(--good)': item.kind==='revert'? 'var(--bad)': 'var(--accent)'}}></div>
        <div style={{flex:1}}>
          <div style={{display:'flex', justifyContent:'space-between', gap:8}}>
            <div style={{fontWeight:700}}>{item.title}</div>
            <div className="chip">{item.time||''}</div>
          </div>
          <div style={{color:'var(--muted)', marginTop:4}}>{item.desc||''}</div>
          {item.code && (
            <pre style={{marginTop:8, padding:10, background:'#09122a', border:'1px solid var(--border)', borderRadius:10, overflow:'auto', maxHeight:140}}>
              <code dangerouslySetInnerHTML={{__html: highlightJS(item.code)}}></code>
            </pre>
          )}
          <div style={{display:'flex', gap:8, marginTop:8}}>
            {(item.actions||[]).map(a => <button key={a} className="btn small" onClick={(e)=>{e.stopPropagation(); item.onAction && item.onAction(a)}}>{a}</button>)}
          </div>
        </div>
      </div>
    ); }

    // ------------- LOGIN (server sessions) -------------
    function Login({ onLogin }){
      const [u,setU] = useState(''); const [p,setP] = useState(''); const [err,setErr] = useState('');
      async function tryLogin(){ try{ await apiPost('/api/login',{username:u,password:p}); onLogin(); } catch(e){ setErr(e.message||'Login failed'); } }
      useEffect(()=>{ const key=(e)=>{ if(e.key==='Enter') tryLogin(); }; window.addEventListener('keydown',key); return ()=>window.removeEventListener('keydown',key) },[u,p]);
      return (
        <div style={{minHeight:'100vh', display:'grid', placeItems:'center', padding:20}}>
          <div style={{width:'min(420px, 96vw)', background:'var(--panel)', border:'1px solid var(--border)', borderRadius:20, boxShadow:theme.shadow}}>
            <div style={{padding:22, display:'flex', alignItems:'center', gap:12}}>
              <div className="logo" style={{width:34,height:34,borderRadius:10}}></div>
              <div style={{fontWeight:800, fontSize:'1.1rem'}}>BlackRoad.io -- Login</div>
            </div>
            <div style={{padding:22, paddingTop:0, display:'flex', flexDirection:'column', gap:12}}>
              <label style={{fontSize:13, color:'var(--muted)'}}>Username</label>
              <input value={u} onChange={e=>setU(e.target.value)} placeholder="root" style={{background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:'12px 14px'}} />
              <label style={{fontSize:13, color:'var(--muted)'}}>Password</label>
              <input type="password" value={p} onChange={e=>setP(e.target.value)} placeholder="Codex2025" style={{background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:'12px 14px'}} />
              {err && <div style={{color:'var(--bad)'}}>{err}</div>}
              <button className="btn primary" style={{marginTop:6}} onClick={tryLogin}>Enter Platform</button>
              <div style={{color:'var(--muted)', fontSize:12}}>Hint: root / Codex2025</div>
            </div>
          </div>
        </div>
      );
    }

    // ------------- Pages -------------
    function ChatPage(){
      const [msgs,setMsgs]=useState([{role:'system',content:'You are Lucidia -- concise and helpful.'}]);
      const [input,setInput]=useState(''); const [speaking,setSpeaking]=useState(false); const [loading,setLoading]=useState(false);
      async function send(){ const p=input.trim(); if(!p) return; const next=[...msgs,{role:'user',content:p}]; setMsgs(next); setInput(''); setLoading(true);
        try{ const r=await apiPost('/api/llm/chat',{prompt:p}); const text=r.text||JSON.stringify(r); setMsgs(m=>[...next,{role:'assistant',content:text}]); if(speaking&&'speechSynthesis'in window){ const u=new SpeechSynthesisUtterance(text); speechSynthesis.speak(u);} }
        catch(e){ setMsgs(m=>[...next,{role:'assistant',content:'[LLM offline] '+e.message}]); }
        finally{ setLoading(false); }
      }
      return (
        <div style={{display:'grid',gap:10}}>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            <label className="chip" style={{cursor:'pointer'}}><input type="checkbox" checked={speaking} onChange={()=>setSpeaking(s=>!s)} /> Speak replies</label>
            <button className="btn small" onClick={()=>setMsgs(msgs.slice(0,1))}>Clear</button>
          </div>
          <div style={{maxHeight:360,overflow:'auto',border:'1px solid var(--border)',borderRadius:12,padding:10,background:'#0b1324'}}>
            {msgs.map((m,i)=>(<div key={i} style={{marginBottom:10}}><div className="chip" style={{marginBottom:6}}>{m.role}</div><div style={{whiteSpace:'pre-wrap'}}>{m.content}</div></div>))}
          </div>
          <textarea value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}}} placeholder="Ask Lucidia…" style={{minHeight:90,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'var(--text)',padding:10}}/>
          <div style={{display:'flex',justifyContent:'flex-end'}}><button className="btn primary" onClick={send} disabled={loading}>{loading?'Thinking…':'Send'}</button></div>
        </div>
      );
    }

    function CanvasPage(){ const ref=useRef(null); const[draw,setDraw]=useState(false); const[color,setColor]=useState('#FF4FD8'); useEffect(()=>{ const c=ref.current, ctx=c.getContext('2d'); ctx.lineWidth=2; ctx.lineCap='round'; let last=null; const pos=e=>{const r=c.getBoundingClientRect(); return {x:e.clientX-r.left,y:e.clientY-r.top}}; const down=e=>{setDraw(true); last=pos(e)}; const move=e=>{ if(!draw) return; const p=pos(e); ctx.strokeStyle=color; ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; }; const up=()=>setDraw(false); c.addEventListener('mousedown',down); window.addEventListener('mousemove',move); window.addEventListener('mouseup',up); return()=>{ c.removeEventListener('mousedown',down); window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); }; },[draw,color]); return (
      <div style={{display:'grid',gap:10}}>
        <div style={{display:'flex',gap:8}}>
          <input type="color" value={color} onChange={e=>setColor(e.target.value)} />
          <button className="btn small" onClick={()=>{ const ctx=ref.current.getContext('2d'); ctx.clearRect(0,0,ref.current.width,ref.current.height); }}>Clear</button>
          <div className="chip">Freehand whiteboard</div>
        </div>
        <canvas ref={ref} width="900" height="380" style={{width:'100%',height:380,border:'1px solid var(--border)',borderRadius:12,background:'#0b1324'}}></canvas>
      </div>
    ); }

    function EditorPage({onRun,onCommit,code,setCode}){ return (
      <div style={{display:'grid',gap:10}}>
        <div style={{display:'flex',justifyContent:'space-between'}}><strong>Editor</strong><div style={{display:'flex',gap:8}}><button className="btn small" onClick={onRun}>Run</button><button className="btn small" onClick={onCommit}>Commit</button></div></div>
        <div onDragOver={e=>e.preventDefault()} onDrop={e=>{ e.preventDefault(); const f=e.dataTransfer.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>setCode(String(r.result)); r.readAsText(f); }}>
          <CodeEditor value={code} onChange={setCode}/>
        </div>
      </div>
    ); }

    function TerminalPage({onCommand}){ return <Terminal onCommand={onCommand}/> }

    function RoadViewPage({timeline,filteredTimeline,filter,setFilter,modal,setModal,itemAction,build,cpu,mem,gpu}){ return (
      <div style={{display:'grid',gap:10}}>
        <div style={{display:'flex',alignItems:'center',gap:8}}>
          <input value={filter} onChange={e=>setFilter(e.target.value)} placeholder="Search timeline…" style={{flex:1,background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'var(--text)',padding:'8px 10px'}}/>
        </div>
        <div style={{display:'grid',gap:10}}>
          {filteredTimeline.map(item => <ActivityItem key={item.id} item={{...item,onAction:itemAction}} onOpen={setModal} />)}
        </div>
        <div style={{display:'grid',gap:10}}>
          <div style={{fontWeight:700}}>Build</div>
          <div style={{height:10,background:'#0b1324',border:'1px solid var(--border)',borderRadius:10,overflow:'hidden'}}>
            <div style={{height:'100%',width:build+'%',background:'linear-gradient(90deg,var(--accent),var(--accent-2))',transition:'width .6s'}}></div>
          </div>
          <div style={{display:'grid',gap:6}}>
            <div style={{display:'flex',justifyContent:'space-between'}}><span>CPU</span><span>{Math.round(cpu.at(-1))}%</span></div>
            <Sparkline data={cpu} color={theme.colors['accent-2']}/>
            <div style={{display:'flex',justifyContent:'space-between'}}><span>Memory</span><span>{Math.round(mem.at(-1))}%</span></div>
            <Sparkline data={mem} color={theme.colors.accent}/>
            <div style={{display:'flex',justifyContent:'space-between'}}><span>GPU</span><span>{Math.round(gpu.at(-1))}%</span></div>
            <Sparkline data={gpu} color={theme.colors['accent-3']}/>
          </div>
        </div>
      </div>
    ); }

    function BackRoadPage({agents,setAgents,streamOn,setStreamOn,wallet,setWallet,notes,setNotes}){ return (
      <div style={{display:'grid',gap:10}}>
        <div style={{fontWeight:700}}>Agent Stack</div>
        <div style={{display:'flex',gap:8}}>{Object.keys(agents).map(k=>(<label key={k} className="chip" style={{cursor:'pointer'}}><input type="checkbox" checked={agents[k]} onChange={()=>setAgents(a=>({...a,[k]:!a[k]}))}/> {k}</label>))}</div>
        <label style={{display:'inline-flex',alignItems:'center',gap:8}}><input type="checkbox" checked={streamOn} onChange={()=>setStreamOn(s=>!s)}/><span>Stream</span></label>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
          <div><div style={{fontWeight:700}}>Wallet</div><div className="chip">{wallet} RC</div></div>
          <div style={{display:'flex',gap:8}}><button className="btn small" onClick={()=>setWallet(w=>(parseFloat(w)+0.1).toFixed(2))}>Stake</button><button className="btn small" onClick={()=>setWallet(w=>(Math.max(0,parseFloat(w)-0.1)).toFixed(2))}>Unstake</button></div>
        </div>
        <div style={{fontWeight:700}}>Session Notes</div>
        <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Type notes…" style={{minHeight:140,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'var(--text)',padding:10}}/>
      </div>
    ); }

    // ---------- Generic CRUD page ----------
    function CrudPage({kind, title, fields}){
      const[list,setList]=useState([]); const[loading,setLoading]=useState(true); const[modalOpen,setModalOpen]=useState(false); const[item,setItem]=useState({}); const[query,setQuery]=useState('');
      async function load(){ try{ const data=await apiGet(`/api/${kind}`); setList(data); } catch(e){ setList([]); } finally{ setLoading(false); } }
      useEffect(()=>{ load(); },[kind]);
      function edit(x){ setItem(x||{}); setModalOpen(true); }
      async function save(){ const body={...item}; if(item.id){ await apiPut(`/api/${kind}/${item.id}`,body); } else { await apiPost(`/api/${kind}`,body); } setModalOpen(false); load(); }
      async function del(id){ if(!confirm('Delete?')) return; await apiDel(`/api/${kind}/${id}`); load(); }
      const cols=fields.map(f=>f.name); const filtered=list.filter(row=>JSON.stringify(row).toLowerCase().includes(query.toLowerCase()));
      return (
        <div style={{display:'grid',gap:10}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <strong>{title}</strong>
            <div style={{display:'flex',gap:8}}>
              <input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search…" style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'var(--text)',padding:'8px 10px'}}/>
              <button className="btn small" onClick={()=>edit({})}>New</button>
            </div>
          </div>
          <div style={{overflow:'auto',border:'1px solid var(--border)',borderRadius:12}}>
            <table style={{width:'100%',borderCollapse:'collapse'}}>
              <thead><tr>{cols.map(c=><th key={c} style={{textAlign:'left',padding:'10px 12px',borderBottom:'1px solid var(--border)',color:'var(--muted)'}}>{c}</th>)}<th style={{padding:'10px 12px',borderBottom:'1px solid var(--border)'}}></th></tr></thead>
              <tbody>
                {loading? <tr><td colSpan={cols.length+1} style={{padding:12}}>Loading…</td></tr> : filtered.map(row=> (
                  <tr key={row.id}>
                    <>{cols.map(c=> <td key={c} style={{padding:'10px 12px',borderBottom:'1px solid var(--border)'}}>{String(row[c]??'')}</td>)}</>
                    <td style={{padding:'10px 12px',borderBottom:'1px solid var(--border)'}}>
                      <button className="btn small" onClick={()=>edit(row)}>Edit</button>
                      <button className="btn small" onClick={()=>del(row.id)} style={{marginLeft:6}}>Delete</button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <Modal open={modalOpen} onClose={()=>setModalOpen(false)} title={item.id?'Edit':'New'}>
            <div style={{display:'grid',gap:8}}>
              {fields.map(f=> (
                <div key={f.name} style={{display:'grid',gap:6}}>
                  <label style={{color:'var(--muted)'}}>{f.name}</label>
                  <input value={item[f.name]||''} onChange={e=>setItem({...item,[f.name]:e.target.value})} placeholder={f.placeholder||''} style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'var(--text)',padding:'8px 10px'}}/>
                </div>
              ))}
              <div style={{display:'flex',gap:8,justifyContent:'flex-end',marginTop:6}}>
                <button className="btn" onClick={()=>setModalOpen(false)}>Cancel</button>
                <button className="btn primary" onClick={save}>Save</button>
              </div>
            </div>
          </Modal>
        </div>
      );
    }

    function LoginGate({children}){ const[ok,setOk]=useState(false); useEffect(()=>{ apiGet('/api/me').then(()=>setOk(true)).catch(()=>setOk(false)); },[]); return ok? children: <Login onLogin={()=>setOk(true)}/> }

    // ------------- Main App -------------
    function App(){ const[route,setRoute]=useState(window.location.hash.slice(1)||'/roadview'); useEffect(()=>{ const h=()=>setRoute(window.location.hash.slice(1)||'/roadview'); window.addEventListener('hashchange',h); return()=>window.removeEventListener('hashchange',h); },[]); return <LoginGate><Dashboard route={route}/></LoginGate> }

    function Dashboard({route}){
      const navTop=['/chat','/canvas','/editor','/terminal','/roadview','/backroad'];
      const [activeNav,setActiveNav]=useState('Workspace'); const [streamOn,setStreamOn]=useState(true); const [agents,setAgents]=useState({Phi:true,GPT:true,Mistral:true});
      const [wallet,setWallet]=useState(1.20); const [notes,setNotes]=useState(''); const [modal,setModal]=useState(null); const [filter,setFilter]=useState('');
      const [cpu,setCPU]=useState(Array.from({length:40},()=>Math.random()*50+10)); const [mem,setMEM]=useState(Array.from({length:40},()=>Math.random()*70+20)); const [gpu,setGPU]=useState(Array.from({length:40},()=>Math.random()*90));
      const [build,setBuild]=useState(63); const [timeline,setTimeline]=useState([]); const [commits,setCommits]=useState([]); const [tasks,setTasks]=useState([]);

      // Initial load + WS
      useEffect(()=>{
        Promise.allSettled([apiGet('/api/timeline'),apiGet('/api/tasks'),apiGet('/api/commits'),apiGet('/api/state')]).then(([tl,ts,cs,st])=>{
          if(tl.value) setTimeline(tl.value); if(ts.value) setTasks(ts.value); if(cs.value) setCommits(cs.value);
          if(st.value){ setWallet(st.value.wallet); setAgents(st.value.agents); setBuild(st.value.build); }
        });
        const proto=location.protocol==='https:'?'wss':'ws'; const ws=new WebSocket(`${proto}://${location.host}/ws`);
        ws.onmessage=e=>{ try{ const m=JSON.parse(e.data); if(m.type==='activity') setTimeline(t=>[m.item,...t].slice(0,80)); if(m.type==='metrics'){ setCPU(x=>[...x.slice(1),m.cpu]); setMEM(x=>[...x.slice(1),m.mem]); setGPU(x=>[...x.slice(1),m.gpu]); } if(m.type==='build') setBuild(m.progress); if(m.type==='wallet') setWallet(m.balance.toFixed(2)); }catch(_){} };
        return()=>ws.close();
      },[]);

      const filteredTimeline=useMemo(()=> timeline.filter(x=> (x.title||'').toLowerCase().includes(filter.toLowerCase()) || (x.desc||'').toLowerCase().includes(filter.toLowerCase())),[timeline,filter]);
      const [code,setCode]=useState(`// Example code\nconsole.log('BlackRoad online');`);
      const runCode=()=>{ const frame=document.getElementById('sandbox'); const payload=`<!doctype html><html><body><script>const log=(...a)=>parent.postMessage({type:'log',data:a.join(' ')},'*'); console.log=log; console.error=(...a)=>parent.postMessage({type:'log',data:'! '+a.join(' ')},'*'); try{${code}}catch(e){console.error(e.message)}<\/script></body></html>`; frame.srcdoc=payload; };
      const onCommand=async(cmd)=>{ const [c,...rest]=cmd.split(/\s+/); switch(c){ case 'help':return['commands: help, run, build, commit <msg>, git status, agents, stake <amt>, mint, revert, clear, whoami, logout']; case 'run':runCode();return['executing current editor code…']; case 'build':await apiPost('/api/build/start',{});return['build started…']; case 'commit':{ const msg=rest.join(' ')||'Update from terminal'; await apiPost('/api/commit',{msg}); return[`committed: ${msg}`]; } case 'git': if(rest[0]==='status') return ['on branch main','nothing to commit']; break; case 'agents': return [`Phi:${agents.Phi?'on':'off'} GPT:${agents.GPT?'on':'off'} Mistral:${agents.Mistral?'on':'off'}`]; case 'stake':{ const amt=parseFloat(rest[0]||'0'); if(!amt) return ['usage: stake <amount>']; const r=await apiPost('/api/wallet/stake',{amount:amt}); return [`staked ${amt.toFixed(2)} RC (bal ${r.balance.toFixed(2)})`]; } case 'mint':{ const r=await apiPost('/api/wallet/mint',{}); return [`minted 0.05 RC (bal ${r.balance.toFixed(2)})`]; } case 'revert': await apiPost('/api/revert',{}); return ['revert queued']; case 'clear': return ['\u0007']; case 'whoami': return ['root']; case 'logout': await apiPost('/api/logout',{}); location.reload(); } return [`unknown command: ${cmd}. type 'help'.`]; };

      function go(h){ location.hash=h; }
      function Main(){
        if(route==='/'||route==='/roadview') return <RoadViewPage timeline={timeline} filteredTimeline={filteredTimeline} filter={filter} setFilter={setFilter} modal={modal} setModal={setModal} itemAction={(a)=>{ if(a==='Run') runCode(); if(a==='Revert') apiPost('/api/revert',{}); if(a==='Mint') apiPost('/api/wallet/mint',{}); }} build={build} cpu={cpu} mem={mem} gpu={gpu} />
        if(route==='/chat') return <ChatPage/>;
        if(route==='/canvas') return <CanvasPage/>;
        if(route==='/editor') return <EditorPage onRun={runCode} onCommit={()=>apiPost('/api/commit',{msg:'Patch from editor'})} code={code} setCode={setCode}/>;
        if(route==='/terminal') return <TerminalPage onCommand={onCommand}/>;
        if(route==='/backroad') return <BackRoadPage agents={agents} setAgents={setAgents} streamOn={streamOn} setStreamOn={setStreamOn} wallet={wallet} setWallet={setWallet} notes={notes} setNotes={setNotes}/>;
        if(route==='/projects') return <CrudPage kind='projects' title='Projects' fields={[{name:'id',placeholder:'auto if blank'},{name:'name'},{name:'repo'},{name:'status'}]} />;
        if(route==='/agents') return <CrudPage kind='agents' title='Agents' fields={[{name:'id'},{name:'name'},{name:'kind'},{name:'status'}]} />;
        if(route==='/datasets') return <CrudPage kind='datasets' title='Datasets' fields={[{name:'id'},{name:'name'},{name:'source'},{name:'size'}]} />;
        if(route==='/models') return <CrudPage kind='models' title='Models' fields={[{name:'id'},{name:'name'},{name:'family'},{name:'status'}]} />;
        if(route==='/integrations') return <CrudPage kind='integrations' title='Integrations' fields={[{name:'id'},{name:'name'},{name:'status'},{name:'details'}]} />;
        return <div>Unknown route {route}</div>
      }

      const rightPanel = (
        <Panel>
          <SideHeader>Agent Stack</SideHeader>
          <Card>
            <div style={{display:'flex',gap:8}}>
              {Object.keys(agents).map(k => (
                <label key={k} className="chip" style={{cursor:'pointer'}}>
                  <input type="checkbox" checked={agents[k]} onChange={()=>setAgents(a=>({...a,[k]:!a[k]}))} /> {k}
                </label>
              ))}
            </div>
            <div><SwitchWrap><input type="checkbox" checked={streamOn} onChange={()=>setStreamOn(s=>!s)} /><span className="switch"></span><span>Stream</span></SwitchWrap></div>
          </Card>
          <Card>
            <div style={{display:'grid',gap:8}}>
              <div style={{display:'flex',justifyContent:'space-between'}}><span>CPU</span><span>{Math.round(cpu.at(-1))}%</span></div>
              <Sparkline data={cpu} color={theme.colors['accent-2']} />
              <div style={{display:'flex',justifyContent:'space-between'}}><span>Memory</span><span>{Math.round(mem.at(-1))}%</span></div>
              <Sparkline data={mem} color={theme.colors.accent} />
              <div style={{display:'flex',justifyContent:'space-between'}}><span>GPU</span><span>{Math.round(gpu.at(-1))}%</span></div>
              <Sparkline data={gpu} color={theme.colors['accent-3']} />
            </div>
          </Card>
          <Card>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div><div style={{fontWeight:700}}>Wallet</div><div className="chip">{wallet} RC</div></div>
              <div style={{display:'flex',gap:8}}><button className="btn small" onClick={()=>setWallet(w=>(parseFloat(w)+0.1).toFixed(2))}>Stake</button><button className="btn small" onClick={()=>setWallet(w=>(Math.max(0,parseFloat(w)-0.1)).toFixed(2))}>Unstake</button></div>
            </div>
          </Card>
          <Card>
            <div style={{fontWeight:700}}>Session Notes</div>
            <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Type notes…" style={{minHeight:120, background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:'10px'}}></textarea>
          </Card>
        </Panel>
      );

      return (
        <Shell>
          <Header>
            <Brand><div className="logo"></div><div>BlackRoad.io</div></Brand>
            <NavTabs>
              {['Chat','Canvas','Editor','Terminal','RoadView','BackRoad'].map(t=>{ const href='/'+t.toLowerCase(); return <div key={t} onClick={()=>go(href)} className={'tab '+(route===href||(route==='/'&&href==='/roadview')?'active':'')}>{t}</div>; })}
            </NavTabs>
            <HeaderRight>
              <div className="chip"><span className="dot" style={{background:agents.Phi?'var(--good)':'var(--bad)'}}></span>Phi</div>
              <div className="chip"><span className="dot" style={{background:agents.GPT?'var(--good)':'var(--bad)'}}></span>GPT</div>
              <div className="chip"><span className="dot" style={{background:agents.Mistral?'var(--good)':'var(--bad)'}}></span>Mistral</div>
              <div className="chip">root</div>
              <button className="btn" onClick={()=>go('/chat')}>Open Chat</button>
              <button className="btn" onClick={async()=>{ await apiPost('/api/logout',{}); location.reload(); }}>Logout</button>
            </HeaderRight>
          </Header>

          <Body>
            {/* LEFT */}
            <Panel>
              <SideHeader>Workspace</SideHeader>
              <ColumnScroll>
                <div style={{padding:10}}><button className="co-btn" onClick={()=>go('/editor')}>Start Co-Coding</button></div>
                <SideList>
                  {['Workspace','Projects','Agents','Datasets','Models','Integrations'].map(s=>{ const map={Workspace:'/roadview',Projects:'/projects',Agents:'/agents',Datasets:'/datasets',Models:'/models',Integrations:'/integrations'}; const to=map[s]; return <li key={s} className={(route===to||(s==='Workspace'&&(route==='/'||route==='/roadview')))?'active':''} onClick={()=>go(to)}><span className="dot" style={{background:'#27324e'}}></span>{s}</li>; })}
                </SideList>
                <FooterNote><div style={{color:'var(--muted)'}}>Drag & drop a .js file onto the editor to load it.</div></FooterNote>
              </ColumnScroll>
            </Panel>

            {/* CENTER */}
            <Panel>
              <Tabs>
                <button className={(route==='/roadview'||route==='/')?'active':''} onClick={()=>go('/roadview')}>Timeline</button>
                <button className={route==='/tasks'?'active':''} disabled>Tasks</button>
                <button className={route==='/commits'?'active':''} disabled>Commits</button>
              </Tabs>
              <ContentScroll>
                <Main/>
              </ContentScroll>
            </Panel>

            {/* RIGHT */}
            {rightPanel}
          </Body>

          <iframe id="sandbox" sandbox="allow-scripts" style={{display:'none'}}></iframe>
          <div style="display:none" id="terminal-log"></div>
        </Shell>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>