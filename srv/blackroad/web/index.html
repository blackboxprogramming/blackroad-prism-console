<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BlackRoad.io</title>
  <meta name="color-scheme" content="dark"/>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2318253a'/%3E%3Cpath d='M16 40C24 20 40 20 48 40' stroke='%23ff4fd8' stroke-width='6' fill='none'/%3E%3C/svg%3E"/>
  <script src="./vendor/react.production.min.js"></script>
  <script src="./vendor/react-dom.production.min.js"></script>
  <script src="./vendor/styled-components.min.js"></script>
  <script src="./vendor/babel.min.js"></script>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --subpanel:#0b1324;
      --text:#e2e8f0; --muted:#9aa4b2; --border:#1f2a44;
      /* BlackRoad brand */
      --accent:#FF4FD8; --accent-2:#0096FF; --accent-3:#FDBA2D;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --shadow:0 6px 30px rgba(0,0,0,.35); --radius:16px;
    }
    html,body,#root{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 900px at 80% -10%, rgba(255,79,216,.20), transparent 40%),
        radial-gradient(1000px 800px at -20% 100%, rgba(0,150,255,.16), transparent 50%), var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }
    *{box-sizing:border-box}
    .hl-key{color:#93c5fd}.hl-str{color:#f472b6}.hl-num{color:#f59e0b}.hl-com{color:#64748b;font-style:italic}.hl-fn{color:#22d3ee}
    .btn{appearance:none;background:#121a30;border:1px solid var(--border);color:var(--text);padding:.55rem .9rem;border-radius:.75rem;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
    .btn:hover{transform:translateY(-1px);border-color:#29406c}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b1220;font-weight:700}
    .btn.small{padding:.35rem .6rem;font-size:.85rem}
    .chip{display:inline-flex;align-items:center;gap:.4rem;border:1px solid var(--border);padding:.2rem .5rem;border-radius:.6rem;font-size:.8rem;color:var(--muted)}
    .dot{width:.5rem;height:.5rem;border-radius:1rem;background:var(--muted)}
    .co-btn{background:conic-gradient(from 180deg at 50% 50%, var(--accent-3), var(--accent), var(--accent-2), var(--accent-3)); color:#0b1220;font-weight:800;border:none;border-radius:20px;padding:1.05rem 1.2rem;box-shadow:0 10px 40px rgba(255,79,216,.35);transition:.2s;cursor:pointer;width:100%}
    .co-btn:hover{transform:translateY(-2px);filter:brightness(1.05)}
    ::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-thumb{background:#1b2744;border-radius:8px}::-webkit-scrollbar-track{background:transparent}
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo,useRef,useCallback} = React; const styled = window.styled;
/* ------------ API helpers ------------- */
async function apiGet(p){const r=await fetch(p,{credentials:"include"});if(!r.ok)throw new Error(await r.text());return r.json()}
async function apiPost(p,b={}){const r=await fetch(p,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(b)});if(!r.ok)throw new Error(await r.text());return r.json()}
async function apiPut(p,b={}){const r=await fetch(p,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(b)});if(!r.ok)throw new Error(await r.text());return r.json()}
async function apiDel(p){const r=await fetch(p,{method:"DELETE",credentials:"include"});if(!r.ok)throw new Error(await r.text());return r.json()}
async function streamLLM(prompt,onToken){
  return new Promise((resolve,reject)=>{
    const es=new EventSource(`/api/llm/stream?prompt=${encodeURIComponent(prompt)}`);
    let full='';
    es.onmessage=e=>{full+=e.data;onToken&&onToken(e.data);};
    es.addEventListener('done',e=>{es.close();resolve(full);});
    es.onerror=e=>{es.close();reject(new Error('stream error'))};
  });
}
/* ------------- Theme & layout ---------- */
const theme={colors:{bg:get('--bg'),panel:get('--panel'),subpanel:get('--subpanel'),text:get('--text'),muted:get('--muted'),border:get('--border'),accent:get('--accent'),accent2:get('--accent-2'),accent3:get('--accent-3'),good:get('--good'),warn:get('--warn'),bad:get('--bad')},radius:'16px',shadow:'var(--shadow)'}; function get(v){return getComputedStyle(document.documentElement).getPropertyValue(v)}
const Shell = styled.div`display:flex;flex-direction:column;height:100%`;
const Header = styled.header`display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid ${theme.colors.border};background:rgba(8,14,28,.6);backdrop-filter:blur(8px);position:sticky;top:0;z-index:50`;
const Brand = styled.div`display:flex;align-items:center;gap:.8rem;font-weight:800;letter-spacing:.3px;font-size:1.05rem;.logo{width:28px;height:28px;border-radius:7px;background:conic-gradient(from 45deg, var(--accent-3), var(--accent), var(--accent-2), var(--accent-3));box-shadow:${theme.shadow}}`;
const NavTabs = styled.nav`display:flex;gap:.6rem;flex-wrap:wrap;.tab{padding:.45rem .75rem;border-radius:10px;color:${theme.colors.muted};border:1px solid transparent;cursor:pointer;transition:.2s}.tab:hover{color:${theme.colors.text};border-color:${theme.colors.border};background:#0e172a}.tab.active{color:#0b1220;background:linear-gradient(135deg,${theme.colors.accent},${theme.colors.accent2});font-weight:700}`;
const HeaderRight = styled.div`display:flex;align-items:center;gap:.6rem`;
const Body = styled.main`flex:1;display:grid;gap:14px;padding:14px;grid-template-columns:260px 1fr 320px;@media(max-width:1200px){grid-template-columns:230px 1fr 300px}@media(max-width:980px){grid-template-columns:1fr}`;
const Panel = styled.section`background:${theme.colors.panel};border:1px solid ${theme.colors.border};border-radius:${theme.radius};box-shadow:${theme.shadow};display:flex;flex-direction:column;min-height:120px;overflow:hidden`;
const ColumnScroll = styled.div`overflow:auto;height:calc(100vh - 110px)`;
const SideHeader = styled.div`padding:16px 16px 10px;border-bottom:1px solid ${theme.colors.border};display:flex;align-items:center;gap:.6rem;font-size:.95rem;color:${theme.colors.muted};text-transform:uppercase;letter-spacing:.12em`;
const SideList = styled.ul`list-style:none;margin:0;padding:6px;display:flex;flex-direction:column;gap:8px;li{display:flex;align-items:center;gap:.6rem;padding:.6rem .7rem;border-radius:10px;cursor:pointer;color:${theme.colors.muted);transition:.18s}li:hover{background:${theme.colors.subpanel};color:${theme.colors.text}}li.active{color:${theme.colors.text};background:#0e1a34;border:1px solid ${theme.colors.border}}`;
const FooterNote = styled.div`padding:14px;border-top:1px solid ${theme.colors.border};color:${theme.colors.muted};font-size:.85rem`;
const Tabs = styled.div`display:flex;gap:8px;padding:10px;border-bottom:1px solid ${theme.colors.border};button{background:transparent;border:1px solid transparent;color:${theme.colors.muted};padding:.45rem .75rem;border-radius:10px;cursor:pointer}button:hover{border-color:${theme.colors.border};color:${theme.colors.text}}button.active{color:#0b1220;font-weight:700;background:linear-gradient(135deg,${theme.colors.accent},${theme.colors.accent2})}`;
const ContentScroll = styled.div`padding:10px;overflow:auto;height:calc(100% - 54px)`;
const Card = styled.div`border-top:1px solid ${theme.colors.border};padding:12px 14px;display:flex;flex-direction:column;gap:10px`;
const SwitchWrap = styled.label`display:inline-flex;align-items:center;gap:.6rem;cursor:pointer;user-select:none;input{position:absolute;opacity:0}.switch{width:44px;height:24px;background:#14203b;border:1px solid ${theme.colors.border};border-radius:20px;position:relative;transition:.2s}.switch::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,${theme.colors.accent},${theme.colors.accent2});top:2px;left:2px;transition:.2s}input:checked + .switch{background:#09122a}input:checked + .switch::after{left:22px}`;
/* ------------ micro widgets --------------- */
function Sparkline({data,color=theme.colors.accent2}){const ref=useRef(null);useEffect(()=>{const c=ref.current;if(!c)return;const x=c.getContext('2d');const w=c.width=c.clientWidth*devicePixelRatio;const h=c.height=c.clientHeight*devicePixelRatio;x.clearRect(0,0,w,h);const mn=Math.min(...data),mx=Math.max(...data);const N=v=>h-(((v-mn)/(mx-mn||1))*(h-6))-3;x.lineWidth=2*devicePixelRatio;x.strokeStyle=color;x.beginPath();data.forEach((v,i)=>{const px=(i/(data.length-1))*(w-6)+3,py=N(v);i?x.lineTo(px,py):x.moveTo(px,py)});x.stroke()},[data,color]);return <div style={{width:'100%',height:36}}><canvas ref={ref} style={{width:'100%',height:'100%'}}/></div>}
function highlightJS(s){const esc=s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');let o=esc.replace(/(\/\*[\s\S]*?\*\/|\/\/.*$)/gm,'<span class="hl-com">$1<\/span>');o=o.replace(/([`'\"])(?:(?!\1|\\).|\\.)*\1/gm,m=>`<span class="hl-str">${m}<\/span>`);o=o.replace(/\b(0x[\da-fA-F]+|\d+\.?\d*)\b/gm,'<span class="hl-num">$1<\/span>');o=o.replace(/\b(const|let|var|function|return|if|else|for|while|class|new|try|catch|throw|await|async|import|from|export|switch|case|break|continue)\b/gm,'<span class="hl-key">$1<\/span>');o=o.replace(/(\b[A-Za-z_][A-Za-z0-9_]*)(?=\s*\()/g,'<span class="hl-fn">$1<\/span>');return o}
function CodeEditor({value,onChange}){const[v,setV]=useState(value||'');useEffect(()=>setV(value||''),[value]);const onInput=e=>{setV(e.target.value);onChange&&onChange(e.target.value)};return(<div style={{position:'relative',height:260;border:'1px solid var(--border)',borderRadius:'12px',overflow:'hidden',background:'#0b1324'}}><pre aria-hidden style={{margin:0,position:'absolute',inset:0,pointerEvents:'none',padding:'12px 14px',fontFamily:'ui-monospace,Menlo,Consolas',fontSize:13,lineHeight:1.6,color:'#c7d2fe',whiteSpace:'pre',overflow:'auto'}} dangerouslySetInnerHTML={{__html:highlightJS(v)}}/><textarea value={v} onChange={onInput} spellCheck={false} style={{position:'absolute',inset:0,resize:'none',padding:'12px 14px',fontFamily:'ui-monospace,Menlo,Consolas',fontSize:13,lineHeight:1.6,color:'transparent',caretColor:'#93c5fd',background:'transparent',border:'none',outline:'none'}}/><div style={{position:'absolute',right:10,bottom:10,display:'flex',gap:6}}><button class="btn small" onClick={()=>navigator.clipboard.writeText(v)}>Copy</button><button class="btn small" onClick={()=>downloadText('snippet.js',v)}>Download</button></div></div>)}
function downloadText(n,t){const b=new Blob([t],{type:'text/plain'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=n;a.click();URL.revokeObjectURL(u)}
function Terminal({onCommand}){const[lines,setLines]=useState(["Lucidia shell — type 'help' to see commands."]);const[input,setInput]=useState('');const r=useRef(null);useEffect(()=>{r.current&&(r.current.scrollTop=r.current.scrollHeight)},[lines]);const run=async c=>{const out=await onCommand(c);setLines(l=>[...l,`> ${c}`,...(Array.isArray(out)?out:[String(out)])])};const onKey=e=>{if(e.key==='Enter'){e.preventDefault();const c=input.trim();if(c)run(c);setInput('')}};return(<div style={{border:'1px solid var(--border)',borderRadius:'12px',background:'#0b1324',display:'flex',flexDirection:'column',height:300}}><div ref={r} style={{flex:1,overflow:'auto',padding:'10px 12px',fontFamily:'ui-monospace,Menlo,Consolas',fontSize:13}}>{lines.map((l,i)=><div key={i} style={{color:l.startsWith('!')?'var(--bad)':'#cbd5e1'}}>{l}</div>)}</div><div style={{display:'flex',gap:8,padding:8,borderTop:'1px solid var(--border)'}}><span class="chip"><span class="dot" style={{background:'var(--good)'}}></span>ready</span><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={onKey} placeholder="Type a command…" style={{flex:1,background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'var(--text)',padding:'8px 10px'}}/><button class="btn" onClick={()=>{const c=input.trim();if(c){run(c);setInput('')}}}>Run</button></div></div>)}
function ActivityItem({item,onOpen}){return(<div onClick={()=>onOpen(item)} style={{border:'1px solid var(--border)',background:'#0b1324',padding:'10px 12px',borderRadius:12,display:'flex',gap:10,alignItems:'flex-start',cursor:'pointer'}}><div class="dot" style={{background:item.kind==='build'?'var(--accent-2)':item.kind==='commit'?'var(--good)':item.kind==='revert'?'var(--bad)':'var(--accent)'}}></div><div style={{flex:1}}><div style={{display:'flex',justifyContent:'space-between',gap:8}}><div style={{fontWeight:700}}>{item.title}</div><div class="chip">{item.time||''}</div></div><div style={{color:'var(--muted)',marginTop:4}}>{item.desc||''}</div>{item.code&&(<pre style={{marginTop:8,padding:10,background:'#09122a',border:'1px solid var(--border)',borderRadius:10,overflow:'auto',maxHeight:140}}><code dangerouslySetInnerHTML={{__html:highlightJS(item.code)}}></code></pre>)}<div style={{display:'flex',gap:8,marginTop:8}}>{(item.actions||[]).map(a=><button key={a} class="btn small" onClick={(e)=>{e.stopPropagation();item.onAction&&item.onAction(a)}}>{a}</button>)}</div></div></div>)}
function Modal({open,onClose,title,children}){if(!open)return null;return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,.45)',display:'grid',placeItems:'center',zIndex:200}} onClick={onClose}><div onClick={e=>e.stopPropagation()} style={{width:'min(760px,94vw)',background:'var(--panel)',border:'1px solid var(--border)',borderRadius:'16px',boxShadow:'var(--shadow)'}}><div style={{display:'flex',justify-content:'space-between',alignItems:'center',padding:'14px 16px',borderBottom:'1px solid var(--border)'}}><strong style={{fontSize:'1.05rem'}}>{title}</strong><button class="btn small" onClick={onClose}>Close</button></div><div style={{padding:16}}>{children}</div></div></div>)}
/* ------------- Pages ------------- */
function ChatPage(){const[msgs,setMsgs]=useState([{role:'system',content:'You are Lucidia — concise and helpful.'}]);const[input,setInput]=useState('');const[speaking,setSpeaking]=useState(false);async function send(){const p=input.trim();if(!p)return;const m=[...msgs,{role:'user',content:p}];setMsgs(m);setInput('');try{const r=await apiPost('/api/llm/chat',{prompt:p});const text=r.text||JSON.stringify(r);const bot={role:'assistant',content:text};setMsgs(m2=>[...m,bot]);if(speaking&&'speechSynthesis'in window){const u=new SpeechSynthesisUtterance(text);speechSynthesis.speak(u)}}catch(e){setMsgs(m2=>[...m,{role:'assistant',content:'[LLM offline] '+e.message}])}}return(<div style={{display:'grid',gap:10}}><div style={{display:'flex',alignItems:'center',gap:10}}><label class="chip" style={{cursor:'pointer'}}><input type="checkbox" checked={speaking} onChange={()=>setSpeaking(s=>!s)}/> Speak replies</label><button class="btn small" onClick={()=>setMsgs(msgs.slice(0,1))}>Clear</button></div><div style={{maxHeight:360,overflow:'auto',border:'1px solid var(--border)',borderRadius:12,padding:10,background:'#0b1324'}}>{msgs.map((m,i)=>(<div key={i} style={{marginBottom:10}}><div class="chip" style={{marginBottom:6}}>{m.role}</div><div style={{whiteSpace:'pre-wrap'}}>{m.content}</div></div>))}</div><textarea value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}} placeholder="Ask Lucidia…" style={{minHeight:90,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'var(--text)',padding:10}}/><div style={{display:'flex',justifyContent:'flex-end'}}><button class="btn primary" onClick={send}>Send</button></div></div>)}
function StreamChatPage(){
  const[msgs,setMsgs]=useState([{role:'system',content:'You are Lucidia — concise and helpful.'}]);
  const[input,setInput]=useState('');
  const[speaking,setSpeaking]=useState(false);
  async function send(){
    const p=input.trim(); if(!p) return;
    const m=[...msgs,{role:'user',content:p}];
    setMsgs(m); setInput('');
    const bot={role:'assistant',content:''};
    setMsgs([...m,bot]);
    try{
      await streamLLM(p,token=>{bot.content+=token; setMsgs([...m,{...bot}]);});
      if(speaking&&'speechSynthesis'in window){const u=new SpeechSynthesisUtterance(bot.content);speechSynthesis.speak(u)}
    }catch(e){bot.content='[LLM offline] '+e.message; setMsgs([...m,bot]);}
  }
  return(<div style={{display:'grid',gap:10}}>
    <div style={{display:'flex',alignItems:'center',gap:10}}><label class="chip" style={{cursor:'pointer'}}><input type="checkbox" checked={speaking} onChange={()=>setSpeaking(s=>!s)}/> Speak replies</label><button class="btn small" onClick={()=>setMsgs(msgs.slice(0,1))}>Clear</button></div>
    <div style={{maxHeight:360,overflow:'auto',border:'1px solid var(--border)',borderRadius:12,padding:10,background:'#0b1324'}}>{msgs.map((m,i)=>(<div key={i} style={{marginBottom:10}}><div class="chip" style={{marginBottom:6}}>{m.role}</div><div style={{whiteSpace:'pre-wrap'}}>{m.content}</div></div>))}</div>
    <textarea value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}}} placeholder="Ask Lucidia…" style={{minHeight:90,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'var(--text)',padding:10}}/>
    <div style={{display:'flex',justifyContent:'flex-end'}}><button class="btn primary" onClick={send}>Send</button></div>
  </div>)
}
function CanvasPage(){const ref=useRef(null);const[draw,setDraw]=useState(false);const[color,setColor]=useState('#FF4FD8');useEffect(()=>{const c=ref.current,ctx=c.getContext('2d');ctx.lineWidth=2;ctx.lineCap='round';let last=null;const pos=e=>{const r=c.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}};const down=e=>{setDraw(true);last=pos(e)};const move=e=>{if(!draw)return;const p=pos(e);ctx.strokeStyle=color;ctx.beginPath();ctx.moveTo(last.x,last.y);ctx.lineTo(p.x,p.y);ctx.stroke();last=p};const up=()=>setDraw(false);c.addEventListener('mousedown',down);window.addEventListener('mousemove',move);window.addEventListener('mouseup',up);return()=>{c.removeEventListener('mousedown',down);window.removeEventListener('mousemove',move);window.removeEventListener('mouseup',up)}},[draw,color]);return(<div style={{display:'grid',gap:10}}><div style={{display:'flex',gap:8}}><input type="color" value={color} onChange={e=>setColor(e.target.value)}/><button class="btn small" onClick={()=>{const ctx=ref.current.getContext('2d');ctx.clearRect(0,0,ref.current.width,ref.current.height)}}>Clear</button><div class="chip">Freehand whiteboard</div></div><canvas ref={ref} width="900" height="380" style={{width:'100%',height:380,border:'1px solid var(--border)',borderRadius:12,background:'#0b1324'}}></canvas></div>)}
function EditorPage({onRun,onCommit,code,setCode}){return(<div style={{display:'grid',gap:10}}><div style={{display:'flex',justify-content:'space-between'}}><strong>Editor</strong><div style={{display:'flex',gap:8}}><button class="btn small" onClick={onRun}>Run</button><button class="btn small" onClick={onCommit}>Commit</button></div></div><div onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();const f=e.dataTransfer.files?.[0];if(!f)return;const r=new FileReader();r.onload=()=>setCode(String(r.result));r.readAsText(f)}}><CodeEditor value={code} onChange={setCode}/></div></div>)}
function TerminalPage({onCommand}){return <Terminal onCommand={onCommand}/>}
function RoadViewPage({timeline,filteredTimeline,filter,setFilter,modal,setModal,itemAction,build,cpu,mem,gpu}){return(<div style={{display:'grid',gap:10}}><div style={{display:'flex',alignItems:'center',gap:8}}><input value={filter} onChange={e=>setFilter(e.target.value)} placeholder="Search timeline…" style={{flex:1,background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'var(--text)',padding:'8px 10px'}}/></div><div style={{display:'grid',gap:10}}>{filteredTimeline.map(item=><ActivityItem key={item.id} item={{...item,onAction:itemAction}} onOpen={setModal}/>)}</div><div style={{display:'grid',gap:10}}><div style={{fontWeight:700}}>Build</div><div style={{height:10,background:'#0b1324',border:'1px solid var(--border)',borderRadius:10,overflow:'hidden'}}><div style={{height:'100%',width:build+'%',background:'linear-gradient(90deg,var(--accent),var(--accent-2))',transition:'width .6s'}}></div></div><div style={{display:'grid',gap:6}}><div style={{display:'flex',justifyContent:'space-between'}}><span>CPU</span><span>{Math.round(cpu.at(-1))}%</span></div><Sparkline data={cpu} color={theme.colors.accent2}/><div style={{display:'flex',justifyContent:'space-between'}}><span>Memory</span><span>{Math.round(mem.at(-1))}%</span></div><Sparkline data={mem} color={theme.colors.accent}/><div style={{display:'flex',justifyContent:'space-between'}}><span>GPU</span><span>{Math.round(gpu.at(-1))}%</span></div><Sparkline data={gpu} color={theme.colors.accent3}/></div></div>)}
function BackRoadPage({agents,setAgents,streamOn,setStreamOn,wallet,setWallet,notes,setNotes}){
  const capLogRef = useRef(null);
  const capChunks = useRef([]);
  const capRecorder = useRef(null);
  const capStreamRef = useRef(null);
  const capTimer = useRef(null);
  const [capRunning,setCapRunning] = useState(false);
  const [capLog,setCapLog] = useState('Captions idle…\n');

  const stopCaptions = useCallback((silent=false)=>{
    if(capTimer.current){clearInterval(capTimer.current);capTimer.current=null;}
    if(capRecorder.current && capRecorder.current.state!=='inactive'){capRecorder.current.stop();}
    if(capStreamRef.current){capStreamRef.current.getTracks().forEach(t=>t.stop());capStreamRef.current=null;}
    capChunks.current=[];
    capRecorder.current=null;
    if(capRunning){
      if(!silent){setCapLog(log=>log+'\n[stopped]\n');}
      setCapRunning(false);
    }
  },[capRunning]);

  const startCaptions = useCallback(async()=>{
    if(capRunning) return;
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      setCapLog(prev=>prev+'[mic error] media devices unavailable\n');
      return;
    }
    if(typeof MediaRecorder==='undefined'){
      setCapLog(prev=>prev+'[mic error] MediaRecorder unsupported\n');
      return;
    }
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      capStreamRef.current = stream;
      const recorder = new MediaRecorder(stream,{mimeType:'audio/webm'});
      capRecorder.current = recorder;
      capChunks.current=[];
      recorder.ondataavailable = e=>{if(e.data && e.data.size>0) capChunks.current.push(e.data);};
      recorder.start();
      setCapRunning(true);
      setCapLog('Captions started…\n');
      capTimer.current = setInterval(async()=>{
        if(!capChunks.current.length) return;
        const blob = new Blob(capChunks.current,{type:'audio/webm'});
        capChunks.current=[];
        const fd = new FormData();
        fd.append('file',blob,'chunk.webm');
        try{
          const up = await fetch('/transcribe/upload',{method:'POST',body:fd});
          if(!up.ok) throw new Error('upload failed');
          const data = await up.json();
          if(!data.token) throw new Error('missing token');
          const proto = location.protocol==='https:'?'wss':'ws';
          const ws = new WebSocket(`${proto}://${location.host}/ws/transcribe/run`);
          ws.onopen = ()=>ws.send(JSON.stringify({token:data.token,lang:'en'}));
          ws.onmessage = ev=>{
            if(ev.data==='[[BLACKROAD_WHISPER_DONE]]'){ws.close();return;}
            setCapLog(prev=>prev+ev.data+'\n');
          };
          ws.onerror = ()=>ws.close();
        }catch(err){
          setCapLog(prev=>prev+`[error] ${err.message}\n`);
        }
      },4000);
    }catch(err){
      setCapLog(prev=>prev+`[mic error] ${err.message}\n`);
    }
  },[capRunning]);

  useEffect(()=>()=>stopCaptions(true),[stopCaptions]);
  useEffect(()=>{if(capLogRef.current) capLogRef.current.scrollTop = capLogRef.current.scrollHeight;},[capLog]);
  const audioRef = useRef(null);
  const wsRef = useRef(null);
  const [whisperLog,setWhisperLog] = useState('');
  const [whisperSession,setWhisperSession] = useState('');
  const [whisperBusy,setWhisperBusy] = useState(false);

  const closeWs = () => {
    if(wsRef.current){
      try{ wsRef.current.close(); }catch(_){/* noop */}
      wsRef.current = null;
    }
  };

  useEffect(()=>{
    return ()=>closeWs();
  },[]);

  const appendLog = line => setWhisperLog(prev => prev ? `${prev}\n${line}` : line);

  function startStream(path, token){
    closeWs();
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${proto}://${location.host}${path}`);
    wsRef.current = ws;
    ws.onopen = () => {
      const payload = { token, lang:'en', model:'base', beam:5 };
      ws.send(JSON.stringify(payload));
    };
    ws.onmessage = ev => {
      const data = typeof ev.data === 'string' ? ev.data : '';
      if(!data) return;
      if(data.startsWith('[[BLACKROAD_SESSION:')){
        const id = data.replace('[[BLACKROAD_SESSION:','').replace(']]','');
        setWhisperSession(id);
        return;
      }
      if(data === '[[BLACKROAD_WHISPER_DONE]]'){
        appendLog('[done]');
        setWhisperBusy(false);
        ws.close();
        return;
      }
      appendLog(data);
    };
    ws.onerror = () => {
      appendLog('[error] stream error');
      setWhisperBusy(false);
    };
    ws.onclose = () => {
      wsRef.current = null;
      setWhisperBusy(false);
    };
  }

  async function uploadAndStream(mode){
    const file = audioRef.current?.files?.[0];
    if(!file){
      setWhisperLog('Pick an audio file.');
      setWhisperSession('');
      return;
    }
    setWhisperLog('Uploading audio…');
    setWhisperSession('');
    setWhisperBusy(true);
    try{
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch('/transcribe/upload',{method:'POST',body:fd});
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();
      if(!data?.token) throw new Error('Upload failed');
      appendLog(mode==='gpu' ? 'Starting Jetson stream…' : 'Starting local stream…');
      startStream(mode==='gpu'?'/ws/transcribe/run_gpu':'/ws/transcribe/run', data.token);
    }catch(err){
      setWhisperBusy(false);
      appendLog(`[error] ${err?.message || err}`);
    }
  }

  async function downloadTranscript(){
    if(!whisperSession) return;
    try{
      const res = await fetch(`/transcripts/${encodeURIComponent(whisperSession)}`);
      if(!res.ok) throw new Error(await res.text());
      const data = await res.json();
      if(!data?.text) throw new Error(data?.error || 'Transcript empty');
      const blob = new Blob([data.text],{type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${whisperSession}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }catch(err){
      appendLog(`[error] transcript download failed: ${err?.message || err}`);
    }
  }

  return(
    <div style={{display:'grid',gap:10}}>
      <div style={{fontWeight:700}}>Agent Stack</div>
      <div style={{display:'flex',gap:8}}>
        {Object.keys(agents).map(k=>(
          <label key={k} class="chip" style={{cursor:'pointer'}}>
            <input type="checkbox" checked={agents[k]} onChange={()=>setAgents(a=>({...a,[k]:!a[k]}))}/> {k}
          </label>
        ))}
      </div>
      <label style={{display:'inline-flex',alignItems:'center',gap:8}}>
        <input type="checkbox" checked={streamOn} onChange={()=>setStreamOn(s=>!s)}/>
        <span>Stream</span>
      </label>
      <div style={{display:'flex',gap:8}}>{Object.keys(agents).map(k=>(<label key={k} class="chip" style={{cursor:'pointer'}}><input type="checkbox" checked={agents[k]} onChange={()=>setAgents(a=>({...a,[k]:!a[k]}))}/> {k}</label>))}</div>
      <label style={{display:'inline-flex',alignItems:'center',gap:8}}><input type="checkbox" checked={streamOn} onChange={()=>setStreamOn(s=>!s)}/><span>Stream</span></label>
      <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
        <div>
          <div style={{fontWeight:700}}>Wallet</div>
          <div class="chip">{wallet} RC</div>
        </div>
        <div style={{display:'flex',gap:8}}>
          <button class="btn small" onClick={()=>setWallet(w=>(parseFloat(w)+0.1).toFixed(2))}>Stake</button>
          <button class="btn small" onClick={()=>setWallet(w=>(Math.max(0,parseFloat(w)-0.1)).toFixed(2))}>Unstake</button>
        </div>
      </div>
      <div style={{background:'var(--subpanel)',border:'1px solid var(--border)',borderRadius:12,padding:14,display:'flex',flexDirection:'column',gap:10}}>
        <div style={{fontWeight:700}}>Live Captions</div>
        <div style={{display:'flex',gap:8}}>
          <button class="btn small" onClick={startCaptions} disabled={capRunning} style={{opacity:capRunning?0.5:1,cursor:capRunning?'not-allowed':'pointer'}}>Start Captions</button>
          <button class="btn small" onClick={()=>stopCaptions()} disabled={!capRunning} style={{opacity:!capRunning?0.5:1,cursor:!capRunning?'not-allowed':'pointer'}}>Stop</button>
        </div>
        <pre ref={capLogRef} style={{background:'#000',color:'#0f0',padding:'1em',height:220,overflow:'auto',borderRadius:6,margin:0,fontSize:12,lineHeight:'1.4em'}}>{capLog}</pre>
      </div>
      <div style={{fontWeight:700}}>Session Notes</div>
      <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Type notes…" style={{minHeight:140,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#fff',padding:10}}/>
      <div style={{fontWeight:700}}>Session Notes</div>
      <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Type notes…" style={{minHeight:140,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#fff',padding:10}}/>
      <div style={{marginTop:6,padding:12,border:'1px solid var(--border)',borderRadius:12,background:'#0b1324',display:'grid',gap:10}}>
        <div style={{fontWeight:700}}>Whisper (Streaming)</div>
        <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center'}}>
          <input type="file" accept="audio/*" ref={audioRef} disabled={whisperBusy}/>
          <button class="btn small" disabled={whisperBusy} onClick={()=>uploadAndStream('cpu')}>Transcribe (stream)</button>
          <button class="btn small" disabled={whisperBusy} onClick={()=>uploadAndStream('gpu')}>Transcribe on Jetson (GPU)</button>
        </div>
        <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center'}}>
          <button class="btn small" disabled={!whisperSession} onClick={downloadTranscript}>Download transcript</button>
          {whisperSession && <div class="chip">Session: {whisperSession}</div>}
        </div>
        <pre style={{minHeight:140,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#e2e8f0',padding:10,whiteSpace:'pre-wrap'}}>{whisperLog || 'Pick an audio file and start a run.'}</pre>
      </div>
    </div>
  )
}
function CrudPage({kind,title,fields}){const[list,setList]=useState([]);const[loading,setLoading]=useState(true);const[modalOpen,setModalOpen]=useState(false);const[item,setItem]=useState({});const[query,setQuery]=useState('');async function load(){try{const d=await apiGet(`/api/${kind}`);setList(d)}catch{setList([])}finally{setLoading(false)}}useEffect(()=>{load()},[kind]);function edit(x){setItem(x||{});setModalOpen(true)}async function save(){const body={...item};if(item.id){await apiPut(`/api/${kind}/${item.id}`,body)}else{await apiPost(`/api/${kind}`,body)}setModalOpen(false);load()}async function del(id){if(!confirm('Delete?'))return;await apiDel(`/api/${kind}/${id}`);load()}const cols=fields.map(f=>f.name);const filtered=list.filter(r=>JSON.stringify(r).toLowerCase().includes(query.toLowerCase()));return(<div style={{display:'grid',gap:10}}><div style={{display:'flex',justify-content:'space-between',alignItems:'center'}}><strong>{title}</strong><div style={{display:'flex',gap:8}}><input value={query} onChange={e=>setQuery(e.target.value)} placeholder="Search…" style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'#fff',padding:'8px 10px'}}/><button class="btn small" onClick={()=>edit({})}>New</button></div></div><div style={{overflow:'auto',border:'1px solid var(--border)',borderRadius:12}}><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr>{cols.map(c=><th key={c} style={{textAlign:'left',padding:'10px 12px',borderBottom:'1px solid var(--border)',color:'var(--muted)'}}>{c}</th>)}<th style={{padding:'10px 12px',borderBottom:'1px solid var(--border)'}}></th></tr></thead><tbody>{loading?<tr><td colSpan={cols.length+1} style={{padding:12}}>Loading…</td></tr>:filtered.map(row=>(<tr key={row.id}><>{cols.map(c=><td key={c} style={{padding:'10px 12px',borderBottom:'1px solid var(--border)'}}>{String(row[c]??'')}</td>)}</><td style={{padding:'10px 12px',borderBottom:'1px solid var(--border)'}}><button class="btn small" onClick={()=>edit(row)}>Edit</button> <button class="btn small" onClick={()=>del(row.id)}>Delete</button></td></tr>))}</tbody></table></div><Modal open={modalOpen} onClose={()=>setModalOpen(false)} title={item.id?'Edit':'New'}><div style={{display:'grid',gap:8}}>{fields.map(f=>(<div key={f.name} style={{display:'grid',gap:6}}><label style={{color:'var(--muted)'}}>{f.name}</label><input value={item[f.name]||''} onChange={e=>setItem({...item,[f.name]:e.target.value})} placeholder={f.placeholder||''} style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'#fff',padding:'8px 10px'}}/></div>))}<div style={{display:'flex',gap:8,justifyContent:'flex-end',marginTop:6}}><button class="btn" onClick={()=>setModalOpen(false)}>Cancel</button><button class="btn primary" onClick={save}>Save</button></div></div></Modal></div>)}
function S3Uploader(){
  const [file,setFile]=useState(null);
  const [msg,setMsg]=useState('');
  async function upload(){
    if(!file) return;
    const fd=new FormData();
    fd.append('file',file);
    try{
      const r=await fetch('/api/datasets/upload',{method:'POST',body:fd});
      const j=await r.json();
      setMsg(j.ok?'Uploaded':'Error');
    }catch(e){setMsg('Error');}
  }
  return(<div style={{display:'flex',gap:8,alignItems:'center'}}><input type="file" onChange={e=>setFile(e.target.files[0])}/><button class="btn small" onClick={upload}>Upload</button>{msg && <span>{msg}</span>}</div>);
}
function DatasetsPage(){return(<div style={{display:'grid',gap:10}}><S3Uploader/><CrudPage kind='datasets' title='Datasets' fields={[{name:'id'},{name:'name'},{name:'source'},{name:'size'}]}/></div>);}
function PricingPage(){return(<div><h2>Pricing</h2><p>Coming soon.</p></div>);}
function DocsPage(){return(<div><h2>Docs</h2><p>Documentation under construction.</p></div>);}
function StatusPage(){return(<div><h2>Status</h2><p>All systems operational.</p></div>);}
/* ------------- Login ------------- */
function Login({onLogin}){const[u,setU]=useState('');const[p,setP]=useState('');const[err,setErr]=useState('');async function tryLogin(){try{await apiPost('/api/login',{username:u,password:p});onLogin()}catch(e){setErr(e.message||'Login failed')}}useEffect(()=>{const h=e=>{if(e.key==='Enter')tryLogin()};window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h)},[u,p]);return(<div style={{minHeight:'100vh',display:'grid',placeItems:'center',padding:20}}><div style={{width:'min(420px,96vw)',background:'var(--panel)',border:'1px solid var(--border)',borderRadius:20,boxShadow:theme.shadow}}><div style={{padding:22,display:'flex',alignItems:'center',gap:12}}><div class="logo" style={{width:34,height:34,borderRadius:10}}></div><div style={{fontWeight:800,fontSize:'1.1rem'}}>BlackRoad.io — Login</div></div><div style={{padding:22,paddingTop:0,display:'flex',flexDirection:'column',gap:12}}><label style={{fontSize:13,color:'var(--muted)'}}>Username</label><input value={u} onChange={e=>setU(e.target.value)} placeholder="root" style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#fff',padding:'12px 14px'}}/><label style={{fontSize:13,color:'var(--muted)'}}>Password</label><input type="password" value={p} onChange={e=>setP(e.target.value)} placeholder="Codex2025" style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#fff',padding:'12px 14px'}}/>{err && <div style={{color:'var(--bad)'}}>{err}</div>}<button class="btn primary" style={{marginTop:6}} onClick={tryLogin}>Enter Platform</button></div></div></div>)}
/* ------------- App & Dashboard ------------- */
function App(){const[authed,setAuthed]=useState(false);const[route,setRoute]=useState(window.location.hash.slice(1)||'/roadview');useEffect(()=>{apiGet('/api/me').then(()=>setAuthed(true)).catch(()=>setAuthed(false))},[]);useEffect(()=>{const h=()=>setRoute(window.location.hash.slice(1)||'/roadview');window.addEventListener('hashchange',h);return()=>window.removeEventListener('hashchange',h)},[]);return authed? <Dashboard route={route}/> : <Login onLogin={()=>setAuthed(true)}/>} 
function Dashboard({route}) {
  const go = h => location.hash=h;
  const [agents,setAgents]=useState({Phi:true,GPT:true,Mistral:true});
  const [streamOn,setStreamOn]=useState(true);
  const [wallet,setWallet]=useState(1.20); const [notes,setNotes]=useState('');
  const [modal,setModal]=useState(null); const [filter,setFilter]=useState('');
  const [cpu,setCPU]=useState(Array.from({length:40},()=>Math.random()*50+10));
  const [mem,setMEM]=useState(Array.from({length:40},()=>Math.random()*70+20));
  const [gpu,setGPU]=useState(Array.from({length:40},()=>Math.random()*90));
  const [build,setBuild]=useState(63); const [timeline,setTimeline]=useState([]); const [commits,setCommits]=useState([]); const [tasks,setTasks]=useState([]);
  const [jobs,setJobs]=useState([]);
  const [jobOutput,setJobOutput]=useState('');
  const jobOutRef=useRef(null);
  const activeJobRef=useRef(null);

  const loadJobs=useCallback(async()=>{try{const res=await fetch('/jobs');const data=await res.json();setJobs(Array.isArray(data.jobs)?data.jobs:[]);}catch(err){console.error('jobs load failed',err);}},[]);
  const openJob=useCallback(async(id)=>{activeJobRef.current=id;try{const res=await fetch(`/jobs/${id}`);const data=await res.json();const text=data.output||JSON.stringify(data,null,2);setJobOutput(text);setTimeout(()=>{if(jobOutRef.current){jobOutRef.current.scrollTop=jobOutRef.current.scrollHeight;}},0);}catch(err){setJobOutput(String(err));}},[]);
  const [flashDevices,setFlashDevices]=useState([]);
  const [flashDevice,setFlashDevice]=useState('');
  const [flashUrl,setFlashUrl]=useState('');
  const [flashLog,setFlashLog]=useState('');
  const [flashBusy,setFlashBusy]=useState(false);
  const [flashSafeHdmi,setFlashSafeHdmi]=useState(true);
  const [flashEnableSsh,setFlashEnableSsh]=useState(true);
  const [isFlashing,setIsFlashing]=useState(false);
  const flashSocket=useRef(null);
  const flashLogRef=useRef(null);

  useEffect(()=>{Promise.allSettled([apiGet('/api/timeline'),apiGet('/api/tasks'),apiGet('/api/commits'),apiGet('/api/state')]).then(([tl,ts,cs,st])=>{
    if(tl.value)setTimeline(tl.value); if(ts.value)setTasks(ts.value); if(cs.value)setCommits(cs.value);
    if(st.value){setWallet(st.value.wallet); setAgents(st.value.agents); setBuild(st.value.build);}
  }); loadJobs(); const proto=location.protocol==='https:'?'wss':'ws'; const ws=new WebSocket(`${proto}://${location.host}/ws`);
  ws.onmessage=e=>{const raw=typeof e.data==='string'?e.data:''; try{const m=JSON.parse(raw); if(m.type==='activity') setTimeline(t=>[m.item,...t].slice(0,80)); if(m.type==='metrics'){setCPU(x=>[...x.slice(1),m.cpu]); setMEM(x=>[...x.slice(1),m.mem]); setGPU(x=>[...x.slice(1),m.gpu]);} if(m.type==='build') setBuild(m.progress); if(m.type==='wallet') setWallet(m.balance.toFixed(2)); }catch(err){}};
  return ()=>ws.close();},[loadJobs]);

  useEffect(()=>{const origWS=window.WebSocket; const patched=function(url,protocols){const ws=protocols!==undefined?new origWS(url,protocols):new origWS(url); const handler=(event)=>{const raw=String(event.data??''); if(raw.startsWith('[[BLACKROAD_JOB_ID:')){const match=raw.match(/\d+/); const id=match?Number(match[0]):null; if(id){activeJobRef.current=id; setJobOutput(''); loadJobs().then(()=>openJob(id)).catch(()=>{});} return;} if(raw==='[[BLACKROAD_DONE]]'){const id=activeJobRef.current; loadJobs().then(()=>{if(id) openJob(id);}).catch(()=>{}); return;} if(raw.startsWith('[error]')){setJobOutput(prev=>prev?`${prev}\n${raw}`:raw); setTimeout(()=>{if(jobOutRef.current){jobOutRef.current.scrollTop=jobOutRef.current.scrollHeight;}},0); loadJobs().then(()=>{const id=activeJobRef.current; if(id) openJob(id);}).catch(()=>{});} }; ws.addEventListener('message',handler); return ws;};
  Object.assign(patched,origWS); patched.prototype=origWS.prototype; window.WebSocket=patched; return()=>{window.WebSocket=origWS;};},[loadJobs,openJob]);

  const formatTs=ts=>ts?new Date(ts*1000).toLocaleTimeString():'-';

  useEffect(()=>{return ()=>{if(flashSocket.current){flashSocket.current.close(); flashSocket.current=null;}};},[]);
  useEffect(()=>{if(flashLogRef.current){const el=flashLogRef.current; el.scrollTop=el.scrollHeight;}},[flashLog]);

  async function listFlashDevices(){
    try{
      const r=await fetch('/flash/devices');
      const j=await r.json();
      if(j && j.devices && !Array.isArray(j.devices) && j.devices.error){
        setFlashLog(prev=>`${prev ? prev+'\n' : ''}ERROR: ${j.devices.error}`);
        return;
      }
      const devices=Array.isArray(j.devices)?j.devices:[];
      setFlashDevices(devices);
      if(devices.length){
        const found=devices.find(d=>d.device===flashDevice);
        setFlashDevice(found?flashDevice:devices[0].device);
      }
      if(!devices.length){
        setFlashLog(prev=>`${prev ? prev+'\n' : ''}No removable devices detected.`);
      }
    }catch(e){
      setFlashLog(prev=>`${prev ? prev+'\n' : ''}ERROR: ${e.message||e}`);
    }
  }

  function startFlash(){
    const url=flashUrl.trim();
    if(!url || !flashDevice){
      setFlashLog('Select device and image URL');
      return;
    }
    if(flashSocket.current){
      flashSocket.current.close();
      flashSocket.current=null;
    }
    setFlashLog('');
    setFlashBusy(true);
    const proto=location.protocol==='https:'?'wss':'ws';
    const ws=new WebSocket(`${proto}://${location.host}/ws/flash`);
    flashSocket.current=ws;
    ws.onopen=()=>{ws.send(JSON.stringify({device:flashDevice,image_url:url}));};
    ws.onmessage=ev=>{
      const text=ev.data;
      setFlashLog(prev=>`${prev ? prev+'\n' : ''}${text}`);
      if(text==='[[BLACKROAD_DONE]]' || text==='[BLACKROAD_FLASH_DONE]' || text.startsWith('ERROR')){
        setFlashBusy(false);
      }
    };
    ws.onerror=()=>{
      setFlashLog(prev=>`${prev ? prev+'\n' : ''}ERROR: websocket error`);
      setFlashBusy(false);
      ws.close();
    };
    ws.onclose=()=>{setFlashBusy(false); flashSocket.current=null;};
  }
    if(st.value){setWallet(st.value.wallet); setAgents(st.value.agents); setBuild(st.value.build)}
  }); const proto=location.protocol==='https:'?'wss':'ws'; const ws=new WebSocket(`${proto}://${location.host}/ws`);
  ws.onmessage=e=>{try{const m=JSON.parse(e.data); if(m.type==='activity') setTimeline(t=>[m.item,...t].slice(0,80)); if(m.type==='metrics'){setCPU(x=>[...x.slice(1),m.cpu]); setMEM(x=>[...x.slice(1),m.mem]); setGPU(x=>[...x.slice(1),m.gpu]);} if(m.type==='build') setBuild(m.progress); if(m.type==='wallet') setWallet(m.balance.toFixed(2)); }catch(_){} };
  return ()=>ws.close();},[]);
  useEffect(()=>()=>{if(flashSocket.current) flashSocket.current.close();},[]);
  useEffect(()=>{if(flashLogRef.current) flashLogRef.current.scrollTop=flashLogRef.current.scrollHeight;},[flashLog]);

  const filteredTimeline=useMemo(()=>timeline.filter(x=>(x.title||'').toLowerCase().includes(filter.toLowerCase())||(x.desc||'').toLowerCase().includes(filter.toLowerCase())),[timeline,filter]);
  const appendFlashLog=line=>setFlashLog(prev=>prev?prev+'\n'+String(line):String(line));
  async function loadFlashDevices(){
    try{
      const res=await fetch('/flash/devices');
      const data=await res.json().catch(()=>({}));
      if(!res.ok){
        const detail=data.detail||data.error||'Failed to list devices';
        appendFlashLog(`ERROR: ${detail}`);
        setFlashDevices([]);
        setFlashDevice('');
        return;
      }
      const list=data.devices||[];
      setFlashDevices(list);
      if(!list.find(d=>d.device===flashDevice)){
        setFlashDevice(list.length?list[0].device:'');
      }
      if(list.length===0){
        appendFlashLog('No removable devices detected');
      }
    }catch(e){appendFlashLog(`ERROR: ${(e&&e.message)||e}`);}
  }
  const startFlash=()=>{
    if(isFlashing) return;
    const url=flashUrl.trim();
    if(!url||!flashDevice){appendFlashLog('Select device and image URL');return;}
    setFlashLog('');
    const proto=location.protocol==='https:'?'wss':'ws';
    const ws=new WebSocket(`${proto}://${location.host}/ws/flash`);
    flashSocket.current=ws;
    setIsFlashing(true);
    ws.onopen=()=>ws.send(JSON.stringify({device:flashDevice,image_url=url,safe_hdmi:flashSafeHdmi,enable_ssh:flashEnableSsh}));
    ws.onmessage=e=>appendFlashLog(e.data);
    ws.onerror=()=>appendFlashLog('ERROR: WebSocket error');
    ws.onclose=()=>{setIsFlashing(false); if(flashSocket.current===ws) flashSocket.current=null;};
  };
  const canFlash=Boolean(flashDevice && flashUrl.trim() && !isFlashing);
  const [code,setCode]=useState(`// Example code\nconsole.log('BlackRoad online');`);
  const runCode=()=>{const frame=document.getElementById('sandbox');const payload=`<!doctype html><html><body><script>const log=(...a)=>parent.postMessage({type:'log',data:a.join(' ')},'*');console.log=log;console.error=(...a)=>parent.postMessage({type:'log',data:'! '+a.join(' ')},'*');try{${code}}catch(e){console.error(e.message)}<\/script></body></html>`; frame.srcdoc=payload}
  const onCommand=async(cmd)=>{const [c,...rest]=cmd.split(/\s+/);switch(c){case 'help':return['commands: help, run, build, commit <msg>, git status, agents, stake <amt>, mint, revert, clear, whoami, logout'];case 'run':runCode();return['executing current editor code…'];case 'build':await apiPost('/api/build/start',{});return['build started…'];case 'commit':{const msg=rest.join(' ')||'Update from terminal';await apiPost('/api/commit',{msg});return[`committed: ${msg}`]}case 'git':if(rest[0]==='status')return['on branch main','nothing to commit'];break;case 'agents':return[`Phi:${agents.Phi?'on':'off'} GPT:${agents.GPT?'on':'off'} Mistral:${agents.Mistral?'on':'off'}`];case 'stake':{const amt=parseFloat(rest[0]||'0');if(!amt)return['usage: stake <amount>'];const r=await apiPost('/api/wallet/stake',{amount:amt});return[`staked ${amt.toFixed(2)} RC (bal ${r.balance.toFixed(2)})`]}case 'mint':{const r=await apiPost('/api/wallet/mint',{});return[`minted 0.05 RC (bal ${r.balance.toFixed(2)})`]}case 'revert':await apiPost('/api/revert',{});return['revert queued'];case 'clear':return['\u0007'];case 'whoami':return['root'];case 'logout':await apiPost('/api/logout',{});location.reload()}return[`unknown command: ${cmd}. type 'help'.`]}
  function Main(){
    if(route==='/'||route==='/roadview') return React.createElement(RoadViewPage,{timeline,filteredTimeline,filter,setFilter,modal,setModal,itemAction:(a)=>{if(a==='Run')runCode(); if(a==='Revert')apiPost('/api/revert',{}); if(a==='Mint')apiPost('/api/wallet/mint',{})},build,cpu,mem,gpu});
    if(route==='/chat') return React.createElement(ChatPage);
    if(route==='/chat') return React.createElement(StreamChatPage);
    if(route==='/canvas') return React.createElement(CanvasPage);
    if(route==='/editor') return React.createElement(EditorPage,{onRun:runCode,onCommit:()=>apiPost('/api/commit',{msg:'Patch from editor'}),code,setCode});
    if(route==='/terminal') return React.createElement(TerminalPage,{onCommand});
    if(route==='/backroad') return React.createElement(BackRoadPage,{agents,setAgents,streamOn,setStreamOn,wallet,setWallet,notes,setNotes});
    if(route==='/projects') return React.createElement(CrudPage,{kind:'projects',title:'Projects',fields:[{name:'id',placeholder:'auto if blank'},{name:'name'},{name:'repo'},{name:'status'}]});
    if(route==='/agents') return React.createElement(CrudPage,{kind:'agents',title:'Agents',fields:[{name:'id'},{name:'name'},{name:'kind'},{name:'status'}]});
    if(route==='/datasets') return React.createElement(CrudPage,{kind:'datasets',title:'Datasets',fields:[{name:'id'},{name:'name'},{name:'source'},{name:'size'}]});
    if(route==='/models') return React.createElement(CrudPage,{kind:'models',title:'Models',fields:[{name:'id'},{name:'name'},{name:'family'},{name:'status'}]});
    if(route==='/integrations') return React.createElement(CrudPage,{kind:'integrations',title:'Integrations',fields:[{name:'id'},{name:'name'},{name:'status'},{name:'details'}]});
    if(route==='/datasets') return React.createElement(DatasetsPage);
    if(route==='/models') return React.createElement(CrudPage,{kind:'models',title:'Models',fields:[{name:'id'},{name:'name'},{name:'family'},{name:'status'}]});
    if(route==='/integrations') return React.createElement(CrudPage,{kind:'integrations',title:'Integrations',fields:[{name:'id'},{name:'name'},{name:'status'},{name:'details'}]});
    if(route==='/pricing') return React.createElement(PricingPage);
    if(route==='/docs') return React.createElement(DocsPage);
    if(route==='/status') return React.createElement(StatusPage);
    return React.createElement('div',null,'Unknown route ',route)
  }
  return (<Shell>
    <Header>
      <Brand><div className="logo"></div><div>BlackRoad.io</div></Brand>
      <NavTabs>
        {['Chat','Canvas','Editor','Terminal','RoadView','BackRoad'].map(t=>{const href='/'+t.toLowerCase();return <div key={t} onClick={()=>go(href)} className={'tab '+(route===href||(route==='/'&&href==='/roadview')?'active':'')}>{t}</div>})}
        {['Chat','Canvas','Editor','Terminal','RoadView','BackRoad','Pricing','Docs','Status'].map(t=>{const href='/'+t.toLowerCase();return <div key={t} onClick={()=>go(href)} className={'tab '+(route===href||(route==='/'&&href==='/roadview')?'active':'')}>{t}</div>})}
      </NavTabs>
      <HeaderRight>
        <div className="chip">root</div>
        <button className="btn" onClick={async()=>{await apiPost('/api/logout',{}); location.reload();}}>Logout</button>
      </HeaderRight>
    </Header>
    <Body>
      <Panel>
        <SideHeader>Workspace</SideHeader>
        <ColumnScroll>
          <div style={{padding:10}}><button className="co-btn" onClick={()=>go('/editor')}>Start Co-Coding</button></div>
          <SideList>
            {['Workspace','Projects','Agents','Datasets','Models','Integrations'].map(s=>{const map={Workspace:'/roadview',Projects:'/projects',Agents:'/agents',Datasets:'/datasets',Models:'/models',Integrations:'/integrations'};const to=map[s];return <li key={s} className={(route===to||(s==='Workspace'&&(route==='/'||route==='/roadview')))?'active':''} onClick={()=>go(to)}><span className="dot" style={{background:'#27324e'}}></span>{s}</li>})}
          </SideList>
          <FooterNote><div style={{color:'var(--muted)'}}>Drag & drop a .js file onto the editor to load it.</div></FooterNote>
        </ColumnScroll>
      </Panel>
      <Panel>
        <Tabs>
          <button className={(route==='/roadview'||route=='/')?'active':''} onClick={()=>go('/roadview')}>Timeline</button>
          <button className={route==='/tasks'?'active':''} disabled>Tasks</button>
          <button className={route==='/commits'?'active':''} disabled>Commits</button>
        </Tabs>
        <ContentScroll><Main/></ContentScroll>
      </Panel>
      <Panel>
        <SideHeader>Agent Stack</SideHeader>
        <Card>
          <div style={{display:'flex',gap:8}}>{Object.keys(agents).map(k=>(<label key={k} className="chip" style={{cursor:'pointer'}}><input type="checkbox" checked={agents[k]} onChange={()=>setAgents(a=>({...a,[k]:!a[k]}))}/> {k}</label>))}</div>
          <div><SwitchWrap><input type="checkbox" checked={streamOn} onChange={()=>setStreamOn(s=>!s)}/><span className="switch"></span><span>Stream</span></SwitchWrap></div>
        </Card>
        <Card>
          <div style={{display:'grid',gap:8}}>
            <div style={{display:'flex',justifyContent:'space-between'}}><span>CPU</span><span>{Math.round(cpu.at(-1))}%</span></div>
            <Sparkline data={cpu} color={theme.colors.accent2}/>
            <div style={{display:'flex',justifyContent:'space-between'}}><span>Memory</span><span>{Math.round(mem.at(-1))}%</span></div>
            <Sparkline data={mem} color={theme.colors.accent}/>
            <div style={{display:'flex',justifyContent:'space-between'}}><span>GPU</span><span>{Math.round(gpu.at(-1))}%</span></div>
            <Sparkline data={gpu} color={theme.colors.accent3}/>
          </div>
        </Card>
        <Card>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div style={{fontWeight:700}}>Jobs</div>
            <button className="btn small" onClick={loadJobs}>Refresh</button>
          </div>
          <table style={{width:'100%',marginTop:8,fontSize:12,borderCollapse:'collapse'}}>
            <thead><tr><th>ID</th><th>Cmd</th><th>Status</th><th>Started</th><th>Ended</th><th>View</th></tr></thead>
            <tbody>
              {jobs.map(job=>(
                <tr key={job.id}>
                  <td>{job.id}</td>
                  <td style={{maxWidth:360,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}} title={job.cmd}>{job.cmd}</td>
                  <td>{job.status}</td>
                  <td>{formatTs(job.started)}</td>
                  <td>{formatTs(job.ended)}</td>
                  <td><button className="btn small" onClick={()=>openJob(job.id)}>Open</button></td>
                </tr>
              ))}
              {!jobs.length && <tr><td colSpan="6" style={{padding:'8px 4px',color:'var(--muted)'}}>No jobs yet</td></tr>}
            </tbody>
          </table>
          <pre ref={jobOutRef} style={{background:'#000',color:'#0f0',padding:'1em',height:220,overflow:'auto',borderRadius:6,marginTop:8}}>{jobOutput}</pre>
        </Card>
        <Card>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
            <div><div style={{fontWeight:700}}>Wallet</div><div className="chip">{wallet} RC</div></div>
            <div style={{display:'flex',gap:8}}><button className="btn small" onClick={()=>setWallet(w=>(parseFloat(w)+0.1).toFixed(2))}>Stake</button><button className="btn small" onClick={()=>setWallet(w=>(Math.max(0,parseFloat(w)-0.1)).toFixed(2))}>Unstake</button></div>
          </div>
        </Card>
        <Card>
          <div style={{fontWeight:700}}>Session Notes</div>
          <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Type notes…" style={{minHeight:120,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#fff',padding:10}}/>
        </Card>
        <Card>
          <div style={{fontWeight:700}}>Flasher</div>
          <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center',marginTop:8}}>
            <button className="btn small" type="button" onClick={listFlashDevices} disabled={flashBusy}>List Devices</button>
            <select value={flashDevice} onChange={e=>setFlashDevice(e.target.value)} style={{flex:1,minWidth:160,background:'#09122a',border:'1px solid var(--border)',borderRadius:12,color:'#fff',padding:'8px 10px'}} disabled={flashBusy}>
              <option value="">Select device</option>
              {flashDevices.map(d=>(<option key={d.device} value={d.device}>{(
                `${d.device} ${d.size||''} ${d.model||''}`
              ).trim()}</option>))}
            </select>
          </div>
          <input value={flashUrl} onChange={e=>setFlashUrl(e.target.value)} placeholder="Image URL (xz)" style={{marginTop:8,width:'100%',padding:'10px',borderRadius:12,border:'1px solid var(--border)',background:'#09122a',color:'#fff'}} disabled={flashBusy}/>
          <div style={{display:'flex',alignItems:'center',gap:8,marginTop:8}}>
            <button className="btn small" type="button" onClick={startFlash} disabled={flashBusy}>Flash</button>
            {flashBusy && <span className="chip">Flashing…</span>}
          </div>
          <pre ref={flashLogRef} style={{marginTop:10,background:'#000',color:'#0f0',padding:12,height:180,overflow:'auto',borderRadius:12,whiteSpace:'pre-wrap'}}>{flashLog || 'Ready.'}</pre>
          <div style={{display:'grid',gap:8}}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div style={{fontWeight:700}}>Flasher</div>
              <button className="btn small" onClick={()=>loadFlashDevices()} disabled={isFlashing}>List Devices</button>
            </div>
            <select value={flashDevice} onChange={e=>setFlashDevice(e.target.value)} disabled={!flashDevices.length} style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'#fff',padding:'8px'}}>
              <option value="">Select device…</option>
              {flashDevices.map(d=>{const meta=[d.size,d.model].filter(Boolean).join(' ');return <option key={d.device} value={d.device}>{meta?`${d.device} ${meta}`:d.device}</option>;})}
            </select>
            <input value={flashUrl} onChange={e=>setFlashUrl(e.target.value)} placeholder="Image URL (xz)" style={{background:'#09122a',border:'1px solid var(--border)',borderRadius:10,color:'#fff',padding:'8px'}}/>
            <div style={{display:'flex',gap:12,flexWrap:'wrap'}}>
              <label style={{display:'inline-flex',alignItems:'center',gap:6,cursor:'pointer'}}><input type="checkbox" checked={flashSafeHdmi} onChange={()=>setFlashSafeHdmi(v=>!v)}/> <span>Safe HDMI</span></label>
              <label style={{display:'inline-flex',alignItems:'center',gap:6,cursor:'pointer'}}><input type="checkbox" checked={flashEnableSsh} onChange={()=>setFlashEnableSsh(v=>!v)}/> <span>Enable SSH</span></label>
            </div>
            <button className={canFlash?'btn primary':'btn'} onClick={startFlash} disabled={!canFlash}>{isFlashing?'Flashing…':'Flash Drive'}</button>
            <div ref={flashLogRef} style={{background:'#000',color:'#0f0',padding:'10px',borderRadius:10,height:150,overflow:'auto',fontFamily:'monospace',whiteSpace:'pre-wrap'}}>{flashLog||'Ready.'}</div>
          </div>
        </Card>
      </Panel>
    </Body>
    <iframe id="sandbox" sandbox="allow-scripts" style={{display:'none'}}></iframe>
    <Modal open={!!modal} onClose={()=>setModal(null)} title={modal?.title||'Details'}>
      <div style={{display:'grid',gap:12}}>
        <div style={{color:'var(--muted)'}}>{modal?.desc}</div>
        {modal?.code && <pre style={{margin:0,padding:10,background:'#09122a',border:'1px solid var(--border)',borderRadius:10,overflow:'auto'}}><code dangerouslySetInnerHTML={{__html:highlightJS(modal.code)}}></code></pre>}
        <div style={{display:'flex',gap:8}}>{modal?.actions?.map(a=><button key={a} className="btn" onClick={()=>{ if(a==='Run') runCode(); setModal(null); }}>{a}</button>)}</div>
      </div>
    </Modal>
  </Shell>);
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body></html>
