<!-- ==== RUNTIME BADGE START (Block J) ==== -->
<style id="runtimeCheckStyles">
  #runtimeSelfCheck {
    position: fixed; right: 14px; top: 14px; z-index: 9999;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 12px; line-height: 1.3;
    background: #0f172a; color: #e2e8f0; padding: 8px 10px;
    border-radius: 10px; box-shadow: 0 6px 20px rgba(0,0,0,.25);
    opacity: .95; cursor: pointer;
  }
  #runtimeSelfCheck.ok     { border: 2px solid #22c55e; }
  #runtimeSelfCheck.warn   { border: 2px solid #f59e0b; }
  #runtimeSelfCheck.error  { border: 2px solid #ef4444; }
  #runtimeSelfCheck details { max-width: 320px; }
  #runtimeSelfCheck summary { outline: none; }
</style>
<div id="runtimeSelfCheck" class="warn">
  <details>
    <summary>Runtime checks…</summary>
    <div id="runtimeSelfCheckBody">running…</div>
  </details>
</div>

<script>
(function(){
  const el = document.getElementById('runtimeSelfCheck');
  const out = document.getElementById('runtimeSelfCheckBody');
  let fail = 0, warn = 0, logs = [];
  const log = (icon, msg) => logs.push(`${icon} ${msg}`);
  const setState = () => {
    el.classList.remove('ok','warn','error');
    el.classList.add(fail ? 'error' : (warn ? 'warn' : 'ok'));
    el.querySelector('summary').textContent = fail ? `Runtime: FAIL (${fail})` : (warn ? `Runtime: WARN` : 'Runtime: OK');
    out.innerHTML = logs.map(l => `<div>${l}</div>`).join('');
  };
  const approxEqual = (a,b,eps=1e-6) => Math.abs(a-b) <= eps;

  try {
    if (!window.Chart) { fail++; log('❌','Chart.js not found'); } else { log('✅','Chart.js present'); }
    if (!window.math)  { fail++; log('❌','math.js not found'); }  else { log('✅','math.js present'); }

    if (window.math && math.expm) {
      const H = math.matrix([[1,0.2,0],[0.2,0,-0.1],[0,-0.1,-0.8]]);
      const U  = math.expm(math.multiply(math.complex(0,-1), H));
      const Ud = math.ctranspose(U);
      const I  = math.identity(3);
      const UU = math.multiply(Ud, U);
      const diff = math.subtract(UU, I);
      const frob = Math.sqrt(math.sum(math.dotMultiply(diff, math.conj(diff))));
      if (frob > 1e-6) { warn++; log('⚠️',`Unitary borderline (||U†U−I||≈${frob.toExponential(2)})`); }
      else { log('✅','Unitary check passed'); }
    } else {
      warn++; log('⚠️','math.expm unavailable');
    }

    if (window.math) {
      const psi = math.divide(math.matrix([1,1,1]), Math.sqrt(3));
      const rho = math.multiply(math.reshape(psi,[3,1]), math.ctranspose(math.reshape(psi,[3,1])));
      const tr  = math.trace(rho);
      const pur = math.trace(math.multiply(rho, rho));
      if (Math.abs((tr.re ?? tr)-1) > 1e-8) { fail++; log('❌',`Tr(ρ)=${(tr.re ?? tr)} ≠ 1`); }
      else log('✅','Tr(ρ)=1');
      const pval = (pur.re ?? pur);
      if (pval < 1/3 - 1e-6 || pval > 1 + 1e-6) { fail++; log('❌',`Purity out of bounds: ${pval}`); }
      else log('✅',`Purity sane (${pval.toFixed(4)})`);
    }

    if (window.Chart) {
      const c = document.createElement('canvas'); c.width = 200; c.height = 80; c.style.display='none'; document.body.appendChild(c);
      let ok = true;
      try {
        const ctx = c.getContext('2d');
        const tmp = new Chart(ctx,{type:'line',data:{labels:[0,1],datasets:[{data:[0,1]}]},options:{animation:false}});
        tmp.destroy();
      } catch (e) { ok = false; console.error(e); }
      if (!ok) { fail++; log('❌','Chart.js failed to render'); } else { log('✅','Chart render ok'); }
      c.remove();
    }

    let rafHit = false;
    const p1 = new Promise(res => requestAnimationFrame(()=>{ rafHit=true; res(); }));
    const p2 = new Promise(res => setTimeout(res, 50));
    Promise.race([p1, p2]).then(()=>{
      if (!rafHit) { warn++; log('⚠️','requestAnimationFrame slow/blocked'); }
      else { log('✅','Animation tick ok'); }
      setState();
    });

    window.onerror = function(msg, src, line, col){
      fail++; log('❌',`JS error: ${String(msg)} (${src}:${line}:${col})`); setState();
    };
  } catch (e) {
    fail++; log('❌',`Self-check exception: ${e && e.message || e}`); setState();
  }

  el.addEventListener('click', () => {
    const det = el.querySelector('details');
    if (!det.open) det.open = true;
  });
  setState();
})();
</script>
<!-- ==== RUNTIME BADGE END ==== -->
