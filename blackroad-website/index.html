<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlackRoad.io — Live</title>
  <style>
    :root{--accent:#FF4FD8;--accent2:#0096FF;--accent3:#FDBA2D;--bg:#0b0b12;--fg:#eaeaf2;--muted:#a0a3ad}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Inter,sans-serif}
    header{padding:24px 16px;border-bottom:1px solid #1c1f2a;background:linear-gradient(180deg,rgba(255,79,216,.08),transparent)}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px}
    h1{margin:0 0 6px;font-size:28px}
    .pill{display:inline-block;padding:6px 10px;border:1px solid #272a38;border-radius:999px;color:var(--muted)}
    nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    a.btn{display:inline-block;text-decoration:none;border:1px solid #272a38;border-radius:14px;padding:10px 14px}
    a.primary{border-color:transparent;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b0b12;font-weight:700}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
    .card{border:1px solid #1e2230;border-radius:18px;padding:16px;background:#0e111b;box-shadow:0 0 0 1px rgba(255,255,255,.02) inset}
    .tag{font-size:12px;color:var(--muted)}
    footer{padding:24px 16px;border-top:1px solid #1c1f2a;color:var(--muted)}
    .ok{color:#5dffa7}.warn{color:#ffdd6b}.bad{color:#ff7d7d}
    code{background:#101425;border:1px solid #1d2235;border-radius:8px;padding:2px 6px}
  </style>
  <script>
  // If you later set this at build time, the widget will render automatically
  window.CLOUDFLARE_TURNSTILE_SITEKEY = ""; // optional, leave blank to disable
  </script>
  <script>
  if (window.CLOUDFLARE_TURNSTILE_SITEKEY) {
    const s = document.createElement('script');
    s.src = "https://challenges.cloudflare.com/turnstile/v0/api.js";
    s.async = true;
    document.head.appendChild(s);
  }
  </script>
  <script>
    function route(){
      const path = location.pathname.replace(/\/+$/,'') || '/';
      const view = document.getElementById('view');
      const routes = {
        '/': 'Welcome to BlackRoad.io — site is LIVE via GitHub Pages.',
        '/login': 'Login placeholder (static).',
        '/chat': 'Chat placeholder (local-only LLM to be wired later).',
        '/memories': 'Memories placeholder.',
        '/coding': 'Coding portal placeholder.',
        '/backend': 'Backend portal placeholder.',
        '/subscribe': 'Subscribe to updates.',
        '/unsubscribe': 'Unsubscribe from updates.',
        '/admin/subscribers': 'Admin — subscribers dashboard (HMAC required).'
      };
      view.textContent = routes[path] || '404 — routed to SPA root. Use header links.';
    }
    window.addEventListener('popstate', route);
    window.addEventListener('DOMContentLoaded', route);
    function go(p){history.pushState({},'',p);route();return false;}
    async function checkHealth(){
      try{
        const r=await fetch('/health.json',{cache:'no-store'});
        const j=await r.json();
        document.getElementById('health').innerHTML = `<span class="ok">●</span> HEALTH ok — ${new Date().toISOString()}`;
      }catch(e){
        document.getElementById('health').innerHTML = `<span class="warn">●</span> HEALTH file not found`;
      }
    }
    document.addEventListener('DOMContentLoaded',checkHealth);
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="pill">BLACKROAD • Pages Deployment</div>
      <h1>BlackRoad.io</h1>
      <nav>
        <a href="/" class="btn" onclick="return go('/')">Home</a>
        <a href="/login" class="btn" onclick="return go('/login')">Login</a>
        <a href="/chat" class="btn" onclick="return go('/chat')">Chat</a>
        <a href="/memories" class="btn" onclick="return go('/memories')">Memories</a>
        <a href="/coding" class="btn" onclick="return go('/coding')">Coding</a>
        <a href="/backend" class="btn" onclick="return go('/backend')">Backend</a>
        <a href="/subscribe" class="btn" onclick="return go('/subscribe')">Subscribe</a>
        <a href="/unsubscribe" class="btn" onclick="return go('/unsubscribe')">Unsubscribe</a>
        <a href="/admin/subscribers" class="btn" onclick="return go('/admin/subscribers')">Admin</a>
        <a href="health.json" class="btn">Health</a>
        <a href="https://github.com" target="_blank" class="btn primary">Open Repo</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <p id="health" class="tag">Checking health…</p>
    <div id="view" class="card" style="min-height:90px"></div>
    <section class="grid" style="margin-top:16px">
      <div class="card"><div class="tag">Status</div>
        Static deployment via GitHub Pages. No droplet required. DNS points to GitHub. SPA routing enabled.
      </div>
      <div class="card"><div class="tag">Next steps</div>
        Wire a real API behind <code>/api</code> later (Cloudflare Workers/Pages Functions or your Node API).
      </div>
      <div class="card"><div class="tag">Brand</div>
        Colors: <code>#FF4FD8</code>, <code>#0096FF</code>, <code>#FDBA2D</code>.
      </div>
    </section>

    <!-- Subscribe section -->
    <section id="subscribe-section" class="card" style="margin-top:16px">
      <div class="tag">Subscribe</div>
      <form id="subscribe-form" autocomplete="off" style="display:grid;gap:12px;max-width:520px">
        <label>Name
          <input id="sub-name" type="text" placeholder="Jane" style="width:100%;padding:10px;border-radius:10px;border:1px solid #272a38;background:#0b0f1b;color:#eaeaf2">
        </label>
        <label>Email
          <input id="sub-email" type="email" required placeholder="you@example.com" style="width:100%;padding:10px;border-radius:10px;border:1px solid #272a38;background:#0b0f1b;color:#eaeaf2">
        </label>
        <div style="display:none"><input id="sub-hp" type="text" tabindex="-1" autocomplete="off"></div>
        <button id="sub-btn" type="submit" style="justify-self:start;border:0;border-radius:14px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b0b12;font-weight:700">Subscribe</button>
        <div id="sub-msg" class="tag"></div>
      </form>
    </section>

    <!-- Unsubscribe section -->
    <section id="unsubscribe-section" class="card" style="margin-top:16px">
      <div class="tag">Unsubscribe</div>
      <form id="unsubscribe-form" autocomplete="email" style="display:grid;gap:12px;max-width:520px">
        <label>Email
          <input id="unsub-email" type="email" required placeholder="you@example.com" style="width:100%;padding:10px;border-radius:10px;border:1px solid #272a38;background:#0b0f1b;color:#eaeaf2">
        </label>
        <button id="unsub-btn" type="submit" style="justify-self:start;border:0;border-radius:14px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b0b12;font-weight:700">Unsubscribe</button>
        <div id="unsub-msg" class="tag"></div>
      </form>
    </section>

    <!-- Admin subscribers section -->
    <section id="admin-subscribers" class="card" style="margin-top:16px">
      <div class="tag">Admin — Subscribers</div>
      <div style="display:grid;gap:12px;max-width:720px">
        <label>Admin HMAC
          <input id="admin-hmac" type="password" placeholder="paste X-Admin-HMAC" style="width:100%;padding:10px;border-radius:10px;border:1px solid #272a38;background:#0b0f1b;color:#eaeaf2">
        </label>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button id="btn-stats" style="border:0;border-radius:14px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#0b0b12;font-weight:700">Fetch Stats</button>
          <button id="btn-export" style="border:1px solid #272a38;border-radius:14px;padding:10px 14px;background:#0e111b;color:#eaeaf2">Export CSV</button>
        </div>
        <pre id="admin-out" style="white-space:pre-wrap;word-break:break-word;background:#101425;border:1px solid #1d2235;border-radius:8px;padding:12px"></pre>
      </div>
    </section>

  </main>

  <footer><div class="wrap">© BlackRoad.io</div></footer>

  <script>
// Subscribe: attach Turnstile token if present
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('subscribe-form');
  if (form) {
    if (window.CLOUDFLARE_TURNSTILE_SITEKEY) {
      const div = document.createElement('div');
      div.className = "cf-turnstile";
      div.setAttribute('data-sitekey', window.CLOUDFLARE_TURNSTILE_SITEKEY);
      form.appendChild(div);
    }
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const tokenEl = document.querySelector('.cf-turnstile input[name="cf-turnstile-response"]');
      const tkn = tokenEl ? tokenEl.value : "";
      const email = document.getElementById('sub-email').value.trim();
      const name  = document.getElementById('sub-name').value.trim();
      const hp    = document.getElementById('sub-hp').value;
      const msgEl = document.getElementById('sub-msg');
      const btn   = document.getElementById('sub-btn');
      msgEl.textContent = '';
      if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { msgEl.textContent = 'Please enter a valid email.'; return; }
      if (hp) { msgEl.textContent = 'Spam detected.'; return; }
      btn.disabled = true;
      try {
        const r = await fetch('/api/subscribe', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ email, name, turnstile: tkn })
        });
        if (r.ok) { msgEl.textContent = 'Check your email to confirm your subscription.'; form.reset(); }
        else { msgEl.textContent = 'Failed to subscribe: ' + (await r.text()).slice(0,200); }
      } catch { msgEl.textContent = 'Network error. Try again in a minute.'; }
      finally { btn.disabled = false; }
    });
  }

  // Unsubscribe
  const uform = document.getElementById('unsubscribe-form');
  if (uform) {
    uform.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('unsub-email').value.trim();
      const msgEl = document.getElementById('unsub-msg');
      const btn   = document.getElementById('unsub-btn');
      msgEl.textContent = '';
      if (!email || !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) { msgEl.textContent = 'Please enter a valid email.'; return; }
      btn.disabled = true;
      try {
        const r = await fetch('/api/unsubscribe', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email }) });
        if (r.ok) { msgEl.textContent = 'If this email exists, a confirmation link has been sent.'; uform.reset(); }
        else { msgEl.textContent = 'Failed to start unsubscribe: ' + (await r.text()).slice(0,200); }
      } catch { msgEl.textContent = 'Network error. Try again.'; }
      finally { btn.disabled = false; }
    });
  }

  // Admin dashboard
  const btnStats = document.getElementById('btn-stats');
  const btnExport = document.getElementById('btn-export');
  const adminOut = document.getElementById('admin-out');
  function adminH() { return document.getElementById('admin-hmac')?.value || ''; }
  if (btnStats) {
    btnStats.addEventListener('click', async () => {
      adminOut.textContent = 'Loading…';
      const r = await fetch('/api/subscribe/stats', { headers: { 'X-Admin-HMAC': adminH() } });
      adminOut.textContent = r.ok ? JSON.stringify(await r.json(), null, 2) : (await r.text());
    });
  }
  if (btnExport) {
    btnExport.addEventListener('click', async () => {
      const r = await fetch('/api/subscribe/export', { headers: { 'X-Admin-HMAC': adminH() } });
      if (!r.ok) { adminOut.textContent = await r.text(); return; }
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'blackroad-subscribers.csv'; a.click();
      URL.revokeObjectURL(url);
      adminOut.textContent = 'CSV downloaded.';
    });
  }
});
  </script>
</body>
</html>
