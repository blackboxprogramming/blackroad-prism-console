<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlackRoad.io â€” Demo Scaffold</title>
  <meta name="color-scheme" content="dark" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%2318253a'/%3E%3Cpath d='M16 40C24 20 40 20 48 40' stroke='%23a78bfa' stroke-width='6' fill='none'/%3E%3C/svg%3E" />

  <!-- React + ReactDOM UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Styled Components UMD for CSS-in-JS -->
  <script crossorigin src="https://unpkg.com/styled-components/dist/styled-components.min.js"></script>
  <!-- Babel for in-browser JSX transform -->
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* Global resets + fonts */
    :root{
      --bg:#0b1220;             /* deep space */
      --panel:#0f172a;          /* slate-900 */
      --subpanel:#0b1324;       /* darker */
      --text:#e2e8f0;           /* slate-200 */
      --muted:#9aa4b2;          /* slate-400 */
      --border:#1f2a44;         /* slate-800 */
      --accent:#7c6cff;         /* indigo-400 */
      --accent-2:#00d0ff;       /* sky-300 */
      --accent-3:#ff4fd8;       /* fuchsia-400 */
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow:0 6px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    html, body, #root { height: 100%; }
    body{ margin:0; background: radial-gradient(1200px 900px at 80% -10%,rgba(124,108,255,.20),transparent 40%),
                              radial-gradient(1000px 800px at -20% 100%,rgba(0,208,255,.16),transparent 50%),
                              var(--bg);
          color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
          -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
    *{ box-sizing: border-box }
    /* minimal highlight styles for our custom syntax highlighter */
    .hl-key{ color:#93c5fd }
    .hl-str{ color:#f472b6 }
    .hl-num{ color:#f59e0b }
    .hl-com{ color:#64748b; font-style:italic }
    .hl-fn { color:#22d3ee }

    /* reusable utility classes */
    .tag{ display:inline-flex; gap:.5rem; align-items:center; padding:.2rem .6rem; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:.8rem }
    .dot{ width:.5rem; height:.5rem; border-radius:1rem; background:var(--muted) }
    .btn{ appearance:none; background:#121a30; border:1px solid var(--border); color:var(--text); padding:.55rem .9rem; border-radius:.75rem; cursor:pointer; box-shadow:var(--shadow); transition: all .2s ease; }
    .btn:hover{ transform: translateY(-1px); border-color:#29406c }
    .btn.primary{ background: linear-gradient(135deg, #7c6cff, #00d0ff); color:#0b1220; font-weight:700; }
    .btn.ghost{ background: transparent }
    .btn.small{ padding:.35rem .6rem; font-size:.85rem }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--border); padding:.2rem .5rem; border-radius:.6rem; font-size:.8rem; color:var(--muted) }

    /* gradient brand button (left nav) */
    .co-btn {
      background: conic-gradient(from 180deg at 50% 50%, #ff4fd8, #7c6cff, #00d0ff, #10b981, #ff4fd8);
      color:#0b1220; font-weight:800; border:none; border-radius:20px; padding:1.05rem 1.2rem; box-shadow: 0 10px 40px rgba(124,108,255,.35);
      transition: transform .2s ease, filter .2s ease; cursor:pointer; width:100%;
    }
    .co-btn:hover{ transform: translateY(-2px); filter: brightness(1.05) }

    /* simple scrollbar */
    ::-webkit-scrollbar{ width:10px; height:10px }
    ::-webkit-scrollbar-thumb{ background:#1b2744; border-radius:8px }
    ::-webkit-scrollbar-track{ background:transparent }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;
    const styled = window.styled;

    // THEME
    const theme = {
      colors: {
        bg: getComputedStyle(document.documentElement).getPropertyValue('--bg'),
        panel: getComputedStyle(document.documentElement).getPropertyValue('--panel'),
        subpanel: getComputedStyle(document.documentElement).getPropertyValue('--subpanel'),
        text: getComputedStyle(document.documentElement).getPropertyValue('--text'),
        muted: getComputedStyle(document.documentElement).getPropertyValue('--muted'),
        border: getComputedStyle(document.documentElement).getPropertyValue('--border'),
        accent: getComputedStyle(document.documentElement).getPropertyValue('--accent'),
        accent2: getComputedStyle(document.documentElement).getPropertyValue('--accent-2'),
        accent3: getComputedStyle(document.documentElement).getPropertyValue('--accent-3'),
        good: getComputedStyle(document.documentElement).getPropertyValue('--good'),
        warn: getComputedStyle(document.documentElement).getPropertyValue('--warn'),
        bad: getComputedStyle(document.documentElement).getPropertyValue('--bad'),
      },
      radius: '16px',
      shadow: 'var(--shadow)'
    };

    // LAYOUT
    const Shell = styled.div`
      display:flex; flex-direction:column; height:100%; width:100%;
    `;
    const Header = styled.header`
      display:flex; justify-content:space-between; align-items:center;
      padding: 14px 18px; border-bottom: 1px solid ${theme.colors.border};
      background: rgba(8, 14, 28, .6); backdrop-filter: blur(8px); position:sticky; top:0; z-index:50;
    `;
    const Brand = styled.div`
      display:flex; align-items:center; gap:.8rem; font-weight:800; letter-spacing:.3px; font-size:1.05rem;
      .logo{ width:28px; height:28px; border-radius:7px; background: conic-gradient(from 45deg, #ff4fd8, #7c6cff, #00d0ff, #ff4fd8); box-shadow:${theme.shadow}; }
    `;
    const NavTabs = styled.nav`
      display:flex; gap:.6rem; flex-wrap:wrap;
      .tab{ padding:.45rem .75rem; border-radius:10px; color:${theme.colors.muted}; border:1px solid transparent; cursor:pointer; transition:.2s; }
      .tab:hover{ color:${theme.colors.text}; border-color:${theme.colors.border}; background:#0e172a; }
      .tab.active{ color:#0b1220; background: linear-gradient(135deg, ${theme.colors.accent}, ${theme.colors.accent2}); font-weight:700 }
    `;
    const HeaderRight = styled.div`display:flex; align-items:center; gap:.6rem;`;

    const Body = styled.main`
      flex:1; display:grid; gap:14px; padding:14px; grid-template-columns: 260px 1fr 320px;
      @media (max-width: 1200px){ grid-template-columns: 230px 1fr 300px; }
      @media (max-width: 980px){ grid-template-columns: 1fr; }
    `;

    const Panel = styled.section`
      background: ${theme.colors.panel}; border:1px solid ${theme.colors.border}; border-radius:${theme.radius}; box-shadow:${theme.shadow};
      display:flex; flex-direction:column; min-height:120px; overflow:hidden;
    `;

    const ColumnScroll = styled.div`
      overflow:auto; height: calc(100vh - 110px);
    `;

    // SIDEBAR
    const SideHeader = styled.div`
      padding:16px 16px 10px 16px; border-bottom: 1px solid ${theme.colors.border}; display:flex; align-items:center; gap:.6rem; 
      font-size:.95rem; color:${theme.colors.muted}; text-transform:uppercase; letter-spacing:.12em;
    `;
    const SideList = styled.ul`
      list-style:none; margin:0; padding:6px; display:flex; flex-direction:column; gap:8px;
      li{ display:flex; align-items:center; gap:.6rem; padding:.6rem .7rem; border-radius:10px; cursor:pointer; color:${theme.colors.muted}; transition:.18s; }
      li:hover{ background:${theme.colors.subpanel}; color:${theme.colors.text}; }
      li.active{ color:${theme.colors.text}; background:#0e1a34; border:1px solid ${theme.colors.border}; }
    `;

    const FooterNote = styled.div`
      padding:14px; border-top:1px solid ${theme.colors.border}; color:${theme.colors.muted}; font-size:.85rem;
    `;

    // MAIN TABS
    const Tabs = styled.div`
      display:flex; gap:8px; padding:10px; border-bottom:1px solid ${theme.colors.border};
      button{ background:transparent; border:1px solid transparent; color:${theme.colors.muted}; padding:.45rem .75rem; border-radius:10px; cursor:pointer }
      button:hover{ border-color:${theme.colors.border}; color:${theme.colors.text} }
      button.active{ color:#0b1220; font-weight:700; background:linear-gradient(135deg, ${theme.colors.accent}, ${theme.colors.accent2}); }
    `;

    const ContentScroll = styled.div`
      padding: 10px; overflow:auto; height: calc(100% - 54px);
    `;

    // RIGHT SIDEBAR blocks
    const Card = styled.div`
      border-top:1px solid ${theme.colors.border}; padding:12px 14px; display:flex; flex-direction:column; gap:10px;
    `;

    const SwitchWrap = styled.label`
      display:inline-flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none;
      input{ position:absolute; opacity:0 }
      .switch{ width:44px; height:24px; background:#14203b; border:1px solid ${theme.colors.border}; border-radius:20px; position:relative; transition:.2s }
      .switch::after{ content:""; position:absolute; width:18px; height:18px; border-radius:50%; background:linear-gradient(135deg, ${theme.colors.accent}, ${theme.colors.accent2}); top:2px; left:2px; transition:.2s }
      input:checked + .switch{ background:#09122a }
      input:checked + .switch::after{ left:22px }
    `;

    // Simple sparkline canvas component
    function Sparkline({ data, color = theme.colors.accent2 }){
      const ref = useRef(null);
      useEffect(()=>{
        const cvs = ref.current; if(!cvs) return; const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * devicePixelRatio; const h = cvs.height = cvs.clientHeight * devicePixelRatio;
        ctx.clearRect(0,0,w,h);
        const min = Math.min(...data), max = Math.max(...data);
        const norm = v => h - ( (v - min) / (max - min || 1) ) * (h-6) - 3;
        ctx.lineWidth = 2 * devicePixelRatio; ctx.strokeStyle = color; ctx.beginPath();
        data.forEach((v,i)=>{ const x = (i/(data.length-1)) * (w-6) + 3; const y = norm(v); i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
        ctx.stroke();
      },[data,color]);
      return <div style={{width:'100%', height:36}}><canvas ref={ref} style={{width:'100%', height:'100%'}}/></div>
    }

    // Minimal JS syntax highlighter
    function highlightJS(src){
      // Escape HTML
      const esc = src.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      // comments
      let out = esc.replace(/(\/\*[\s\S]*?\*\/|\/\/.*$)/gm, '<span class="hl-com">$1<\/span>');
      // strings
      out = out.replace(/([`'\"])(?:(?!\1|\\).|\\.)*\1/gm, m=>`<span class="hl-str">${m}<\/span>`);
      // numbers
      out = out.replace(/\b(0x[\da-fA-F]+|\d+\.?\d*)\b/gm,'<span class="hl-num">$1<\/span>');
      // keywords
      out = out.replace(/\b(const|let|var|function|return|if|else|for|while|class|new|try|catch|throw|await|async|import|from|export|switch|case|break|continue)\b/gm,'<span class="hl-key">$1<\/span>');
      // function names (simple)
      out = out.replace(/(\b[A-Za-z_][A-Za-z0-9_]*) (?=\s*\()/g,'<span class="hl-fn">$1<\/span>');
      return out;
    }

    // CodeEditor overlay technique (textarea overlays highlighted pre)
    function CodeEditor({ value, onChange }){
      const [code, setCode] = useState(value);
      const onInput = (e)=>{ setCode(e.target.value); onChange && onChange(e.target.value); };
      useEffect(()=>{ setCode(value) },[value]);
      return (
        <div style={{position:'relative', height:220, border:'1px solid var(--border)', borderRadius:'12px', overflow:'hidden', background:'#0b1324'}}>
          <pre aria-hidden style={{margin:0, position:'absolute', inset:0, pointerEvents:'none', padding:'12px 14px', fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas', fontSize:13, lineHeight:1.6, color:'#c7d2fe', whiteSpace:'pre', overflow:'auto'}} dangerouslySetInnerHTML={{__html: highlightJS(code)}} />
          <textarea value={code} onChange={onInput} spellCheck={false}
            style={{position:'absolute', inset:0, resize:'none', padding:'12px 14px', fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas', fontSize:13, lineHeight:1.6, color:'transparent', caretColor:'#93c5fd', background:'transparent', border:'none', outline:'none'}} />
          <div style={{position:'absolute', right:10, bottom:10, display:'flex', gap:6}}>
            <button className="btn small" onClick={()=>navigator.clipboard.writeText(code)}>Copy</button>
            <button className="btn small" onClick={()=>downloadText('snippet.js', code)}>Download</button>
          </div>
        </div>
      );
    }

    // Terminal component
    function Terminal({ onCommand }){
      const [lines, setLines] = useState([`Lucidia shell â€” type 'help' to see commands.`]);
      const [input, setInput] = useState('');
      const scrollRef = useRef(null);
      useEffect(()=>{ scrollRef.current && (scrollRef.current.scrollTop = scrollRef.current.scrollHeight); },[lines]);
      const run = async (cmd)=>{
        const out = await onCommand(cmd);
        setLines(l => [...l, `> ${cmd}`, ...(Array.isArray(out)?out:[String(out)]) ]);
      }
      const onKey = (e)=>{ if(e.key==='Enter'){ e.preventDefault(); const cmd = input.trim(); if(cmd) run(cmd); setInput(''); }}
      return (
        <div style={{border:'1px solid var(--border)', borderRadius:'12px', background:'#0b1324', display:'flex', flexDirection:'column', height:260}}>
          <div ref={scrollRef} style={{flex:1, overflow:'auto', padding:'10px 12px', fontFamily:'ui-monospace, Menlo, Monaco, Consolas', fontSize:13}}>
            {lines.map((l,i)=> <div key={i} style={{color: l.startsWith('!')? 'var(--bad)': '#cbd5e1'}}>{l}</div>)}
          </div>
          <div style={{display:'flex', gap:8, padding:8, borderTop:'1px solid var(--border)'}}>
            <span className="tag"><span className="dot" style={{background:'var(--good)'}}></span> ready</span>
            <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={onKey} placeholder="Type a commandâ€¦"
              style={{flex:1, background:'#09122a', border:'1px solid var(--border)', borderRadius:10, color:'var(--text)', padding:'8px 10px'}} />
            <button className="btn" onClick={()=>{ const cmd = input.trim(); if(cmd){ run(cmd); setInput(''); }}}>Run</button>
          </div>
        </div>
      );
    }

    // Modal
    function Modal({ open, onClose, title, children }){
      if(!open) return null;
      return (
        <div style={{position:'fixed', inset:0, background:'rgba(0,0,0,.45)', display:'grid', placeItems:'center', zIndex:200}} onClick={onClose}>
          <div onClick={e=>e.stopPropagation()} style={{width:'min(720px, 94vw)', background:'var(--panel)', border:'1px solid var(--border)', borderRadius:'16px', boxShadow:'var(--shadow)'}}>
            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'14px 16px', borderBottom:'1px solid var(--border)'}}>
              <strong style={{fontSize:'1.05rem'}}>{title}</strong>
              <button className="btn small" onClick={onClose}>Close</button>
            </div>
            <div style={{padding:16}}>{children}</div>
          </div>
        </div>
      )
    }

    // Util: download
    function downloadText(filename, text){
      const blob = new Blob([text], {type:'text/plain'}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
    }

    // Activity item component
    function ActivityItem({ item, onOpen }){
      return (
        <div onClick={()=>onOpen(item)} style={{border:'1px solid var(--border)', background:'#0b1324', padding:'10px 12px', borderRadius:12, display:'flex', gap:10, alignItems:'flex-start', cursor:'pointer'}}>
          <div className="dot" style={{background:item.kind==='build'? 'var(--accent-2)': item.kind==='commit'? 'var(--good)': item.kind==='revert'? 'var(--bad)': 'var(--accent)'}}></div>
          <div style={{flex:1}}>
            <div style={{display:'flex', justifyContent:'space-between', gap:8}}>
              <div style={{fontWeight:700}}>{item.title}</div>
              <div className="chip">{item.time}</div>
            </div>
            <div style={{color:'var(--muted)', marginTop:4}}>{item.desc}</div>
            {item.code && (
              <pre style={{marginTop:8, padding:10, background:'#09122a', border:'1px solid var(--border)', borderRadius:10, overflow:'auto', maxHeight:140}}>
                <code dangerouslySetInnerHTML={{__html: highlightJS(item.code)}}></code>
              </pre>
            )}
            <div style={{display:'flex', gap:8, marginTop:8}}>
              {item.actions?.map(a => <button key={a} className="btn small" onClick={(e)=>{e.stopPropagation(); item.onAction && item.onAction(a)}}>{a}</button>)}
            </div>
          </div>
        </div>
      )
    }

    // LOGIN SCREEN
    function Login({ onLogin }){
      const [u,setU] = useState('');
      const [p,setP] = useState('');
      const [err,setErr] = useState('');
      const tryLogin = ()=>{
        if(u==='root' && p==='Codex2025'){ localStorage.setItem('blackroad_auth','1'); onLogin(); }
        else { setErr('Invalid credentials. Try root / Codex2025.'); }
      }
      useEffect(()=>{ const key=(e)=>{ if(e.key==='Enter') tryLogin(); }; window.addEventListener('keydown',key); return ()=>window.removeEventListener('keydown',key) },[u,p]);
      return (
        <div style={{minHeight:'100vh', display:'grid', placeItems:'center', padding:20}}>
          <div style={{width:'min(420px, 96vw)', background:'var(--panel)', border:'1px solid var(--border)', borderRadius:20, boxShadow:theme.shadow}}>
            <div style={{padding:22, display:'flex', alignItems:'center', gap:12}}>
              <div className="logo" style={{width:34,height:34,borderRadius:10}}></div>
              <div style={{fontWeight:800, fontSize:'1.1rem'}}>BlackRoad.io â€” Login</div>
            </div>
            <div style={{padding:22, paddingTop:0, display:'flex', flexDirection:'column', gap:12}}>
              <label style={{fontSize:13, color:'var(--muted)'}}>Username</label>
              <input value={u} onChange={e=>setU(e.target.value)} placeholder="root" style={{background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:'12px 14px'}} />
              <label style={{fontSize:13, color:'var(--muted)'}}>Password</label>
              <input type="password" value={p} onChange={e=>setP(e.target.value)} placeholder="Codex2025" style={{background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:'12px 14px'}} />
              {err && <div style={{color:'var(--bad)'}}>{err}</div>}
              <button className="btn primary" style={{marginTop:6}} onClick={tryLogin}>Enter Platform</button>
              <div style={{color:'var(--muted)', fontSize:12}}>Hint: root / Codex2025</div>
            </div>
          </div>
        </div>
      )
    }

    // MAIN DASHBOARD APP
    function Dashboard(){
      const [activeNav, setActiveNav] = useState('Workspace');
      const [activeTab, setActiveTab] = useState('Timeline');
      const [streamOn, setStreamOn] = useState(true);
      const [agents, setAgents] = useState({Phi:true, GPT:true, Mistral:true});
      const [wallet, setWallet] = useState(1.20);
      const [notes, setNotes] = useState('');
      const [filter, setFilter] = useState('');
      const [modal, setModal] = useState(null);

      // Chat state (Lucidia)
      const [chatOpen, setChatOpen] = useState(false);
      const [chatMsgs, setChatMsgs] = useState([
        { role: 'system', content: 'You are Lucidia â€” concise, helpful, respectful. Keep answers short unless asked.' }
      ]);
      const [chatInput, setChatInput] = useState('');
      const [chatLoading, setChatLoading] = useState(false);
      const [chatSpeak, setChatSpeak] = useState(false);

      // Metrics
      const [cpu,setCPU] = useState(Array.from({length:40},()=>Math.random()*50+10));
      const [mem,setMEM] = useState(Array.from({length:40},()=>Math.random()*70+20));
      const [gpu,setGPU] = useState(Array.from({length:40},()=>Math.random()*90));

      const pushRand = (arr,setter,max=100)=>{
        setter(prev=>{ const n = [...prev.slice(1), Math.min(max, Math.max(0, prev[prev.length-1] + (Math.random()*16-8)))]; return n; });
      }

      // Build progress + activity feed
      const [build, setBuild] = useState(63);
      const [timeline, setTimeline] = useState(()=>[
        {id:1, kind:'branch', title:'Phi agent created a branch `main`', time:'Today 13:41', desc:'Auto-created branch and prepared environment.', actions:['Run','Revert','Mint'], code:'// generated by GPT agent\nconsole.log("Hello from BlackRoad");'},
        {id:2, kind:'revert', title:'Mistral agent reverted commit d1f6e52', time:'Today 10:29', desc:'Manual rollback required after failed checks.', actions:['Details']},
        {id:3, kind:'commit', title:'User committed changes', time:'Day', desc:'Added a simple print statement.', code:'print("Hello, world!")'},
        {id:4, kind:'build', title:'Build', time:'Today', desc:'Build pipeline runningâ€¦', actions:['Open Logs']}
      ]);

      const [commits, setCommits] = useState([{id:'d1f6e52', msg:'Revert incorrect import', time:'Today 10:29'}, {id:'c9a110', msg:'Add hello world', time:'Yesterday 17:04'}]);
      const [tasks, setTasks] = useState([{id:'t1', title:'Wire GPUs to agents', status:'In Progress'}, {id:'t2', title:'Policy/secret scan checks', status:'Queued'}]);

      // auto updates
      useEffect(()=>{
        const t = setInterval(()=>{ pushRand(cpu,setCPU); pushRand(mem,setMEM); pushRand(gpu,setGPU);
          // occasionally push an event
          if(Math.random() < .22){
            const id = Date.now();
            const kinds = ['build','commit','agent','revert'];
            const kind = kinds[Math.floor(Math.random()*kinds.length)];
            const title = kind==='build'? 'Build step finished' : kind==='commit'? 'Agent committed fix' : kind==='revert'? 'Revert triggered' : 'Agent action';
            const ev = { id, kind, title, time: new Date().toLocaleTimeString(), desc: kind==='commit'? 'Updated dependency constraints.' : kind==='build'? 'Telemetry OK.' : 'Status event', actions:['Details'] };
            setTimeline(t => [ev, ...t].slice(0,80));
          }
          // wallet jitter
          setWallet(w => Math.max(0, (w + (Math.random()-.5)*0.01)).toFixed(2));
          // build progress subtle drift
          setBuild(b => Math.min(100, Math.max(0, b + (Math.random()-.45)*2)));
        }, 1200);
        return ()=>clearInterval(t);
      },[]);

      // Editor state
      const [code, setCode] = useState(`// Example: GPU telemetry mock\nasync function fetchGPU(){\n  return { util: Math.floor(Math.random()*100), vram: 24 };\n}\n\nfetchGPU().then(x=>console.log('GPU', x));`);

      // Sandbox runner
      const runCode = ()=>{
        const frame = document.getElementById('sandbox');
        const payload = `<!doctype html><html><body><script>\nconst log=(...a)=>parent.postMessage({type:'log', data:a.join(' ')}, '*');\nconsole.log=log;\nconsole.error=(...a)=>parent.postMessage({type:'log', data:'! '+a.join(' ')}, '*');\ntry{${code}\n}catch(e){console.error(e.message)}\n<\/script></body></html>`;
        frame.srcdoc = payload;
      }

      // Terminal command handler
      const onCommand = async (cmd)=>{
        const [c,...rest] = cmd.split(/\s+/);
        switch(c){
          case 'help': return [
            'commands: help, run, build, commit <msg>, git status, agents, stake <amt>, mint, revert, clear, whoami, logout']
          case 'run': runCode(); return ['executing current editor codeâ€¦'];
          case 'build': setBuild(0); setTimeout(()=>setBuild(100), 5000); return ['build started (5s)â€¦'];
          case 'commit': {
            const msg = rest.join(' ') || 'Update from terminal';
            const id = Math.random().toString(16).slice(2,8);
            setCommits(c=>[{id, msg, time:new Date().toLocaleTimeString()}, ...c]);
            setTimeline(t=>[{id: Date.now(), kind:'commit', title:`Commit ${id}`, time:'now', desc: msg}, ...t]);
            return [`committed ${id}: ${msg}`];
          }
          case 'git': if(rest[0]==='status') return ['on branch main','nothing to commit, working tree clean']; break;
          case 'agents': return [`Phi:${agents.Phi?'on':'off'} GPT:${agents.GPT?'on':'off'} Mistral:${agents.Mistral?'on':'off'}`];
          case 'stake': {
            const amt = parseFloat(rest[0]||'0'); if(!amt) return ['usage: stake <amount>']; setWallet(w=> (parseFloat(w)+amt).toFixed(2)); return [`staked ${amt.toFixed(2)} RC`];
          }
          case 'mint': setWallet(w=> (parseFloat(w)+0.05).toFixed(2)); return ['minted 0.05 RC'];
          case 'revert': setTimeline(t=>[{id:Date.now(), kind:'revert', title:'Manual revert', time:'now', desc:'User triggered revert'}, ...t]); return ['revert queued'];
          case 'clear': return ['\u0007'];
          case 'whoami': return ['root'];
          case 'logout': localStorage.removeItem('blackroad_auth'); location.reload();
        }
        return [`unknown command: ${cmd}. type 'help'.`]
      }

      useEffect(()=>{
        const receive = (e)=>{ if(e.data?.type==='log'){ const msg = e.data.data; const el = document.querySelector('#terminal-log'); if(el){ const d=document.createElement('div'); d.textContent=msg; el.appendChild(d); el.parentElement.scrollTop=el.parentElement.scrollHeight; }}}
        window.addEventListener('message', receive); return ()=>window.removeEventListener('message', receive);
      },[]);

      // Filter timeline
      const filteredTimeline = useMemo(()=> timeline.filter(x=> x.title.toLowerCase().includes(filter.toLowerCase()) || x.desc?.toLowerCase().includes(filter.toLowerCase())),[timeline,filter]);

      // Actions on activity items
      const itemAction = (label)=>{
        if(label==='Run') runCode();
        if(label==='Revert') setTimeline(t=>[{id:Date.now(), kind:'revert', title:'Manual revert', time:'now', desc:'User clicked revert'}, ...t]);
        if(label==='Mint') setWallet(w=> (parseFloat(w)+0.05).toFixed(2));
      }
      // --- Lucidia chat helpers ---
      async function sendChat(){
        const prompt = chatInput.trim(); if(!prompt) return;
        const newMsgs = [...chatMsgs, { role:'user', content: prompt }];
        setChatMsgs(newMsgs); setChatInput(''); setChatLoading(true);
        try{
          const r = await fetch('/llm/v1/chat/completions', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
              model: 'lucidia-local',
              messages: newMsgs.map(m=>({role:m.role, content:m.content})),
              stream: false
            })
          });
          const data = await r.json();
          const text = (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content)
                       ? data.choices[0].message.content.trim()
                       : (data.text || JSON.stringify(data));
          const bot = { role:'assistant', content: text };
          setChatMsgs(m=>[...newMsgs, bot]);
          if(chatSpeak && 'speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(text); u.rate=1.0; window.speechSynthesis.speak(u); }
        }catch(e){
          setChatMsgs(m=>[...newMsgs, { role:'assistant', content: `[LLM offline] ${e.message}` }]);
        }finally{ setChatLoading(false); }
      }

      function clearChat(){ setChatMsgs(m=> m.slice(0,1)); }

      function onChatKey(e){ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); } }

      return (
        <Shell>
          <Header>
            <Brand>
              <div className="logo"></div>
              <div>BlackRoad.io</div>
            </Brand>
            <NavTabs>
              {['Chat','Canvas','Editor','Terminal','RoadView','BackRoad'].map(tab => (
                <div key={tab} className={"tab "+(tab==='Chat'?'active':'')} >{tab}</div>
              ))}
            </NavTabs>
            <HeaderRight>
              <div className="chip"><span className="dot" style={{background:agents.Phi?'var(--good)':'var(--bad)'}}></span>Phi</div>
              <div className="chip"><span className="dot" style={{background:agents.GPT?'var(--good)':'var(--bad)'}}></span>GPT</div>
              <div className="chip"><span className="dot" style={{background:agents.Mistral?'var(--good)':'var(--bad)'}}></span>Mistral</div>
              <div className="chip">root</div>
              <button className="btn" onClick={()=>setChatOpen(true)}>Ask Lucidia</button>
              <button className="btn" onClick={()=>{localStorage.removeItem('blackroad_auth'); location.reload();}}>Logout</button>
            </HeaderRight>
          </Header>

          <Body>
            {/* LEFT SIDEBAR */}
            <Panel>
              <SideHeader>Workspace</SideHeader>
              <ColumnScroll>
                <div style={{padding:10}}>
                  <button className="co-btn" onClick={()=>setActiveTab('Editor')}>Start Co-Coding</button>
                </div>
                <SideList>
                  {['Workspace','Projects','Agents','Datasets','Models','Integrations'].map(s => (
                    <li key={s} className={activeNav===s?'active':''} onClick={()=>setActiveNav(s)}>
                      <span className="dot" style={{background:'#27324e'}}></span>{s}
                    </li>
                  ))}
                </SideList>
                <FooterNote>
                  <div style={{display:'grid', gap:8}}>
                    <div style={{display:'flex', align-items:'center', gap:8}}>
                      <input value={filter} onChange={e=>setFilter(e.target.value)} placeholder="Search timelineâ€¦" style={{flex:1, background:'#09122a', border:'1px solid var(--border)', borderRadius:10, color:'var(--text)', padding:'8px 10px'}} />
                    </div>
                    <div style={{color:'var(--muted)'}}>Drag & drop a .js file onto the editor to load it.</div>
                  </div>
                </FooterNote>
              </ColumnScroll>
            </Panel>

            {/* CENTER MAIN */}
            <Panel>
              <Tabs>
                {['Timeline','Tasks','Commits'].map(t => <button key={t} className={activeTab===t?'active':''} onClick={()=>setActiveTab(t)}>{t}</button>)}
              </Tabs>
              <ContentScroll>
                {activeTab==='Timeline' && (
                  <div style={{display:'grid', gap:10}}>
                    {filteredTimeline.map(item => <ActivityItem key={item.id} item={{...item, onAction:itemAction}} onOpen={setModal} />)}
                  </div>
                )}
                {activeTab==='Tasks' && (
                  <div style={{display:'grid', gap:10}}>
                    {tasks.map(t => (
                      <div key={t.id} style={{border:'1px solid var(--border)', padding:12, borderRadius:12, background:'#0b1324', display:'flex', justifyContent:'space-between'}}>
                        <div>{t.title}</div>
                        <div className="chip">{t.status}</div>
                      </div>
                    ))}
                  </div>
                )}
                {activeTab==='Commits' && (
                  <div style={{display:'grid', gap:10}}>
                    {commits.map(c => (
                      <div key={c.id} style={{border:'1px solid var(--border)', padding:12, borderRadius:12, background:'#0b1324', display:'flex', justifyContent:'space-between'}}>
                        <div><strong>{c.id}</strong> â€” {c.msg}</div>
                        <div className="chip">{c.time}</div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Editor + Terminal always present below */}
                <div style={{marginTop:12, display:'grid', gap:10}}>
                  <div style={{display:'flex', align-items:'center', justifyContent:'space-between'}}>
                    <div style={{fontWeight:700}}>Editor</div>
                    <div style={{display:'flex', gap:8}}>
                      <button className="btn small" onClick={runCode}>Run</button>
                      <button className="btn small" onClick={()=>setTimeline(t=>[{id:Date.now(), kind:'commit', title:'User applied patch', time:'now', desc:'Patch applied from editor'}, ...t])}>Commit</button>
                    </div>
                  </div>
                  <div id="editor-drop" onDragOver={(e)=>{e.preventDefault();}} onDrop={(e)=>{
                    e.preventDefault(); const f = e.dataTransfer.files?.[0]; if(!f) return; const r = new FileReader(); r.onload = ()=> setCode(String(r.result)); r.readAsText(f);
                  }}>
                    <CodeEditor value={code} onChange={setCode} />
                  </div>

                  <div style={{display:'grid', gridTemplateColumns:'1fr', gap:10}}>
                    <div style={{fontWeight:700}}>Terminal</div>
                    <Terminal onCommand={onCommand} />
                    <div style={{display:'none'}} id="terminal-log"></div>
                  </div>
                </div>
              </ContentScroll>
            </Panel>

            {/* RIGHT SIDEBAR */}
            <Panel>
              <SideHeader>Agent Stack</SideHeader>
              <Card>
                <div style={{display:'flex', gap:8}}>
                  {Object.keys(agents).map(k => (
                    <label key={k} className="chip" style={{cursor:'pointer'}}>
                      <input type="checkbox" checked={agents[k]} onChange={()=>setAgents(a=>({...a,[k]:!a[k]}))} /> {k}
                    </label>
                  ))}
                </div>
                <div>
                  <SwitchWrap>
                    <input type="checkbox" checked={streamOn} onChange={()=>setStreamOn(s=>!s)} />
                    <span className="switch"></span>
                    <span>Stream</span>
                  </SwitchWrap>
                </div>
              </Card>
              <Card>
                <div style={{display:'grid', gap:8}}>
                  <div style={{display:'flex', justifyContent:'space-between'}}><span>CPU</span><span>{Math.round(cpu.at(-1))}%</span></div>
                  <Sparkline data={cpu} color={theme.colors.accent2} />
                  <div style={{display:'flex', justifyContent:'space-between'}}><span>Memory</span><span>{Math.round(mem.at(-1))}%</span></div>
                  <Sparkline data={mem} color={theme.colors.accent} />
                  <div style={{display:'flex', justifyContent:'space-between'}}><span>GPU</span><span>{Math.round(gpu.at(-1))}%</span></div>
                  <Sparkline data={gpu} color={theme.colors.accent3} />
                </div>
              </Card>

              <Card>
                <div style={{display:'flex', justifyContent:'space-between', align-items:'center'}}>
                  <div>
                    <div style={{fontWeight:700}}>Wallet</div>
                    <div className="chip">{wallet} RC</div>
                  </div>
                  <div style={{display:'flex', gap:8}}>
                    <button className="btn small" onClick={()=>setWallet(w=> (parseFloat(w)+0.1).toFixed(2))}>Stake</button>
                    <button className="btn small" onClick={()=>setWallet(w=> (Math.max(0, parseFloat(w)-0.1)).toFixed(2))}>Unstake</button>
                  </div>
                </div>
              </Card>

              <Card>
                <div style={{fontWeight:700}}>Build</div>
                <div style={{height:10, background:'#0b1324', border:'1px solid var(--border)', borderRadius:10, overflow:'hidden'}}>
                  <div style={{height:'100%', width: build+'%', background: 'linear-gradient(90deg, var(--accent), var(--accent-2))', transition:'width .6s ease'}}></div>
                </div>
                <div style={{textAlign:'right', color:'var(--muted)'}}>{Math.round(build)}%</div>
              </Card>

              <Card>
                <div style={{fontWeight:700}}>Contradictions</div>
                <div className="chip"><strong>2</strong> Issues</div>
              </Card>

              <Card>
                <div style={{fontWeight:700}}>Session Notes</div>
                <textarea value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Type notesâ€¦" style={{minHeight:120, background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:'10px'}}></textarea>
              </Card>
            </Panel>
          </Body>

          <iframe id="sandbox" sandbox="allow-scripts" style={{display:'none'}}></iframe>

          <Modal open={!!modal} onClose={()=>setModal(null)} title={modal?.title||'Details'}>
            <div style={{display:'grid', gap:12}}>
              <div style={{color:'var(--muted)'}}>{modal?.desc}</div>
              {modal?.code && <pre style={{margin:0, padding:10, background:'#09122a', border:'1px solid var(--border)', borderRadius:10, overflow:'auto'}}><code dangerouslySetInnerHTML={{__html: highlightJS(modal.code)}}></code></pre>}
              <div style={{display:'flex', gap:8}}>
                {modal?.actions?.map(a => <button key={a} className="btn" onClick={()=>{ itemAction(a); setModal(null); }}>{a}</button>)}
              </div>
            </div>
          </Modal>

          {/* Lucidia Chat Modal */}
          <Modal open={chatOpen} onClose={()=>setChatOpen(false)} title="Lucidia Chat">
            <div style={{display:'grid', gap:12}}>
              <div style={{display:'flex', align-items:'center', gap:10}}>
                <label className="chip" style={{cursor:'pointer'}}>
                  <input type="checkbox" checked={chatSpeak} onChange={()=>setChatSpeak(s=>!s)} /> Speak replies
                </label>
                <button className="btn small" onClick={clearChat}>Clear</button>
              </div>
              <div style={{maxHeight:300, overflow:'auto', border:'1px solid var(--border)', borderRadius:12, padding:10, background:'#0b1324'}}>
                {chatMsgs.map((m,i)=> (
                  <div key={i} style={{marginBottom:10}}>
                    <div className="chip" style={{marginBottom:6}}>{m.role}</div>
                    <div style={{whiteSpace:'pre-wrap', color: m.role==='assistant'?'#e2e8f0':'#cbd5e1'}}>{m.content}</div>
                  </div>
                ))}
              </div>
              <textarea value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={onChatKey}
                        placeholder="Ask anythingâ€¦" style={{minHeight:80, background:'#09122a', border:'1px solid var(--border)', borderRadius:12, color:'var(--text)', padding:10}} />
              <div style={{display:'flex', gap:8, justifyContent:'flex-end'}}>
                <button className="btn" onClick={sendChat} disabled={chatLoading}>{chatLoading? 'Thinkingâ€¦' : 'Send'}</button>
              </div>
            </div>
          </Modal>

        </Shell>
      );
    }

    function App(){
      const [authed, setAuthed] = useState(!!localStorage.getItem('blackroad_auth'));
      return authed? <Dashboard/> : <Login onLogin={()=>setAuthed(true)} />
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
