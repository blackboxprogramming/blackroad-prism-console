<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>BlackRoad Deploys</title>
<style>
:root { --accent:#FF4FD8; --accent-2:#0096FF; --accent-3:#FDBA2D; font-family:sans-serif; }
body { margin:0; padding:1rem; background:#f5f5f5; }
header { font-size:1.5rem; margin-bottom:1rem; }
button { background:var(--accent); color:#fff; border:none; padding:0.5rem 1rem; margin:0.25rem; cursor:pointer; }
#log { background:#000; color:#0f0; padding:1rem; height:200px; overflow:auto; white-space:pre-wrap; }
</style>
</head>
<body>
<header>BlackRoad Deploys</header>
<div id="login">
  <input type="password" id="token" placeholder="Token" />
  <button onclick="login()">Login</button>
</div>
<div id="app" style="display:none;">
  <div id="health"></div>
  <div>
    <button onclick="dryRun()">Dry-Run Plan</button>
    <button onclick="deploy()">Deploy Now</button>
    <input id="rollbackId" placeholder="Release ID" />
    <button onclick="rollback()">Rollback</button>
  </div>
  <div style="margin:1rem 0;display:flex;gap:1rem;align-items:center;">
    <button id="refreshJobs">Refresh Jobs</button>
  </div>
  <table id="jobsTbl" style="width:100%;border-collapse:collapse;">
    <thead>
      <tr>
        <th>ID</th>
        <th>Command</th>
        <th>Status</th>
        <th>Started</th>
        <th>Ended</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <pre id="jobOut" style="margin-top:1rem;background:#000;color:#0f0;padding:1rem;height:200px;overflow:auto;"></pre>
  <form id="runForm" onsubmit="return false;" style="margin-top:1rem;">
    <input type="text" id="cmd" placeholder="Enter command (e.g. nvidia-smi)" style="width:280px;" />
    <button id="runBtn">Run (stream)</button>
    <button id="stopBtn" type="button">Stop</button>
  </form>
  <table id="jobs"></table>
  <pre id="log"></pre>
</div>
<script>
let token='';
let ws=null;
let currentJobId=null;
const cmdEl=document.getElementById('cmd');
const logEl=document.getElementById('log');
const runBtn=document.getElementById('runBtn');
const stopBtn=document.getElementById('stopBtn');

function append(line){ logEl.textContent+=line+'\n'; logEl.scrollTop=logEl.scrollHeight; }

async function login(){ token=document.getElementById('token').value; document.getElementById('login').style.display='none'; document.getElementById('app').style.display='block'; load(); }
async function load(){ const h=await fetch('/api/health').then(r=>r.json()); document.getElementById('health').innerText='API OK: '+h.ok; loadJobs(); }
async function dryRun(){ await fetch('/api/deploy/plan',{method:'POST',headers:{'X-Internal-Token':token}}).then(r=>r.json()).then(alert); }
async function deploy(){ await fetch('/api/deploy/execute',{method:'POST',headers:{'Content-Type':'application/json','X-Internal-Token':token},body:JSON.stringify({})}).then(r=>r.json()).then(()=>loadJobs()); }
async function rollback(){ const id=document.getElementById('rollbackId').value; await fetch('/api/rollback/'+id,{method:'POST',headers:{'X-Internal-Token':token}}).then(r=>r.json()).then(()=>loadJobs()); }

const jobsTbl = document.querySelector('#jobsTbl tbody');
const jobOut  = document.getElementById('jobOut');

function pill(status, exitCode){
  const color = status === 'ok' ? '#0f0' :
                status === 'failed' ? '#f55' :
                status === 'running' ? '#ff0' :
                '#aaa';
  const ec = (exitCode === null || exitCode === undefined) ? '' : ` (exit ${exitCode})`;
  return `<span style="background:${color};color:#000;padding:2px 6px;border-radius:12px;">${status}${ec}</span>`;
}

async function loadJobs(){
  const r = await fetch('/jobs'); const j = await r.json();
  jobsTbl.innerHTML = '';
  (j.jobs||[]).forEach(row=>{
    const tr = document.createElement('tr');
    const t = (ts)=> ts? new Date(ts*1000).toLocaleTimeString() : '-';
    tr.innerHTML = `
      <td>${row.id}</td>
      <td style="max-width:360px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${row.cmd}">${row.cmd}</td>
      <td>${pill(row.status, row.exit_code)}</td>
      <td>${t(row.started)}</td>
      <td>${t(row.ended)}</td>
      <td>
        <button data-id="${row.id}" class="open">Open</button>
        <a href="/jobs/${row.id}/download" target="_blank">Download</a>
      </td>`;
    tr.querySelector('button.open').onclick = async (ev)=>{
      const id = ev.target.dataset.id;
      const r = await fetch('/jobs/'+id); const j = await r.json();
      jobOut.textContent = j.output || JSON.stringify(j,null,2);
      jobOut.scrollTop = jobOut.scrollHeight;
    };
    jobsTbl.appendChild(tr);
  });
}
document.getElementById('refreshJobs').onclick = loadJobs;
document.addEventListener('DOMContentLoaded', loadJobs);

(function(){
  const origWS = window.WebSocket;
  window.WebSocket = function(url){
    const ws = new origWS(url);
    ws.addEventListener('message', (ev)=>{
      const m = String(ev.data||'');
      if(m.startsWith('[[BLACKROAD_JOB_ID:')) {
        loadJobs();
      } else if (m.startsWith('[[BLACKROAD_EXIT:')) {
        setTimeout(loadJobs, 500);
      }
    });
    return ws;
  };
})();
async function load(){ const h=await fetch('/api/health').then(r=>r.json()); document.getElementById('health').innerText='API OK: '+h.ok; refreshJobs(); }
async function refreshJobs(){ const tbl=document.getElementById('jobs'); try { const j=await fetch('/api/jobs').then(r=>r.json()); tbl.innerHTML='<tr><th>ID</th><th>Type</th><th>Status</th></tr>'; j.forEach(job=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${job.id}</td><td>${job.type}</td><td>${job.status}</td>`; tr.onclick=()=>watch(job.id); tbl.appendChild(tr); }); } catch(e){ tbl.innerHTML='<tr><td>jobs unavailable</td></tr>'; }}
function watch(id){ logEl.textContent=''; const es=new EventSource(`/api/jobs/${id}/log`); es.onmessage=e=>{logEl.textContent+=e.data+'\n'; logEl.scrollTop=logEl.scrollHeight;}; es.addEventListener('end',()=>es.close()); currentJobId=id; }
async function dryRun(){ await fetch('/api/deploy/plan',{method:'POST',headers:{'X-Internal-Token':token}}).then(r=>r.json()).then(alert); }
async function deploy(){ await fetch('/api/deploy/execute',{method:'POST',headers:{'Content-Type':'application/json','X-Internal-Token':token},body:JSON.stringify({})}).then(r=>r.json()).then(()=>refreshJobs()); }
async function rollback(){ const id=document.getElementById('rollbackId').value; await fetch('/api/rollback/'+id,{method:'POST',headers:{'X-Internal-Token':token}}).then(r=>r.json()).then(()=>refreshJobs()); }

runBtn.addEventListener('click',()=>{
  if(ws){ ws.close(); ws=null; }
  logEl.textContent='';
  currentJobId=null;
  const cmd=(cmdEl.value||'').trim()||'nvidia-smi';
  const proto=location.protocol==='https:'?'wss':'ws';
  ws=new WebSocket(`${proto}://${location.host}/ws/run`);
  ws.onopen=()=>ws.send(cmd);
  ws.onmessage=(ev)=>{
    const data=String(ev.data||'');
    if(data.startsWith('[[BLACKROAD_JOB_ID:')){
      const match=data.match(/\[\[BLACKROAD_JOB_ID:(\d+)\]\]/);
      if(match){ currentJobId=match[1]; append(`--- job ${currentJobId} ---`); }
    }else if(data.startsWith('[[BLACKROAD_PID:')){
      const match=data.match(/\[\[BLACKROAD_PID:(\d+)\]\]/);
      append(match?`pid: ${match[1]}`:data);
    }else if(data.startsWith('[[BLACKROAD_LOG:')){
      const match=data.match(/\[\[BLACKROAD_LOG:(.+)\]\]/);
      append(match?`log file: ${match[1]}`:data);
    }else if(data==='[[BLACKROAD_DONE]]'){
      append('--- done ---');
      ws.close();
      ws=null;
      refreshJobs();
    }else{
      append(data);
    }
  };
  ws.onerror=()=>append('[error]');
  ws.onclose=()=>{ ws=null; };
});

stopBtn.addEventListener('click',async()=>{
  if(!currentJobId){ append('[no job to stop]'); return; }
  await fetch(`/jobs/${currentJobId}/kill`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({signal:'TERM'})});
  append('--- sent SIGTERM ---');
  setTimeout(async()=>{
    await fetch(`/jobs/${currentJobId}/kill`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({signal:'KILL'})});
    append('--- sent SIGKILL ---');
  },5000);
});
</script>
</body>
</html>
