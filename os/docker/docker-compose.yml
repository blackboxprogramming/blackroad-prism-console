version: "3.9"
name: blackroad

x-common-env: &common_env
  TZ: ${TZ}
  REDIS_URL: ${REDIS_URL}

x-traefik-labels: &traefik_labels
  traefik.enable: "true"

services:
  reverse-proxy:
    image: traefik:v3.0
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      # Enable TLS later:
      # - --entrypoints.websecure.address=:443
    ports:
      - "80:80"
      # - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  blackroad-api:
    build:
      context: ../..
      dockerfile: ./os/docker/services/blackroad-api/Dockerfile
    env_file: .env
    environment:
      <<: *common_env
    labels:
      <<: *traefik_labels
      traefik.http.routers.blackroad-api.rule: PathPrefix(`/api`)
      traefik.http.services.blackroad-api.loadbalancer.server.port: "8000"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    restart: unless-stopped

  autopal:
    build:
      context: ../..
      dockerfile: ./os/docker/services/autopal/Dockerfile
    env_file: .env
    environment:
      <<: *common_env
      BR_API_KEY: ${BR_API_KEY}
    labels:
      <<: *traefik_labels
      traefik.http.routers.autopal.rule: PathPrefix(`/autopal`)
      traefik.http.services.autopal.loadbalancer.server.port: "8001"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8001/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    restart: unless-stopped

  aicodecloud:
    build:
      context: ../..
      dockerfile: ./os/docker/services/aicodecloud/Dockerfile
    env_file: .env
    environment:
      <<: *common_env
    labels:
      <<: *traefik_labels
      traefik.http.routers.aicodecloud.rule: PathPrefix(`/aicode`)
      traefik.http.services.aicodecloud.loadbalancer.server.port: "5000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:5000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    restart: unless-stopped

  pi-ops:
    build:
      context: ../..
      dockerfile: ./os/docker/services/pi-ops/Dockerfile
    env_file: .env
    environment:
      <<: *common_env
      MQTT_URL: ${MQTT_URL}
    depends_on:
      redis:
        condition: service_healthy
      mqtt:
        condition: service_started
    labels:
      <<: *traefik_labels
      traefik.http.routers.pi-ops.rule: PathPrefix(`/pi-ops`)
      traefik.http.services.pi-ops.loadbalancer.server.port: "7000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:7000/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    restart: unless-stopped

  var-www:
    build:
      context: ../..
      dockerfile: ./os/docker/services/var-www/Dockerfile
    env_file: .env
    environment:
      <<: *common_env
    labels:
      <<: *traefik_labels
      traefik.http.routers.var-www.rule: PathPrefix(`/`)
      traefik.http.services.var-www.loadbalancer.server.port: "9000"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:9000/health"]
      interval: 10s
      timeout: 3s
      retries: 12
    restart: unless-stopped

  discord-bot:
    build:
      context: ../..
      dockerfile: ./os/docker/services/discord-bot/Dockerfile
    env_file: .env
    environment:
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "/app/healthcheck.py"]
      interval: 20s
      timeout: 5s
      retries: 20
    restart: unless-stopped

  mqtt:
    image: eclipse-mosquitto:2
    ports:
      - "1883:1883"
    volumes:
      - mosq-data:/mosquitto/data
      - mosq-conf:/mosquitto/config
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  watchtower:
    image: containrrr/watchtower:1.7.1
    command:
      - "--cleanup"
      - "--interval"
      - "3600"
    environment:
      WATCHTOWER_SCHEDULE: "${WATCHTOWER_SCHEDULE}"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    profiles:
      - watchtower

volumes:
  mosq-data:
  mosq-conf:
